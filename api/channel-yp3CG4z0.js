import{__dirname as e,init_esm_shims as t}from"./esm-shims-CtP6w_ML.js";import{config as n}from"./config-DYqAlsU3.js";import"./logger-BlLSmUdl.js";import{ofetch_default as r}from"./ofetch-CDAeBYLA.js";import{cache_default as i}from"./cache-7MGQxbL-.js";import{art as a}from"./render-DlHIMz-Z.js";import{parseDate as o}from"./parse-date-B2cCVoGk.js";import"./invalid-parameter-0LlYSQjk.js";import{ViewType as s}from"./types-DygLf1a3.js";import{fallback as c,queryToBoolean as l}from"./readable-social-Dld9apEb.js";import{config_not_found_default as u}from"./config-not-found-DTjmIGAO.js";import d from"node:path";import{load as ee}from"cheerio";import te from"querystring";import{Api as f,TelegramClient as p}from"telegram";import{StringSession as m}from"telegram/sessions/index.js";import"telegram/Utils.js";import"telegram/Helpers.js";import{HTMLParser as h}from"telegram/extensions/html.js";let g;async function _(e,t){if(!n.telegram.session&&t===void 0)throw new u(`TELEGRAM_SESSION is not configured`);if(g)return g;let r=Number(n.telegram.apiId??4),i=n.telegram.apiHash??`014b35b6184100b085b0d0572f9b5103`,a=new m(t??n.telegram.session);return g=new p(a,r,i,{connectionRetries:1/0,autoReconnect:!0,retryDelay:3e3,maxConcurrentDownloads:Number(n.telegram.maxConcurrentDownloads??10),proxy:n.telegram.proxy?.host&&n.telegram.proxy.port&&n.telegram.proxy.secret?{ip:n.telegram.proxy.host,port:Number(n.telegram.proxy.port),MTProxy:!0,secret:n.telegram.proxy.secret}:void 0}),await g.connect(),g}function v(e){let t=e===0?0:Math.floor(Math.log(e)/Math.log(1024));return(e/1024**t).toFixed(2)*1+` `+[`B`,`kB`,`MB`,`GB`,`TB`][t]}function y(e,t,n,r){let i=`${e.protocol}://${e.host}/telegram/channel/${n}`,a=i+`${t.channelId}_${r.id}`,o=r.media;if(o instanceof f.MessageMediaPhoto||o instanceof f.MessageMediaDocument&&o.document.mimeType.startsWith(`image/`))return`<img src="${a}" alt=""/>`;if(o instanceof f.MessageMediaDocument&&o.document.mimeType.startsWith(`video/`)){let e=o.document.attributes.find(e=>e.className===`DocumentAttributeVideo`)??{w:1080,h:720};return`<video controls preload="metadata" poster="${a}?thumb" width="${e.w/2}" height="${e.h/2}"><source src="${a}" type="${o.document.mimeType}"></video>`}if(o instanceof f.MessageMediaDocument&&o.document.mimeType.startsWith(`audio/`))return`<audio src="${a}"></audio>`;let s=b(o);return o instanceof f.MessageMediaDocument?(s+=` (${v(o.document.size)})`,`<a href="${a}" target="_blank"><img src="${a}?thumb" alt=""/><br/>${s}</a>`):``}function b(e){if(e instanceof f.MessageMediaDocument){let t=e.document.attributes.find(e=>e.className===`DocumentAttributeFilename`);if(t)return t.fileName}return e.className}async function x(e){let{username:t}=e.req.param(),n=await _(),r=[],i=await n.getInputEntity(t),a=await n.getEntity(i);if(a.className!==`Channel`)throw Error(`${t} is not a channel`);let o=[],s=await n.getMessages(i,{limit:50});for(let n of s)if(n.media&&o.push(y(e,i,t,n)),n.text!==``){let e=o.join(`
`);o=[],n.text&&(e+=`<p>${h.unparse(n.message,n.entities).replaceAll(`
`,`<br/>`)}</p>`);let i=n.text?n.text.substring(0,80)+(n.text.length>80?`...`:``):new Date(n.date*1e3).toUTCString();r.push({title:i,description:e,pubDate:new Date(n.date*1e3).toUTCString(),link:`https://t.me/s/${t}/${n.id}`,author:`${a.title} (@${t})`})}return{title:a.title,language:null,link:`https://t.me/${t}`,item:r,allowEmpty:e.req.param(`id`)===`allow_empty`,description:`@${t} on Telegram`}}t();const S=`REPLY`,C=`FORWARDED`,ne=`SERVICE`,w=`VIA_BOT`,re=`VIDEO`,ie=`GIF`,ae=`PHOTO`,oe=`POLL`,T=`VOICE`,se=`MUSIC`,ce=`DOCUMENT`,E=`LOCATION`,le=`CONTACT`,ue=`STICKER`,de=`ANIMATED_STICKER`,fe=`VIDEO_STICKER`,D=`UNSUPPORTED`,pe=`PARTIALLY_UNSUPPORTED`,O={REPLY:[`[Reply]`,`â†©ï¸`],FORWARDED:[`[Forwarded]`,`ðŸ”`],SERVICE:[`[Service]`,`ðŸ”§`],VIA_BOT:[`[Via bot]`,`ðŸ¤–`],VIDEO:[`[Video]`,`ðŸŽ¬`],GIF:[`[GIF]`,`[GIF]`],PHOTO:[`[Photo]`,`ðŸ–¼`],POLL:[`[Poll]`,`ðŸ“Š`],VOICE:[`[Voice]`,`ðŸŽ™`],MUSIC:[`[Music]`,`ðŸŽµ`],DOCUMENT:[`[Document]`,`ðŸ“„`],LOCATION:[`[Location]`,`ðŸ“`],CONTACT:[`[Contact]`,`ðŸ“±`],STICKER:[`[Sticker]`,`[Sticker]`],ANIMATED_STICKER:[`[Animated Sticker]`,`[Animated Sticker]`],VIDEO_STICKER:[`[Video Sticker]`,`[Video Sticker]`],UNSUPPORTED:[`[Unsupported]`,`ðŸš«`],PARTIALLY_UNSUPPORTED:[``,``]},k={path:`/channel/:username/:routeParams?`,categories:[`social-media`,`popular`],view:s.SocialMedia,example:`/telegram/channel/awesomeRSSHub`,parameters:{username:`channel username`,routeParams:`extra parameters, see the table below
| Key                    | Description                                                           | Accepts                                            | Defaults to  |
| :--------------------: | :-------------------------------------------------------------------: | :------------------------------------------------: | :----------: |
| showLinkPreview        | Show the link preview from Telegram                                   | 0/1/true/false                                     | true         |
| showViaBot             | For messages sent via bot, show the bot                               | 0/1/true/false                                     | true         |
| showReplyTo            | For reply messages, show the target of the reply                      | 0/1/true/false                                     | true         |
| showFwdFrom            | For forwarded messages, show the forwarding source                    | 0/1/true/false                                     | true         |
| showFwdFromAuthor      | For forwarded messages, show the author of the forwarding source      | 0/1/true/false                                     | true         |
| showInlineButtons      | Show inline buttons                                                   | 0/1/true/false                                     | false        |
| showMediaTagInTitle    | Show media tags in the title                                          | 0/1/true/false                                     | true         |
| showMediaTagAsEmoji    | Show media tags as emoji                                              | 0/1/true/false                                     | true         |
| showHashtagAsHyperlink | Show hashtags as hyperlinks (\`https://t.me/s/channel?q=%23hashtag\`) | 0/1/true/false                                     | true         |
| includeFwd             | Include forwarded messages                                            | 0/1/true/false                                     | true         |
| includeReply           | Include reply messages                                                | 0/1/true/false                                     | true         |
| includeServiceMsg      | Include service messages (e.g. message pinned, channel photo updated) | 0/1/true/false                                     | true         |
| includeUnsupportedMsg  | Include messages unsupported by t.me                                  | 0/1/true/false                                     | false        |
| searchQuery            | search query                                                          | keywords; replace \`#hashtag\` with \`%23hashtag\` | (no keyword) |

Specify different option values than default values can meet different needs, URL

\`\`\`
https://rsshub.app/telegram/channel/NewlearnerChannel/showLinkPreview=0&showViaBot=0&showReplyTo=0&showFwdFrom=0&showFwdFromAuthor=0&showInlineButtons=0&showMediaTagInTitle=1&showMediaTagAsEmoji=1&includeFwd=0&includeReply=1&includeServiceMsg=0&includeUnsupportedMsg=0
\`\`\`

generates an RSS without any link previews and annoying metadata, with emoji media tags in the title, without forwarded messages (but with reply messages), and without messages you don't care about (service messages and unsupported messages), for people who prefer pure subscriptions.

For backward compatibility reasons, invalid \`routeParams\` will be treated as \`searchQuery\` .
`},features:{requireConfig:[{name:`TELEGRAM_SESSION`,optional:!0,description:`Telegram API Authentication`},{name:`TELEGRAM_API_ID`,optional:!0,description:`Telegram API ID`},{name:`TELEGRAM_API_HASH`,optional:!0,description:`Telegram API Hash`},{name:`TELEGRAM_MAX_CONCURRENT_DOWNLOADS`,optional:!0,description:`Telegram Max Concurrent Downloads`},{name:`TELEGRAM_PROXY_HOST`,optional:!0,description:`Telegram Proxy Host`},{name:`TELEGRAM_PROXY_PORT`,optional:!0,description:`Telegram Proxy Port`},{name:`TELEGRAM_PROXY_SECRET`,optional:!0,description:`Telegram Proxy Secret`}],requirePuppeteer:!1,antiCrawler:!1,supportBT:!1,supportPodcast:!1,supportScihub:!1},radar:[{source:[`t.me/s/:username`],target:`/channel/:username`}],name:`Channel`,maintainers:[`DIYgod`,`Rongronggg9`,`synchrone`,`pseudoyu`],handler:A,description:"\n::: tip\n  Due to Telegram restrictions, some channels involving pornography, copyright, and politics cannot be subscribed. You can confirm by visiting `https://t.me/s/:username`, it's recommended to deploy your own instance with telegram api configs (create your telegram application via `https://core.telegram.org/api/obtaining_api_id`, run this command `node ./lib/routes/telegram/scripts/get-telegram-session.mjs` to get `TELEGRAM_SESSION` and set it as Environment Variable).\n:::"};async function A(t){let s=t.req.param(`username`),u=t.req.param(`routeParams`),f=!0,p=!0,m=!0,h=!0,g=!0,_=!1,v=!0,y=!0,b=!0,k=!0,A=!0,j=!0,M=!1,N=u;u&&u.search(/(^|&)(show(LinkPreview|ViaBot|ReplyTo|FwdFrom(Author)?|InlineButtons|MediaTag(InTitle|AsEmoji)|HashtagAsHyperlink)|include(Fwd|Reply|(Service|Unsupported)Msg)|searchQuery)=/)!==-1&&(u=te.parse(t.req.param(`routeParams`)),f=!!c(void 0,l(u.showLinkPreview),f),p=!!c(void 0,l(u.showViaBot),p),m=!!c(void 0,l(u.showReplyTo),m),h=!!c(void 0,l(u.showFwdFrom),h),g=!!c(void 0,l(u.showFwdFromAuthor),g),_=!!c(void 0,l(u.showInlineButtons),_),v=!!c(void 0,l(u.showMediaTagInTitle),v),y=!!c(void 0,l(u.showMediaTagAsEmoji),y),b=!!c(void 0,l(u.showHashtagAsHyperlink),b),k=!!c(void 0,l(u.includeFwd),k),A=!!c(void 0,l(u.includeReply),A),j=!!c(void 0,l(u.includeServiceMsg),j),M=!!c(void 0,l(u.includeUnsupportedMsg),M),N=c(void 0,u.searchQuery,null));let P=N?`https://t.me/s/${s}?q=${encodeURIComponent(N)}`:`https://t.me/s/${s}`,F=await i.tryGet(P,async()=>{let e=await r(P);return e},n.cache.routeExpire,!1),I=ee(F);I(`a[onclick][href]`).each((e,t)=>{let n=I(t),r=n.attr(`href`);r&&n.attr(`href`,r.replaceAll(`&amp;`,`&`))}),!b&&I(`a[href^="?q=%23"]`).each((e,t)=>{let n=I(t);n.replaceWith(n.text())});let L=I(j?`.tgme_widget_message_wrap:not(.tgme_widget_message_wrap:has(.tme_no_messages_found))`:`.tgme_widget_message_wrap:not(.tgme_widget_message_wrap:has(.service_message,.tme_no_messages_found))`);if(L.length===0&&I(`.tgme_channel_history`).length===0){if(n.telegram.session)return x(t);throw Error(`Unable to fetch message feed from this channel. Please check this URL to see if you can view the message preview: ${P}`)}let R=I(`.tgme_channel_info_header_title`).text(),z=(N?`"${N}" - `:``)+R+` - Telegram Channel`;return{title:z,description:I(`.tgme_channel_info_description`).text(),link:P,allowEmpty:!0,itunes_author:R,image:I(`.tgme_page_photo_image > img`).attr(`src`),item:L&&L.map((t,n)=>{n=I(n);let r=null,i=[];if(n.find(`.service_message`).length&&i.push(ne),n.find(`.tgme_widget_message_video_player`).length&&i.push(n.find(`.message_video_play`).length?re:ie),n.find(`.tgme_widget_message_photo,.tgme_widget_message_service_photo`).length&&i.push(ae),n.find(`.tgme_widget_message_poll`).length&&i.push(oe),n.find(`.tgme_widget_message_voice`).length&&i.push(T),n.find(`.tgme_widget_message_document`).length&&i.push(n.find(`.audio`).length?se:ce),n.find(`.tgme_widget_message_location`).length&&i.push(E),n.find(`.tgme_widget_message_contact`).length&&i.push(le),n.find(`.tgme_widget_message_sticker`).length&&i.push(ue),n.find(`.tgme_widget_message_tgsticker`).length&&i.push(de),n.find(`.tgme_widget_message_videosticker`).length&&i.push(fe),n.find(`.message_media_not_supported`).length)if(n.find(`.media_supported_cont`).length)i.unshift(pe);else{if(i.length===0&&!M)return null;i.unshift(D)}if(n.find(`.tgme_widget_message_author .tgme_widget_message_via_bot,.tgme_widget_message_forwarded_from .tgme_widget_message_via_bot`).length&&i.unshift(w),n.find(`.tgme_widget_message_forwarded_from`).length&&(i.unshift(C),!k)||n.find(`.tgme_widget_message_reply`).length&&(i.unshift(S),!A))return null;n.find(`.emoji`).each((e,t)=>{t=I(t),t.replaceWith(`<span class="emoji">${t.text()}</span>`)});let s=()=>{let e=``,t=n.find(`.tgme_widget_message_forwarded_from_name`);if(t.length){let i=t.attr(`href`),a=i?`<a href="${i}">${t.text()}</a>`:t.text();e+=`<p>Forwarded From <b>${a}</b>`;let o=n.find(`.tgme_widget_message_forwarded_from_author`);o.length&&g&&(e+=` (${o.text()})`),e+=`</p>`,r={links:[{type:`repost`,url:i}]}}return e},c=()=>{let e=n.find(`.tgme_widget_message_reply`);if(e.length===0)return``;{let t=e.find(`.tgme_widget_message_author_name`),n=t.length?t.text():``,i=e.find(`.tgme_widget_message_via_bot`),a=i.length?` via <b>${i.text()}</b>`:``,o=e.attr(`href`),s=o.length?o:``,c=e.find(`.tgme_widget_message_metatext`),l=c.length?`<p><small>${c.html()}</small></p>`:``,u=e.find(`.tgme_widget_message_text`),d=u.length?`<p>${u.html()}</p>`:``;return r={links:[{type:`reply`,url:s}]},s===``?`<div class="rsshub-quote"><blockquote>
                                    <p><b>${n}</b>${a}:</p>
                                    ${l}
                                    ${d}
                                </blockquote></div>`:`<div class="rsshub-quote"><blockquote>
                                    <p><a href='${s}'><b>${n}</b>${a}:</a></p>
                                    ${l}
                                    ${d}
                                </blockquote></div>`}},l=()=>{let e=n.find(`.tgme_widget_message_author .tgme_widget_message_via_bot,.tgme_widget_message_forwarded_from .tgme_widget_message_via_bot`);if(e.length){let t=e.attr(`href`),n=t?`<a href="${t}">${e.text()}</a>`:e.text();return`<p>via <b>${n}</b></p>`}else return``},u=t=>{let r=n.find(t);if(!r.length)return``;let i=``,o=r.find(`picture`),s=r.find(`img`);return r.each((t,n)=>{let r=I(n),c=``;if(n.attribs&&n.attribs.class&&n.attribs.class.search(/(^|\s)tgme_widget_message_video_player(\s|$)/)!==-1){let t=r.find(`.tgme_widget_message_video`).attr(`src`),n=r.find(`.tgme_widget_message_video_thumb`).css(`background-image`),i=n&&n.match(/url\('(.*)'\)/),o=i&&i[1];c+=a(d.join(e,`templates/video-5b5d7a6e.art`),{source:t,poster:o})}else if(r.attr(`data-webp`))c+=`<img src="${r.attr(`data-webp`)}">`;else if(n.name===`picture`)c+=`<picture>`,r.find(`source,img`).each((e,t)=>{c+=I(t).toString()}),c+=`</picture>`;else if(n.attribs&&n.attribs.class&&n.attribs.class.search(/(^|\s)tgme_widget_message_videosticker(\s|$)/)!==-1){let t=r.find(`.js-videosticker_video`).attr(`src`);c+=a(d.join(e,`templates/video-5b5d7a6e.art`),{source:t})}else if(n.name===`img`)c+=r.toString();else if(o.length)o.each((e,t)=>{c+=`<picture>`,I(t).find(`source,img`).each((e,t)=>{c+=I(t).toString()}),c+=`</picture>`});else if(s.length)s.each((e,t)=>{c+=I(t).toString()});else{let e=r.css(`background-image`),t=e&&e.match(/url\('(.*)'\)/),n=t&&t[1],i=[`src="${n}"`],a=0,o=r.css(`width`);o&&o.endsWith(`px`)&&(a=Number.parseFloat(o));let s=0,l=r.css(`height`);l&&l.endsWith(`px`)&&(s=Number.parseFloat(l));let u=r.find(`.tgme_widget_message_photo`).css(`padding-top`);s<=0&&a>0&&u&&u.endsWith(`%`)&&(s=Number.parseFloat(u)/100*a),a>32&&i.push(`width="${a}"`),s>32&&i.push(`height="${s.toFixed(2).replace(`.00`,``)}"`),c+=n?`<img ${i.join(` `)}>`:``}c&&(i+=c,r.find(`.message_media_not_supported`).remove())}),i},ee=u(`.tgme_widget_message_photo_wrap,.tgme_widget_message_service_photo,.tgme_widget_message_sticker,.tgme_widget_message_tgsticker,.tgme_widget_message_videosticker,.tgme_widget_message_video_player`),te=()=>{let e=n.find(`.tgme_widget_message_location_wrap`);if(e.length){let t=e.attr(`href`),n=e.find(`.tgme_widget_message_location`).css(`background-image`),r=n&&n.match(/url\('(.*)'\)/),i=r&&r[1],a=i?`<img src="${i}">`:y?O[E][1]:O[E][0];return t?`<a href="${t}">${a}</a>`:a}else return``},b=n.find(`audio.tgme_widget_message_voice`),x=n.find(`.tgme_widget_message_voice_duration`),j=x.text(),N=b.length?b.attr(`src`):``,P=``,F=``;N&&(v&&(P=j?`(${j})`:``),F+=`<p><b>`,F+=y?O[T][1]:O[T][0],F+=j?` (${j})`:``,F+=`</b></p>`,F+=`<audio src="${N}"></audio>`);let L=()=>{if(x.length){let e=j.split(`:`),t=0,n=1;for(;e.length>0;)t+=n*Number.parseInt(e.pop(),10),n*=60;return t.toString()}else return``},R=()=>{let e=n.find(`.link_preview_site_name`),t=e.length?`<b>${e.text()}</b><br>`:``,r=n.find(`.link_preview_title`),i=r.length?`<b><a href="${n.find(`.tgme_widget_message_link_preview`).attr(`href`)}">${r.text()}</a></b><br>`:``,a=n.find(`.link_preview_description`),o=a.length?`<p>${a.html()}</p>`:``,s=u(`.link_preview_image`)+u(`.link_preview_right_image`);return t.length>0||i.length>0||o.length>0||s.length>0?`<blockquote>${t}${i}${o}${s}</blockquote>`:``},z=n.find(`.tgme_widget_message_poll_question`),B=z.length?z.text():``,me=()=>{let e=``,t=n.find(`.tgme_widget_message_poll_type`),r=t.length?t.text():``,i=n.find(`.tgme_widget_message_poll_option`);return B&&r.length>0&&i.length>0&&(e+=`<p><b>${B}</b></p>`,e+=`<p><small>${r}</small></p>`,i.each((t,n)=>{let r=I(n),i=r.find(`.tgme_widget_message_poll_option_percent`),a=i.length?i.text():``,o=r.find(`.tgme_widget_message_poll_option_text`),s=o.length?o.text():``;a&&s&&(e+=`<p><b>${a}</b> - ${s}</p>`)})),e?`<blockquote>${e}</blockquote>`:``},he=n.find(`.tgme_widget_message_document_wrap`),V=``,H=``;he.length&&he.each((e,t)=>{let n=I(t),r=n.find(`.tgme_widget_message_document_title`),i=n.find(`.tgme_widget_message_document_extra`),a=r.length?r.text():``,o=i.length?i.text():``,s=`${a}${a&&o?` - `:``}${o}`,c=(a?`<p><b>${a}</b></p>`:``)+(o?`<p><small>${o}</small></p>`:``);V+=V&&s?` | `:``,V+=s,H+=c?`<blockquote>${c}</blockquote>`:``;let l=n.next(`.tgme_widget_message_text`);if(l.length){let e=l.html();e.length&&(H+=`<p>${e}</p>`),l.each((e,t)=>{I(t).remove()})}});let ge=n.find(`.tgme_widget_message_contact_name`),U=ge.length?ge.text():``,_e=U?`<b>${U}</b>`:``,ve=n.find(`.tgme_widget_message_contact_phone`),W=ve.length?ve.text():``,ye=W?`<a href="tel:${W.replace(` `,``)}">${W}</a>`:``,be=U+(U&&W?`: `:``)+W,xe=_e||ye?`<p>${_e}${U&&W?`: `:``}${ye}</p>`:``,G=``,Se=n.find(`.tgme_widget_message_inline_button_text`);_&&Se.length&&(G+=`<table style="width: 100%"><tbody><tr>`,Se.each((e,t)=>{let n=I(t),r=n.text();G+=`<td style="border: 2px solid;text-align: center"><b>${r}</b></td>`}),G+=`</tr></tbody></table>`);let K=``,q=``,J=n.find(`.message_media_not_supported`);i.includes(D)&&(J.length?(K+=`<blockquote>`,J.find(`.message_media_not_supported_label`).each(function(){let e=I(this);q+=e.text(),K+=`<p>${e.text()}</p>`}),J.find(`.message_media_view_in_telegram`).each(function(){let e=I(this);K+=e.attr(`href`)?`<p><a href="${e.attr(`href`)}">${e.text()}</a></p>`:`<p>${e.text()}</p>`}),K+=`</blockquote>`):i=i.filter(e=>e!==D));let Ce=o(n.find(`.tgme_widget_message_date time`).attr(`datetime`)),Y=``;if(v)for(let e of i)(e!==S||e!==C||e!==w||e===S&&m||e===C&&h||e===w&&p)&&(Y+=y?O[e][1]:O[e][0]);let X=n.find(`.${i.includes(pe)?`media_supported_cont`:`tgme_widget_message_bubble`} > .tgme_widget_message_text`),we=``,Z=``;X.length>0&&(we=`<p>${X.html()}</p>`);let Q=!1;if(B?(Z=B,Q=!0):V?(Z=V,Q=!0):be?(Z=be,Q=!0):P?Z=P:q&&(Z=q,Q=!0),X.length>0&&!Q){let e=I(X.toString());e.find(`br`).replaceWith(`
`);let t=e.text().split(`
`).at(0)?.trim();Z+=(Z&&t?`: `:``)+t}Z=Z===``?Y||Ce.toUTCString():`${Y}${Y?` `:``}${Z}`;let $=``;return h&&($+=s()),m&&($+=c()),p&&($+=l()),$+=te()+me()+xe+F+H+we+K,f&&($+=R()),$+=G+ee,{title:Z,description:$,pubDate:Ce,link:n.find(`.tgme_widget_message_date`).attr(`href`),author:n.find(`.tgme_widget_message_from_author`).text(),enclosure_url:N,itunes_duration:L(),enclosure_type:`audio/ogg`,_extra:r}}).get().filter(Boolean).reverse()}}export{k as route};