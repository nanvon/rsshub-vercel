import{t as e}from"./config-D7dgKYF5.mjs";import{t}from"./logger-CkUWGGaS.mjs";import{t as n}from"./cache-Bv3_kFbE.mjs";import{t as r}from"./parse-date-_GmTZfjS.mjs";import{t as i}from"./got-BglkE51W.mjs";const a=async()=>{let e=await n.get(`tumblr:accessToken`,!1);if(!e)try{let t=await l();t&&(e=t)}catch(e){t.error(`Failed to refresh Tumblr token, using only client id as fallback`,e)}return e},o=async()=>{let e=await a();return e?{Authorization:`Bearer ${e}`}:{}},s=()=>e.tumblr.clientId,c=e=>{let t=``;switch(e.type){case`text`:t=e.body;break;case`answer`:t+=e.asking_url===null?`<p>${e.asking_name} asks:</p>`:`<p><a href="${e.asking_url}">${e.asking_name}</a> asks:</p>`,t+=e.question,t+=`<hr>`,t+=`<p><a href="${e.blog.url}">${e.blog_name}</a> answers:</p>`,t+=e.answer;break;case`photo`:for(let n of e.photos??[])t+=`<img src="${n.original_size.url}"/><br/>`;break;case`link`:t=e.url;break;case`audio`:t=e.embed;break;default:break}return{author:e.blog_name,id:e.id_string,title:e.summary??`New post from ${e.blog_name}`,link:e.post_url,pubDate:r(e.timestamp*1e3),category:e.tags,description:t}};let l=()=>Promise.resolve(null);e.tumblr&&e.tumblr.clientId&&e.tumblr.clientSecret&&e.tumblr.refreshToken&&(l=async()=>{let t=e.tumblr.refreshToken,r=await n.get(`tumblr:refreshToken`,!1);if(r){let e=JSON.parse(r);e.startToken===t&&(t=e.currentToken)}let a=await i.post(`https://api.tumblr.com/v2/oauth2/token`,{form:{grant_type:`refresh_token`,client_id:e.tumblr.clientId,client_secret:e.tumblr.clientSecret,refresh_token:t}});if(!a.data?.access_token||!a.data?.refresh_token)return null;let o=a.data.access_token,s=a.data.refresh_token,c=a.data.expires_in;await n.set(`tumblr:accessToken`,o,(c??2520)-30);let l={startToken:e.tumblr.refreshToken,currentToken:s};return await n.set(`tumblr:refreshToken`,JSON.stringify(l),31536e3),o});var u={processPost:c,generateAuthParams:s,generateAuthHeaders:o};export{u as t};