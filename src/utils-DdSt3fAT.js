import{__dirname as e,init_esm_shims as t}from"./esm-shims-DE2PJqdr.js";import{config as n}from"./config-CVBRPN4O.js";import{ofetch_default as r}from"./ofetch-CJF2SF6b.js";import{cache_default as i}from"./cache-Dfid4xgQ.js";import{art as a}from"./render-CSnicFA3.js";import{parseDate as o}from"./parse-date-DHsdom8D.js";import{not_found_default as s}from"./not-found-o393tAVF.js";import c from"node:path";import l from"dayjs";import u from"dayjs/plugin/duration.js";import*as d from"cheerio";import{google as f}from"googleapis";const{OAuth2:p}=f.auth;l.extend(u);let m=0;const h={};if(n.youtube&&n.youtube.key){let e=n.youtube.key.split(`,`);for(let[t,n]of e.entries())n&&(h[t]=f.youtube({version:`v3`,auth:n}),m=t+1)}let g=-1;const _=async e=>{let t;for(let n=0;n<m;n++){g++;try{t=await e(h[g%m]);break}catch{}}return t};let v;n.youtube&&n.youtube.clientId&&n.youtube.clientSecret&&n.youtube.refreshToken&&(v=new p(n.youtube.clientId,n.youtube.clientSecret,`https://developers.google.com/oauthplayground`),v.setCredentials({refresh_token:n.youtube.refreshToken}));const y=async({username:e,embed:t,filterShorts:n})=>{let a;e.startsWith(`@`)&&(a=await i.tryGet(`youtube:handle:${e}`,async()=>{let t=`https://www.youtube.com/${e}`,n=await r(t),a=d.load(n),o=JSON.parse(a(`script`).text().match(/ytInitialData = ({.*?});/)?.[1]||`{}`).metadata.channelMetadataRenderer,s=o.externalId,c=o.title,l=o.avatar?.thumbnails?.[0]?.url,u=o.description,f=(await L.getChannelWithId(s,`contentDetails`,i)).data.items[0].contentDetails.relatedPlaylists.uploads;return{channelName:c,image:l,description:u,playlistId:f}}));let c=await(async()=>{if(a?.playlistId){let e=a.playlistId;return L.getPlaylistWithShortsFilter(e,n)}else{let t=(await L.getChannelWithUsername(e,`contentDetails`,i)).data.items;if(!t)throw new s(`The channel https://www.youtube.com/user/${e} does not exist.`);let r=t[0].id;return n?L.getPlaylistWithShortsFilter(r,n):t[0].contentDetails.relatedPlaylists.uploads}})(),u=await L.getPlaylistItems(c,`snippet`,i);if(!u)throw new s(`This channel doesn't have any content.`);let f=u.data.items.map(e=>e.snippet.resourceId.videoId).join(`,`),p=await L.getVideos(f,`contentDetails`,i);return{title:`${a?.channelName||e} - YouTube`,link:e.startsWith(`@`)?`https://www.youtube.com/${e}`:`https://www.youtube.com/user/${e}`,description:a?.description||`YouTube user ${e}`,image:a?.image,item:u.data.items.filter(e=>e.snippet.title!==`Private video`&&e.snippet.title!==`Deleted video`).map(e=>{let n=e.snippet,r=n.resourceId.videoId,i=L.getThumbnail(n.thumbnails),a=p?.data.items.find(e=>e.id===r);return{title:n.title,description:L.renderDescription(t,r,i,L.formatDescription(n.description)),pubDate:o(n.publishedAt),link:`https://www.youtube.com/watch?v=${r}`,author:n.videoOwnerChannelTitle,image:i.url,attachments:[{url:P(r),mime_type:`text/html`,duration_in_seconds:a?.contentDetails.duration?l.duration(a.contentDetails.duration).asSeconds():void 0}]}})}},b=async({channelId:e,embed:t,filterShorts:n})=>{let r=n?null:(await L.getChannelWithId(e,`contentDetails`,i)).data.items[0].contentDetails.relatedPlaylists.uploads,a=n?L.getPlaylistWithShortsFilter(e):r,s=(await L.getPlaylistItems(a,`snippet`,i)).data.items,c=s.map(e=>e.snippet.resourceId.videoId).join(`,`),u=await L.getVideos(c,`contentDetails`,i);return{title:`${s[0].snippet.channelTitle} - YouTube`,link:`https://www.youtube.com/channel/${e}`,description:`YouTube channel ${s[0].snippet.channelTitle}`,item:s.filter(e=>e.snippet.title!==`Private video`&&e.snippet.title!==`Deleted video`).map(e=>{let n=e.snippet,r=n.resourceId.videoId,i=L.getThumbnail(n.thumbnails),a=u?.data.items.find(e=>e.id===r);return{title:n.title,description:L.renderDescription(t,r,i,L.formatDescription(n.description)),pubDate:o(n.publishedAt),link:`https://www.youtube.com/watch?v=${r}`,author:n.videoOwnerChannelTitle,image:i.url,attachments:[{url:P(r),mime_type:`text/html`,duration_in_seconds:a?.contentDetails.duration?l.duration(a.contentDetails.duration).asSeconds():void 0}]}})}},x=async({playlistId:e,embed:t})=>{let n=(await L.getPlaylist(e,`snippet`,i)).data.items[0].snippet.title,r=(await L.getPlaylistItems(e,`snippet`,i)).data.items.filter(e=>e.snippet.title!==`Private video`&&e.snippet.title!==`Deleted video`),a=r.map(e=>e.snippet.resourceId.videoId).join(`,`),s=await L.getVideos(a,`contentDetails`,i);return{title:`${n} by ${r[0].snippet.channelTitle} - YouTube`,link:`https://www.youtube.com/playlist?list=${e}`,description:`${n} by ${r[0].snippet.channelTitle}`,item:r.map(e=>{let n=e.snippet,r=n.resourceId.videoId,i=L.getThumbnail(n.thumbnails),a=s?.data.items.find(e=>e.id===r);return{title:n.title,description:L.renderDescription(t,r,i,L.formatDescription(n.description)),pubDate:o(n.publishedAt),link:`https://www.youtube.com/watch?v=${r}`,author:n.videoOwnerChannelTitle,image:i.url,attachments:[{url:P(r),mime_type:`text/html`,duration_in_seconds:a?.contentDetails.duration?l.duration(a.contentDetails.duration).asSeconds():void 0}]}})}};t();const S=(e,t,r)=>r.tryGet(`youtube:getPlaylistItems:${e}`,async()=>await _(n=>n.playlistItems.list({part:t,playlistId:e,maxResults:50})),n.cache.routeExpire,!1),C=(e,t,n)=>n.tryGet(`youtube:getPlaylist:${e}`,async()=>await _(n=>n.playlists.list({part:t,id:e}))),w=(e,t,n)=>n.tryGet(`youtube:getChannelWithId:${e}`,async()=>await _(n=>n.channels.list({part:t,id:e}))),T=(e,t,n)=>n.tryGet(`youtube:getChannelWithUsername:${e}`,async()=>await _(n=>n.channels.list({part:t,forUsername:e}))),E=(e,t,n)=>n.tryGet(`youtube:getVideos:${e}`,async()=>await _(n=>n.videos.list({part:t,id:e}))),D=e=>e.maxres||e.standard||e.high||e.medium||e.default,O=e=>e?.replaceAll(/\r\n|\r|\n/g,`<br>`),k=(t,n,r,i)=>a(c.join(e,`templates/description-e0f4b632.art`),{embed:t,videoId:n,img:r,description:i}),A=async(e,t)=>{let r=await t.get(`youtube:accessToken`,!1);return r||(r=(await v.getAccessToken()).token,await t.set(`youtube:accessToken`,r,3600)),v.setCredentials({access_token:r,refresh_token:n.youtube.refreshToken}),t.tryGet(`youtube:getSubscriptions`,()=>j(e),n.cache.routeExpire,!1)};async function j(e,t){let n=await f.youtube(`v3`).subscriptions.list({auth:v,part:e,mine:!0,maxResults:50,pageToken:t??void 0});if(n.data.nextPageToken){let t=await j(e,n.data.nextPageToken);t.data.items&&(n.data.items=[...n.data.items||[],...t.data.items])}return n}const M=e=>/^UC[\w-]{21}[AQgw]$/.test(e),N=(e,t)=>t.tryGet(`youtube:getLive:${e}`,async()=>await _(t=>t.search.list({part:`snippet`,channelId:e,eventType:`live`,type:`video`}))),P=e=>`https://www.youtube-nocookie.com/embed/${e}?controls=1&autoplay=1&mute=0`,F=(e,t=!0)=>t&&(e.startsWith(`UC`)||e.startsWith(`UU`))?`UULF`+e.slice(2):e,I=async({googleApi:e,youtubeiApi:t,params:r})=>{if(n.youtube?.key)try{return await e(r)}catch{return await t(r)}return await t(r)};var L={getPlaylistItems:S,getPlaylist:C,getChannelWithId:w,getChannelWithUsername:T,getVideos:E,getThumbnail:D,formatDescription:O,renderDescription:k,getSubscriptions:A,getSubscriptionsRecusive:j,isYouTubeChannelId:M,getLive:N,getVideoUrl:P,getPlaylistWithShortsFilter:F};export{I as callApi,b as getDataByChannelId,x as getDataByPlaylistId,y as getDataByUsername,P as getVideoUrl,M as isYouTubeChannelId,k as renderDescription,L as utils_default};