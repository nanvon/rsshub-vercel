import"./esm-shims-Dqvxr0BZ.js";import{config as e}from"./config-BpwDbAkH.js";import{logger_default as t}from"./logger-B3QfaIfn.js";import{proxy_default as n}from"./proxy-CnCu3_dc.js";import{Xe as r}from"./dist-BYIKqG8W.js";import i,{FormData as a,Headers as o,Request as s,Response as c}from"undici";import l from"node:http";import u from"node:https";import{RateLimiterMemory as d,RateLimiterQueue as f}from"rate-limiter-flexible";const p=new d({points:10,duration:1,execEvenly:!0}),m=new f(p,{maxQueueSize:4800}),h=e=>{process.env.NODE_ENV===`dev`&&r(t=>{for(let[n,r]of e.entries())t.requestHeaders[n]=r;return t})},g=async(r,a)=>{let o=new s(r,a),c={};if(t.debug(`Outgoing request: ${o.method} ${o.url}`),o.headers.get(`user-agent`)||o.headers.set(`user-agent`,e.ua),o.headers.get(`accept`)||o.headers.set(`accept`,`*/*`),!o.headers.get(`referer`))try{let e=new URL(o.url);o.headers.set(`referer`,e.origin)}catch{}let l=!1;if(o.headers.get(`x-prefer-proxy`)&&(l=!0,o.headers.delete(`x-prefer-proxy`)),e.enableRemoteDebugging&&h(o.headers),!a?.dispatcher&&(n.proxyObj.strategy!==`on_retry`||l)){let e=new RegExp(n.proxyObj.url_regex),r;try{r=new URL(o.url)}catch{}if(e.test(o.url)&&o.url.startsWith(`http`)&&!(r&&r.host===n.proxyUrlHandler?.host)){let e=n.getCurrentProxy();if(e){let r=n.getDispatcherForProxy(e);r&&(c.dispatcher=r,t.debug(`Proxying request via ${e.uri}: ${o.url}`))}}}await m.removeTokens(1);let u=n.multiProxy?.allProxies.length||1,d=async e=>{try{return await i.fetch(o,c)}catch(r){if(c.dispatcher&&n.multiProxy&&e<u-1){let i=n.getCurrentProxy();if(i){t.warn(`Request failed with proxy ${i.uri}, trying next proxy: ${r}`),n.markProxyFailed(i.uri);let a=n.getCurrentProxy();if(a&&a.uri!==i.uri){let r=n.getDispatcherForProxy(a);return r&&(c.dispatcher=r),t.debug(`Retrying request with proxy ${a.uri}: ${o.url}`),d(e+1)}else return t.warn(`No more proxies available, trying without proxy`),delete c.dispatcher,d(e+1)}}throw r}};return d(0)};var _=g;const v=r=>function(...i){let a,o={},s;if(typeof i[0]==`string`||i[0]instanceof URL)a=new URL(i[0]),typeof i[1]==`object`?(o=i[1],s=i[2]):typeof i[1]==`function`&&(o={},s=i[1]);else{o=i[0];try{a=new URL(o.href||`${o.protocol||`http:`}//${o.hostname||o.host}${o.path}${o.search||(o.query?`?${o.query}`:``)}`)}catch{a=null}typeof i[1]==`function`&&(s=i[1])}if(!a)return Reflect.apply(r,this,i);t.debug(`Outgoing request: ${o.method||`GET`} ${a}`),o.headers=o.headers||{};let c=new Set(Object.keys(o.headers).map(e=>e.toLowerCase()));if(c.has(`user-agent`)||(o.headers[`user-agent`]=e.ua),c.has(`accept`)||(o.headers.accept=`*/*`),c.has(`referer`)||(o.headers.referer=a.origin),!o.agent&&n.agent){let t=new RegExp(n.proxyObj.url_regex);t.test(a.toString())&&a.protocol.startsWith(`http`)&&a.host!==n.proxyUrlHandler?.host&&a.host!==`localhost`&&!a.host.startsWith(`127.`)&&!(e.puppeteerWSEndpoint?.includes(a.host)??!1)&&(o.agent=n.agent)}return Reflect.apply(r,this,[a,o,s])};var y=v;Object.defineProperties(globalThis,{fetch:{value:_},Headers:{value:o},FormData:{value:a},Request:{value:s},Response:{value:c}}),l.get=y(l.get),l.request=y(l.request),u.get=y(u.get),u.request=y(u.request);var b=(await import(`./app-bootstrap-ClvM1hXB.js`)).default;export{b as default};