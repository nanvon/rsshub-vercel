import{__dirname as e,init_esm_shims as t}from"./esm-shims-DE2PJqdr.js";import{config as n}from"./config-CVBRPN4O.js";import{ofetch_default as r}from"./ofetch-CJF2SF6b.js";import{art as i}from"./render-CSnicFA3.js";import{parseDate as a}from"./parse-date-DHsdom8D.js";import{got_default as o}from"./got-Baw2Nbdf.js";import{config_not_found_default as s}from"./config-not-found-mNOcOzCd.js";import c from"node:path";import{load as l}from"cheerio";t();const u=`https://nhentai.net`,d=async(e,t,n)=>{let r=`https://nhentai.net/login/`,i=`nhentai:cookie`,a=await n.get(i);if(a){let{cookie:e,time:t}=JSON.parse(a);if(Date.now()-t<86400*3*1e3)return e}let{data:s,headers:c}=await o(r),l=s.match(/name="csrfmiddlewaretoken" value="(.*?)"/)[1],u=c[`set-cookie`].map(e=>e.split(`;`)[0]).join(`; `),d=await o.post(r,{headers:{referer:r,cookie:u},form:{csrfmiddlewaretoken:l,username_or_email:e,password:t,next:``},followRedirect:!1});if(d.statusCode!==302)return n.set(i,JSON.stringify({cookie:``,time:Date.now()})),``;let f=d.headers[`set-cookie`].map(e=>e.split(`;`)[0]).join(`; `);return n.set(i,JSON.stringify({cookie:f,time:Date.now()})),f},f=(e,...t)=>r(e,{...t,headers:{host:`nhentai.net`}}),p=async e=>{let t=await f(e),n=l(t);return n(`.gallery a.cover`).toArray().map(e=>_(n(e)))},m=(e,t,n)=>Promise.all(t.slice(0,n).map(t=>e.tryGet(t.link,()=>y(t)))),h=async(e,t,r)=>{if(!n.nhentai||!n.nhentai.username||!n.nhentai.password)throw new s(`nhentai RSS with torrents is disabled due to the lack of <a href="https://docs.rsshub.app/deploy/config#route-specific-configurations">relevant config</a>`);let i=await d(n.nhentai.username,n.nhentai.password,e);if(!i)throw new s(`Invalid username (or email) or password for nhentai torrent download`);return g(e,t,i,r)},g=(e,t,n,r)=>Promise.all(t.slice(0,r).map(t=>e.tryGet(t.link+`download`,()=>v(t,n)))),_=e=>{let t=new URL(e.attr(`href`),u).href,n=e.children(`img`),r=(n.attr(`data-src`)||n.attr(`src`)).replace(`thumb`,`1`).replace(/t(\d+)\.nhentai\.net/,`i$1.nhentai.net`).replace(`.webp.webp`,`.webp`);return{title:e.children(`.caption`).text(),link:t,description:`<img src="${r}">`}},v=async(e,t)=>{let{link:n}=e,r=await f(n+`download`,{followRedirect:!1,responseType:`buffer`,headers:{Cookie:t}});return{...e,enclosure_url:r,enclosure_type:`application/x-bittorrent`}},y=async t=>{let{link:n}=t,r=await f(n),o=l(r),s=o(`.gallerythumb img`).toArray().map(e=>new URL(o(e).attr(`data-src`),u).href).map(e=>e.replace(/(.+)(\d+)t\.(.+)/,(e,t,n,r)=>`${t}${n}.${r}`)).map(e=>e.replace(/t(\d+)\.nhentai\.net/,`i$1.nhentai.net`)).map(e=>e.replace(/\.(jpg|png|gif)\.webp$/,`.$1`)).map(e=>e.replace(/\.webp\.webp$/,`.webp`));return{...t,title:o(`div#info > h2`).text()||o(`div#info > h1`).text(),pubDate:a(o(`time`).attr(`datetime`)),description:i(c.join(e,`templates/desc-9360b66a.art`),{length:s.length,images:s})}};export{m as getDetails,p as getSimple,h as getTorrents};