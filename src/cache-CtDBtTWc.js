import{config as e}from"./config-CVBRPN4O.js";import{logger_default as t}from"./logger-BvonkID1.js";import{cache_default as n}from"./cache-Dfid4xgQ.js";import{got_default as r}from"./got-D5TEN1xL.js";import{getPuppeteerPage as i}from"./puppeteer-DGJWMOFh.js";import{utils_default as a}from"./utils-HLOUx_A6.js";import{RateLimiterMemory as o,RateLimiterQueue as s}from"rate-limiter-flexible";import{load as c}from"cheerio";import{JSDOM as l}from"jsdom";const u=new o({points:5,duration:1,execEvenly:!0}),d=new s(u,{maxQueueSize:4800}),f=(r=!1)=>{if(Object.keys(e.bilibili.cookies).length>0&&!r){for(let t of Object.keys(e.bilibili.cookies)){let n=e.bilibili.cookies[t];if(n){let r=n.replace(/b_lsid=[0-9A-F]+_[0-9A-F]+/,`b_lsid=${a.lsid()}`);e.bilibili.cookies[t]=r}}return e.bilibili.cookies[Object.keys(e.bilibili.cookies)[Math.floor(Math.random()*Object.keys(e.bilibili.cookies).length)]]}return n.tryGet(`bili-cookie`,async()=>{let e=new Promise(e=>{e(``)}),{destory:n}=await i(`https://space.bilibili.com/1/dynamic`,{onBeforeLoad:t=>{e=new Promise(e=>{t.on(`requestfinished`,async n=>{if(n.url()===`https://api.bilibili.com/x/internal/gaia-gateway/ExClimbWuzhi`){let n=(await t.cookies()).map(e=>`${e.name}=${e.value}`).join(`; `);n=n.replace(/b_lsid=[0-9A-F]+_[0-9A-F]+/,`b_lsid=${a.lsid()}`),e(n)}})})}}),r=await e;return t.debug(`Got bilibili cookie: ${r}`),await n(),r})},p=e=>n.tryGet(`bili-web-render-data`,async()=>{let t=await f(),{data:n}=await r(`https://space.bilibili.com/${e}`,{headers:{Referer:`https://www.bilibili.com/`,Cookie:t}}),i=new l(n).window.document.querySelector(`#__RENDER_DATA__`),a=i&&i.textContent||`{}`;return JSON.parse(decodeURIComponent(a)).access_id}),m=()=>n.tryGet(`bili-wbi-verify-string`,async()=>{let e=await f(),{data:t}=await r(`https://api.bilibili.com/x/web-interface/nav`,{headers:{Referer:`https://www.bilibili.com/`,Cookie:e}}),n=t.data.wbi_img.img_url,i=t.data.wbi_img.sub_url,a=n.substring(n.lastIndexOf(`/`)+1,n.length).split(`.`)[0]+i.substring(i.lastIndexOf(`/`)+1,i.length).split(`.`)[0],{body:o}=await r(`https://s1.hdslb.com/bfs/seed/laputa-header/bili-header.umd.js`,{headers:{Referer:`https://space.bilibili.com/1`}}),s=JSON.parse(o.match(/\[(?:\d+,){63}\d+]/)),c=[];for(let e of s)a.charAt(e)&&c.push(a.charAt(e));return c.join(``).slice(0,32)}),h=e=>{let t=`bili-username-from-uid-`+e;return n.tryGet(t,async()=>{let t=await f(),n=await m(),i=a.addWbiVerifyInfo(`mid=${e}&token=&platform=web&web_location=1550101`,n),{data:o}=await r(`https://api.bilibili.com/x/space/wbi/acc/info?${i}`,{headers:{Referer:`https://space.bilibili.com/${e}/`,Cookie:t}});return o.data?o.data.name:void 0})},g=async e=>{let i=`bili-username-from-uid-`+e,o=`bili-userface-from-uid-`+e,s=await n.get(i),c=await n.get(o);if(!s||!c){let l=await f(),u=await m(),d=a.getDmImgList(),h=await p(e),g=a.addWbiVerifyInfo(a.addRenderData(a.addDmVerifyInfo(`mid=${e}&token=&platform=web&web_location=1550101`,d),h),u),{data:_}=await r(`https://api.bilibili.com/x/space/wbi/acc/info?${g}`,{headers:{Referer:`https://space.bilibili.com/${e}/`,Cookie:l}});_.data.name?(s=_.data.name,c=_.data.face,n.set(i,_.data.name),n.set(o,_.data.face)):t.error(`Error when visiting /x/space/wbi/acc/info: ${JSON.stringify(_)}`)}return[s,c]},_=e=>{let t=`bili-liveID-from-shortID-${e}`;return n.tryGet(t,async()=>{let{data:t}=await r(`https://api.live.bilibili.com/room/v1/Room/room_init?id=${e}`,{headers:{Referer:`https://live.bilibili.com/${e}`}});return t.data.room_id})},v=e=>{let t=`bili-userinfo-from-liveID-${e}`;return n.tryGet(t,async()=>{let{data:t}=await r(`https://api.live.bilibili.com/live_user/v1/UserInfo/get_anchor_in_room?roomid=${e}`,{headers:{Referer:`https://live.bilibili.com/${e}`}});return t.data.info})},y=(e,t)=>{let i=`bili-videoname-from-id-${t||e}`;return n.tryGet(i,async()=>{let{data:n}=await r(`https://api.bilibili.com/x/web-interface/view`,{searchParams:{aid:e||void 0,bvid:t||void 0},referer:`https://www.bilibili.com/video/${t||`av${e}`}`});return n.data.title})},b=(e,t,i)=>{let a=`bili-cid-from-id-${i||e}-${t}`;return n.tryGet(a,async()=>{let{data:n}=await r(`https://api.bilibili.com/x/web-interface/view?${i?`bvid=${i}`:`aid=${e}`}`,{referer:`https://www.bilibili.com/video/${i||`av${e}`}`});return n?.data?.pages[t-1]?.cid})};function x(e){let t=new Date(e*1e3),n=String(t.getUTCHours()).padStart(2,`0`),r=String(t.getUTCMinutes()).padStart(2,`0`),i=String(t.getUTCSeconds()).padStart(2,`0`),a=String(t.getUTCMilliseconds()).padStart(3,`0`);return`${n}:${r}:${i},${a}`}function S(e){return e.map((e,t)=>{let n=x(e.from),r=x(e.to);return`${t+1}\n${n} --> ${r}\n${e.content}\n`}).join(`
`)}const C=async e=>{if(!e)return[];let t=await b(void 0,1,e);if(!t)return[];let i=await f();return n.tryGet(`bili-video-subtitle-${e}`,async()=>{await d.removeTokens(1);let a=(await r(`https://api.bilibili.com/x/player/wbi/v2?bvid=${e}&cid=${t}`,{headers:{Referer:`https://www.bilibili.com/video/${e}`,Cookie:i}}))?.data?.data?.subtitle?.subtitles||[];return await Promise.all(a.map(async e=>{let t=`https:${e.subtitle_url}`;return{content:await n.tryGet(t,async()=>{let e=await r(t);return S(e?.data?.body||[])}),lan_doc:e.lan_doc}}))})};var w={getCookie:f,getWbiVerifyString:m,getUsernameFromUID:h,getUsernameAndFaceFromUID:g,getLiveIDFromShortID:_,getUserInfoFromLiveID:v,getVideoNameFromId:y,getCidFromId:b,getAidFromBvid:async e=>{let t=`bili-cid-from-bvid-${e}`,i=await n.get(t);if(!i){let a=await r(`https://api.bilibili.com/x/web-interface/view?bvid=${e}`,{headers:{Referer:`https://www.bilibili.com/video/${e}`}});a.data&&a.data.data&&a.data.data.aid&&(i=a.data.data.aid),n.set(t,i)}return i},getArticleDataFromCvid:async(e,t)=>{let i=`https://www.bilibili.com/read/cv${e}/`,a=await n.tryGet(i,async()=>(await r({method:`get`,url:i,headers:{Referer:`https://space.bilibili.com/${t}/`}})).data),o=c(a),s=o(`#read-article-holder`).html();if(!s)try{let e=JSON.parse(o(`script:contains("window.__INITIAL_STATE__")`).text().match(/window\.__INITIAL_STATE__\s*=\s*(.*?);\(/)[1]);if(e?.readInfo?.opus?.content?.paragraphs){s=``;for(let t of e.readInfo.opus.content.paragraphs){if(t.para_type===1)for(let e of t.text.nodes)e?.word?.words&&(s+=`<p>${e.word.words}</p>`);if(t.para_type===2)for(let e of t.pic.pics)s+=`<p ><img src="${e.url}@progressive.webp"></p>`;t.para_type===3&&t.line?.pic?.url&&(s+=`<figure><img src="${t.line.pic.url}"></figure>`)}}}catch{}return{url:i,description:s}},getRenderData:p,getVideoSubtitle:C,getVideoSubtitleAttachment:async e=>(await C(e)).map(e=>({url:`data:text/plain;charset=utf-8,${encodeURIComponent(e.content)}`,mime_type:`text/srt`,title:`字幕 - ${e.lan_doc}`}))};export{w as cache_default};