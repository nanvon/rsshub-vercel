import{__dirname as e,init_esm_shims as t}from"./esm-shims-rNwigI-Q.js";import"./config-CVBRPN4O.js";import"./logger-BvonkID1.js";import"./ofetch-CeMUzp5K.js";import"./helpers-qpI1t-yV.js";import{art as n}from"./render-DftO2d-b.js";import{parseDate as r}from"./parse-date-DHsdom8D.js";import{getSubPath as i}from"./common-utils-KsMWGCAa.js";import{got_default as a}from"./got-Di2lBekK.js";import{timezone as o}from"./timezone-CMz5pnRe.js";import s from"node:path";import c from"dayjs";import{load as l}from"cheerio";t();const u=`https://www.dlsite.com`,d={show_type:1,show_layout:1,per_page:100},f=(e,t)=>c(e).format(t),p=(e,t)=>{let n=Object.keys(t),r=n.map(e=>`/${e}/${t[e]}`).join(``),i=e.replaceAll(RegExp(`(/${n.join(String.raw`/\w+|/`)}/\\w+)`,`g`),``);return`${i}${/=/.test(i)?``:`/=`}${r}`},m=e=>{let t=e.match(/(\d{4}).*(\d{2}).*(\d{2})/);return t?r(`${t[1]}-${t[2]}-${t[3]}`,`YYYY-MM-DD`):r(e.split(`:`).pop().trim(),`MMM/DD/YYYY`)},h=async e=>(await a({method:`get`,url:`${u}/home-touch/product/info/ajax?product_id=${e}`})).data,g=async t=>{n.defaults.imports.formatDate=f;let g=i(t)===`/`?`/home/new`:i(t),_=t.req.query(`limit`)?Number.parseInt(t.req.query(`limit`)):100,v=`${u}${p(g,d)}`,y=l((await a({method:`get`,url:v})).data),b=y(`dt.work_name`).slice(0,_),x=y(`.work_update`).length===0?void 0:m(y(`.work_update`).text()),S=await h(b.toArray().map(e=>y(e).find(`a`).attr(`href`).match(/_id\/(.*?)\.html/)[1]).join(`,`)),C=b.toArray().map(t=>{t=y(t).parentsUntil(`tbody, ul`);let i=t.find(`.work_name a`),a=i.text(),l=i.attr(`href`),u=l.match(/_id\/(.*?)\.html/)[1],d=t.find(`.work_text`).text(),f=t.find(`.maker_name a`).toArray().map(e=>({name:y(e).text(),link:y(e).attr(`href`)})),p=t.find(`div[data-samples]`).length===0?[]:JSON.parse(t.find(`div[data-samples]`).attr(`data-samples`).replaceAll(`'`,`"`)).map(e=>e.thumb),m=t.find(`.work_category`).find(`a`).toArray().map(e=>({text:y(e).text(),link:y(e).attr(`href`)})),h=t.find(`.work_genre`).find(`span[title]`).toArray().map(e=>({text:y(e).text()})),g=t.find(`.search_tag`).find(`a`).toArray().map(e=>({text:y(e).text(),link:y(e).attr(`href`)})),_=t.find(`.icon_wrap`).find(`span[title]`).toArray().map(e=>({text:y(e).text()})),v=S[u],b=o(r(v.regist_date),9),C=v.discount_rate,w=v.discount_end_date?o(r(v.discount_end_date,`MM/DD HH:mm`),9):void 0;return p=p.length===0?[v.work_image]:p,{title:`${C?`${C}% OFF
                        ${` ${w?`${c(w).format(`YYYY-MM-DD HH:mm`)} まで`:``}`}`:` `}${a}`,link:l,pubDate:b,author:f.map(e=>e.name).join(` / `),category:[...m.map(e=>e.text),...h.map(e=>e.text),...g.map(e=>e.text),..._.map(e=>e.text)],guid:`dlsite-${u}`,description:n(s.join(e,`templates/description-3ff6e827.art`),{detail:v,images:p,authors:f,discountRate:C,discountEndDate:w,updatedDate:x,pubDate:b,workCategories:m,workGenres:h,searchTags:g,description:d})}});return{title:y(`title`).text(),description:y(`meta[name="description"]`).attr(`content`),link:v,item:C,allowEmpty:!0}},_={path:`*`,name:`Unknown`,maintainers:[],handler:v,features:{nsfw:!0}};async function v(e){return await g(e)}export{_ as route};