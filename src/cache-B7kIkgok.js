import{t as e}from"./config-DZMnNPig.js";import{t}from"./logger-asV68Lay.js";import{t as n}from"./cache-CpEhLexq.js";import{t as r}from"./got-BVCqvF6m.js";import{t as i}from"./puppeteer-e0F06Yyi.js";import{r as a}from"./utils-DTEapQ_U.js";import{RateLimiterMemory as o,RateLimiterQueue as s}from"rate-limiter-flexible";import{load as c}from"cheerio";import{JSDOM as l}from"jsdom";const u=new s(new o({points:5,duration:1,execEvenly:!0}),{maxQueueSize:4800}),d=(r=!1)=>{if(Object.keys(e.bilibili.cookies).length>0&&!r){for(let t of Object.keys(e.bilibili.cookies)){let n=e.bilibili.cookies[t];if(n){let r=n.replace(/b_lsid=[0-9A-F]+_[0-9A-F]+/,`b_lsid=${a.lsid()}`);e.bilibili.cookies[t]=r}}return e.bilibili.cookies[Object.keys(e.bilibili.cookies)[Math.floor(Math.random()*Object.keys(e.bilibili.cookies).length)]]||``}return n.tryGet(`bili-cookie`,async()=>{let e=new Promise(e=>{e(``)}),{destory:n}=await i(`https://space.bilibili.com/1/dynamic`,{onBeforeLoad:t=>{e=new Promise(e=>{t.on(`requestfinished`,async n=>{if(n.url()===`https://api.bilibili.com/x/internal/gaia-gateway/ExClimbWuzhi`){let n=(await t.cookies()).map(e=>`${e.name}=${e.value}`).join(`; `);n=n.replace(/b_lsid=[0-9A-F]+_[0-9A-F]+/,`b_lsid=${a.lsid()}`),e(n)}})})}}),r=await e;return t.debug(`Got bilibili cookie: ${r}`),await n(),r})},f=e=>n.tryGet(`bili-web-render-data`,async()=>{let t=await d(),{data:n}=await r(`https://space.bilibili.com/${e}`,{headers:{Referer:`https://www.bilibili.com/`,Cookie:t}}),i=new l(n).window.document.querySelector(`#__RENDER_DATA__`),a=i&&i.textContent||`{}`;return JSON.parse(decodeURIComponent(a)).access_id}),p=()=>n.tryGet(`bili-wbi-verify-string`,async()=>{let{data:e}=await r(`https://api.bilibili.com/x/web-interface/nav`,{headers:{Referer:`https://www.bilibili.com/`,Cookie:await d()}}),t=e.data.wbi_img.img_url,n=e.data.wbi_img.sub_url,i=t.substring(t.lastIndexOf(`/`)+1,t.length).split(`.`)[0]+n.substring(n.lastIndexOf(`/`)+1,n.length).split(`.`)[0],{body:a}=await r(`https://s1.hdslb.com/bfs/seed/laputa-header/bili-header.umd.js`,{headers:{Referer:`https://space.bilibili.com/1`}}),o=JSON.parse(a.match(/\[(?:\d+,){63}\d+]/)),s=[];for(let e of o)i.charAt(e)&&s.push(i.charAt(e));return s.join(``).slice(0,32)}),m=e=>{let t=`bili-username-from-uid-`+e;return n.tryGet(t,async()=>{let t=await d(),n=await p(),{data:i}=await r(`https://api.bilibili.com/x/space/wbi/acc/info?${a.addWbiVerifyInfo(`mid=${e}&token=&platform=web&web_location=1550101`,n)}`,{headers:{Referer:`https://space.bilibili.com/${e}/`,Cookie:t}});return i.data?i.data.name:void 0})},h=async e=>{let i=`bili-username-from-uid-`+e,o=`bili-userface-from-uid-`+e,s=await n.get(i),c=await n.get(o);if(!s||!c){let l=await d(),u=await p(),m=a.getDmImgList(),h=await f(e),{data:g}=await r(`https://api.bilibili.com/x/space/wbi/acc/info?${a.addWbiVerifyInfo(a.addRenderData(a.addDmVerifyInfo(`mid=${e}&token=&platform=web&web_location=1550101`,m),h),u)}`,{headers:{Referer:`https://space.bilibili.com/${e}/`,Cookie:l}});g.data.name?(s=g.data.name,c=g.data.face,n.set(i,g.data.name),n.set(o,g.data.face)):t.error(`Error when visiting /x/space/wbi/acc/info: ${JSON.stringify(g)}`)}return[s,c]},g=e=>{let t=`bili-liveID-from-shortID-${e}`;return n.tryGet(t,async()=>{let{data:t}=await r(`https://api.live.bilibili.com/room/v1/Room/room_init?id=${e}`,{headers:{Referer:`https://live.bilibili.com/${e}`}});return t.data.room_id})},_=e=>{let t=`bili-userinfo-from-liveID-${e}`;return n.tryGet(t,async()=>{let{data:t}=await r(`https://api.live.bilibili.com/live_user/v1/UserInfo/get_anchor_in_room?roomid=${e}`,{headers:{Referer:`https://live.bilibili.com/${e}`}});return t.data.info})},v=(e,t)=>{let i=`bili-videoname-from-id-${t||e}`;return n.tryGet(i,async()=>{let{data:n}=await r(`https://api.bilibili.com/x/web-interface/view`,{searchParams:{aid:e||void 0,bvid:t||void 0},referer:`https://www.bilibili.com/video/${t||`av${e}`}`});return n.data.title})},y=(e,t,i)=>{let a=`bili-cid-from-id-${i||e}-${t}`;return n.tryGet(a,async()=>{let{data:n}=await r(`https://api.bilibili.com/x/web-interface/view?${i?`bvid=${i}`:`aid=${e}`}`,{referer:`https://www.bilibili.com/video/${i||`av${e}`}`});return n?.data?.pages[t-1]?.cid})};function b(e){let t=new Date(e*1e3);return`${String(t.getUTCHours()).padStart(2,`0`)}:${String(t.getUTCMinutes()).padStart(2,`0`)}:${String(t.getUTCSeconds()).padStart(2,`0`)},${String(t.getUTCMilliseconds()).padStart(3,`0`)}`}function x(e){return e.map((e,t)=>{let n=b(e.from),r=b(e.to);return`${t+1}\n${n} --> ${r}\n${e.content}\n`}).join(`
`)}const S=async e=>{if(!e)return[];let t=await y(void 0,1,e);return t?n.tryGet(`bili-video-subtitle-${e}`,async()=>{await u.removeTokens(1);let i=(await(async n=>await r(`https://api.bilibili.com/x/player/wbi/v2?bvid=${e}&cid=${t}`,{headers:{Referer:`https://www.bilibili.com/video/${e}`,Cookie:n}}))(await d()))?.data?.data?.subtitle?.subtitles||[];return await Promise.all(i.map(async e=>{let t=`https:${e.subtitle_url}`;return{content:await n.tryGet(t,async()=>x((await r(t))?.data?.body||[])),lan_doc:e.lan_doc}}))}):[]};var C={getCookie:d,getWbiVerifyString:p,getUsernameFromUID:m,getUsernameAndFaceFromUID:h,getLiveIDFromShortID:g,getUserInfoFromLiveID:_,getVideoNameFromId:v,getCidFromId:y,getAidFromBvid:async e=>{let t=`bili-cid-from-bvid-${e}`,i=await n.get(t);if(!i){let a=await r(`https://api.bilibili.com/x/web-interface/view?bvid=${e}`,{headers:{Referer:`https://www.bilibili.com/video/${e}`}});a.data&&a.data.data&&a.data.data.aid&&(i=a.data.data.aid),n.set(t,i)}return i},getArticleDataFromCvid:async(e,t)=>{let i=`https://www.bilibili.com/read/cv${e}/`,a=c(await n.tryGet(i,async()=>(await r({method:`get`,url:i,headers:{Referer:`https://space.bilibili.com/${t}/`}})).data)),o=a(`#read-article-holder`).html();if(!o)try{let e=JSON.parse(a(`script:contains("window.__INITIAL_STATE__")`).text().match(/window\.__INITIAL_STATE__\s*=\s*(.*?);\(/)[1]);if(e?.readInfo?.opus?.content?.paragraphs){o=``;for(let t of e.readInfo.opus.content.paragraphs){if(t.para_type===1)for(let e of t.text.nodes)e?.word?.words&&(o+=`<p>${e.word.words}</p>`);if(t.para_type===2)for(let e of t.pic.pics)o+=`<p ><img src="${e.url}@progressive.webp"></p>`;t.para_type===3&&t.line?.pic?.url&&(o+=`<figure><img src="${t.line.pic.url}"></figure>`)}}}catch{}return{url:i,description:o}},getRenderData:f,getVideoSubtitle:S,getVideoSubtitleAttachment:async e=>(await S(e)).map(e=>({url:`data:text/plain;charset=utf-8,${encodeURIComponent(e.content)}`,mime_type:`text/srt`,title:`字幕 - ${e.lan_doc}`}))};export{C as t};