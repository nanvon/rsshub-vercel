import"./esm-shims-CaZMYoY8.js";import"./config-DZMnNPig.js";import"./logger-asV68Lay.js";import"./ofetch-VsB2Peor.js";import"./helpers-Cqaav28H.js";import{t as e}from"./request-in-progress-CoWneQMl.js";import{t}from"./cache-CpEhLexq.js";import{t as n}from"./parse-date-CHEO0z5G.js";import{t as r}from"./got-BVCqvF6m.js";import{t as i}from"./timezone-BPfwRbwD.js";import{t as a}from"./wait-nP2kA_Du.js";import{n as o}from"./wechat-mp-DfzFv2ht.js";import{load as s}from"cheerio";const c=(e,t,r)=>{let a=e.find(t);return{title:a.text(),link:a.attr(`href`),pubDate:i(n(e.find(r).text(),`YYYY-MM-DD HH:mm`),8)}},l={path:`/data258/:id?`,radar:[{source:[`mp.data258.com/`,`mp.data258.com/article/category/:id`]}],name:`Unknown`,maintainers:[`Rongronggg9`],handler:u,url:`mp.data258.com/`};async function u(n){if(await t.get(`data258:lock`,!1)===`1`)throw new e(`Another request is in progress, please try again later.`);let i=n.req.param(`id`),l=n.req.query(`limit`)?Number.parseInt(n.req.query(`limit`)):5,u=`https://mp.data258.com`,d=i?`${u}/article/category/${i}`:u,f=s((await r(d)).data),p=f(`head title`).text(),m=f(`meta[name="description"]`).attr(`content`),h=f(`ul.fly-list`),g=h&&h.length?f(h).find(`li`).toArray().map(e=>c(f(e),`h2 a`,`.fly-list-info span`)):f(`ul.jie-row li`).toArray().map(e=>c(f(e),`a.jie-title`,`.layui-hide-xs`));if(g=g.slice(0,l),await t.get(`data258:lock`,!1)===`1`)throw new e(`Another request is in progress, please try again later.`);await t.set(`data258:lock`,`1`,60);let _;for(let e of g){let n=e.link.match(/id=([\da-f]+)/)[1];e.link=e.link.startsWith(`http`)?e.link:`${u}${e.link}`;let i=await t.tryGet(`data258:${n}`,async()=>{try{await a(1e3);let t=await r.get(e.link,{headers:{Referer:d}});if(t.data.includes(`今日浏览次数已达上限`))return _=new r.RequestError(t.data,{},t.request),null;let n=s(t.data);return n(`script`).filter((e,t)=>n(t).html().includes(`location.href`)).html().match(/location\.href='([^']+)'/)[1]}catch(e){return _=e,null}});if(i)e.link=i;else break}if(await t.set(`data258:lock`,`0`,1),g=g.filter(e=>e.link.match(/^https?:\/\/mp\.weixin\.qq\.com\/s/)),g.length===0&&_)throw _;return await Promise.all(g.map(e=>o(e,!!h))),{title:p,link:d,description:m,item:g}}export{l as route};