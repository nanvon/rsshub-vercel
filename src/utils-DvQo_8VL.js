import{logger_default as e}from"./logger-B19BYg4C.js";import{ofetch_default as t}from"./ofetch-B4O0sZDE.js";import{cache_default as n}from"./cache-CjzVN0X7.js";import{parseDate as r}from"./parse-date-DHsdom8D.js";import{getCookies as i,setCookies as a}from"./puppeteer-utils-D7KW1S6W.js";import{load as o}from"cheerio";let s;const c=`https://www.cw.com.tw`,l={today:{pageUrl:()=>`/today`,limit:30},master:{pageUrl:e=>`/masterChannel.action?idMasterChannel=${e}`,limit:12},sub:{pageUrl:e=>`/subchannel.action?idSubChannel=${e}`,limit:12},author:{pageUrl:e=>`/author/${e}`,limit:10}},u=async(t,n)=>(s||(s=await n(`cw:cookie`,async()=>{let n=await t.newPage();return await n.setRequestInterception(!0),n.on(`request`,e=>{e.resourceType()===`document`||e.resourceType()===`script`?e.continue():e.abort()}),e.http(`Requesting ${c}/user/get/cookie-bar`),await n.goto(`${c}/user/get/cookie-bar`,{waitUntil:`domcontentloaded`}),s=await i(n),await n.close(),s})),s),d=async(t,r,i)=>{let s=`${c}${l[t].pageUrl(i.req.param(`channel`))}`,d=await u(r,n.tryGet),m=await r.newPage();await m.setRequestInterception(!0),m.on(`request`,e=>{e.resourceType()===`document`||e.resourceType()===`script`?e.continue():e.abort()}),await a(m,d,`cw.com.tw`),e.http(`Requesting ${s}`),await m.goto(s,{waitUntil:`domcontentloaded`}),await m.waitForSelector(`.caption`);let h=await m.evaluate(()=>document.documentElement.innerHTML);await m.close();let g=o(h),_=f(g,i.req.query(`limit`)?Number(i.req.query(`limit`)):l[t].limit),v=await p(_,r,n.tryGet);return{$:g,items:v}},f=(e,t)=>e(`.caption`).toArray().map(t=>(t=e(t),{title:t.find(`h3`).text(),link:t.find(`h3 a`).attr(`href`),pubDate:r(t.find(`time`).text())})).slice(0,t),p=(e,n,i)=>Promise.all(e.map(e=>i(e.link,async()=>{let a=await t(e.link,{headers:{Cookie:await u(n,i),"User-Agent":n.userAgent()}}),s=o(a),c=JSON.parse(s(`head script[type="application/ld+json"]`).eq(0).text());return s(`.article__head .breadcrumb, .article__head h1, .article__provideViews, .ad`).remove(),s(`img.lazyload`).each((e,t)=>{t.attribs[`data-src`]&&(t.attribs.src=t.attribs[`data-src`],delete t.attribs[`data-src`])}),e.title=s(`head title`).text(),e.category=s(`meta[name=keywords]`).attr(`content`).split(`,`),e.pubDate=r(c.datePublished),e.author=c.author.name.replace(`,`,` `)||c.publisher.name,e.description=s(`.article__head .container`).html()+s(`.article__content`).html(),e})));export{c as baseUrl,d as parsePage};