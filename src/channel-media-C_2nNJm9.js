import{config as e}from"./config-CVBRPN4O.js";import{cache_default as t}from"./cache-Dfid4xgQ.js";import{invalid_parameter_default as n}from"./invalid-parameter-B0jPSaWz.js";import{getClient as r,getDocument as i,getFilename as a,unwrapMedia as o}from"./client-x2-7XgxS.js";import{stream as s}from"hono/streaming";import{Api as c}from"telegram";import{getAppropriatedPartSize as l}from"telegram/Utils.js";import{returnBigInt as u}from"telegram/Helpers.js";function d(e){if(e.length<3||e[0]!==1)throw Error(`cannot inflate a stripped jpeg`);let t=Buffer.from([255,216,255,224,0,16,74,70,73,70,0,1,1,0,0,1,0,1,0,0,255,219,0,67,0,40,28,30,35,30,25,40,35,33,35,45,43,40,48,60,100,65,60,55,55,60,123,88,93,73,100,145,128,153,150,143,128,140,138,160,180,230,195,160,170,218,173,138,140,200,255,203,218,238,245,255,255,255,155,193,255,255,255,250,255,230,253,255,248,255,219,0,67,1,43,45,45,60,53,60,118,65,65,118,248,165,140,165,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,255,192,0,17,8,0,0,0,0,3,1,34,0,2,17,1,3,17,1,255,196,0,31,0,0,1,5,1,1,1,1,1,1,0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8,9,10,11,255,196,0,181,16,0,2,1,3,3,2,4,3,5,5,4,4,0,0,1,125,1,2,3,0,4,17,5,18,33,49,65,6,19,81,97,7,34,113,20,50,129,145,161,8,35,66,177,193,21,82,209,240,36,51,98,114,130,9,10,22,23,24,25,26,37,38,39,40,41,42,52,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,225,226,227,228,229,230,231,232,233,234,241,242,243,244,245,246,247,248,249,250,255,196,0,31,1,0,3,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,1,2,3,4,5,6,7,8,9,10,11,255,196,0,181,17,0,2,1,2,4,4,3,4,7,5,4,4,0,1,2,119,0,1,2,3,17,4,5,33,49,6,18,65,81,7,97,113,19,34,50,129,8,20,66,145,161,177,193,9,35,51,82,240,21,98,114,209,10,22,36,52,225,37,241,23,24,25,26,38,39,40,41,42,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,130,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,226,227,228,229,230,231,232,233,234,242,243,244,245,246,247,248,249,250,255,218,0,12,3,1,0,2,17,3,17,0,63,0]),n=Buffer.from([255,217]),r=Buffer.alloc(t.length+e.length+n.length);return t.copy(r),e.copy(r,t.length,3),e.copy(r,164,1,2),e.copy(r,166,2,3),n.copy(r,t.length+e.length,0),r}function f(e){return e instanceof c.PhotoStrippedSize||e instanceof c.PhotoCachedSize?e.bytes.length:e instanceof c.PhotoSize?e.size:e instanceof c.PhotoSizeProgressive?Math.max(...e.sizes):0}function p(e){return e=[...e].sort((e,t)=>f(e)-f(t)),e.pop()}async function*m(e,t){if(t.thumbs?.length??!1){let n=p(t.thumbs);n instanceof c.PhotoCachedSize||n instanceof c.PhotoStrippedSize?yield d(n.bytes):yield*h(e,t,n&&`type`in n?n.type:``);return}throw Error(`no thumbnails available`)}async function*h(e,t,n=``,r,i){let a=(t.size?l(t.size):64)*1024,o={file:new c.InputDocumentFileLocation({id:t.id,accessHash:t.accessHash,fileReference:t.fileReference,thumbSize:n}),chunkSize:a,requestSize:512*1024,dcId:t.dcId,offset:void 0,limit:void 0};r&&(o.offset=r),i&&(o.limit=i.valueOf());let s=e.iterDownload(o);yield*s,await s.close()}function g(e,t){if(!e)return[];let[r,i]=e.split(`=`);if(r!==`bytes`)throw new n(`unsupported range: ${r}`);let a=i.split(`,`).map(e=>e.trim()),o=[];for(let e of a){let n=e.split(`-`,2).filter(e=>!!e).map(e=>u(e));n.length<2&&(e.startsWith(`-`)?n.unshift(u(0)):n.push(t.subtract(u(1)))),o.push(n)}return o}async function _(n){await t.set(n.get(`cacheControlKey`),`0`,e.cache.requestTimeout),n.req.raw.headers.delete(`Accept-Encoding`)}function v(e,t){return s(e,async e=>{let n=!1;e.onAbort(()=>{n=!0});for await(let r of t){if(n)break;await e.write(r)}})}const y={path:`/media/:entityName/:messageId`,categories:[`social-media`],example:`/telegram/media/telegram/1233`,parameters:{entityName:`entity name`,messageId:`message id`},features:{requireConfig:[{name:`TELEGRAM_SESSION`,optional:!1,description:`Telegram API Authentication`}],requirePuppeteer:!1,antiCrawler:!1,supportBT:!1,supportPodcast:!1,supportScihub:!1},radar:[],name:`Channel Media`,maintainers:[`synchrone`],handler:x,description:`
::: tip
  Serves telegram media like pictures, video or files.
:::
`};async function b(e,t,n){if(e instanceof c.MessageMediaPhoto){let n=await t.downloadMedia(e);return new Response(n,{headers:{"Content-Type":`image/jpeg`}})}let r=i(e);if(r){if(`thumb`in n.req.query())return n.header(`Content-Type`,`image/jpeg`),v(n,m(t,r));n.header(`Content-Type`,r.mimeType),n.header(`Accept-Ranges`,`bytes`),n.header(`Content-Security-Policy`,`default-src 'self'; script-src 'none'`);let i=n.req.header(`Range`)??``,o=g(i,r.size);if(o.length>1)return n.text(`Not Satisfiable`,416);if(o.length===0)return n.header(`Content-Length`,r.size.toString()),!r.mimeType.startsWith(`video/`)&&!r.mimeType.startsWith(`audio/`)&&!r.mimeType.startsWith(`image/`)&&n.header(`Content-Disposition`,`attachment; filename="${encodeURIComponent(a(e))}"`),v(n,h(t,r));{let[e,i]=o[0];return n.status(206),n.header(`Content-Length`,i.subtract(e).add(1).toString()),n.header(`Content-Range`,`bytes ${e}-${i}/${r.size}`),v(n,h(t,r,``,e,i))}}return n.text(e.className,415)}async function x(e){await _(e);let t=await r(),{entityName:n,messageId:i}=e.req.param(),a=await t.getInputEntity(n),s=await t.getMessages(a,{ids:[Number(i)]}),c=await o(s[0]?.media);return c?await b(c,t,e):e.text(`Unknown media`,404)}export{_ as configureMiddlewares,b as handleMedia,x as handler,y as route,h as streamDocument,m as streamThumbnail};