import{n as e,t}from"./esm-shims-BKVRry6h.mjs";import{t as n}from"./ofetch-BRplXtiZ.mjs";import{t as r}from"./config-D7dgKYF5.mjs";import{t as i}from"./not-found-C-Horq2w.mjs";import{t as a}from"./cache-Bv3_kFbE.mjs";import{t as o}from"./parse-date-_GmTZfjS.mjs";import{t as s}from"./render-CSqLtqb8.mjs";import c from"node:path";import*as l from"cheerio";import u from"dayjs";import d from"dayjs/plugin/duration.js";import f from"p-map";import{google as p}from"googleapis";import{getSubtitles as m}from"youtube-caption-extractor";e();const h=(e,t,n)=>n.tryGet(`youtube:getPlaylistItems:${e}`,async()=>await H(n=>n.playlistItems.list({part:t,playlistId:e,maxResults:50})),r.cache.routeExpire,!1),g=(e,t,n)=>n.tryGet(`youtube:getPlaylist:${e}`,async()=>await H(n=>n.playlists.list({part:t,id:e}))),_=(e,t,n)=>n.tryGet(`youtube:getChannelWithId:${e}`,async()=>await H(n=>n.channels.list({part:t,id:e}))),v=(e,t,n)=>n.tryGet(`youtube:getChannelWithUsername:${e}`,async()=>await H(n=>n.channels.list({part:t,forUsername:e}))),y=(e,t,n)=>n.tryGet(`youtube:getVideos:${e}`,async()=>await H(n=>n.videos.list({part:t,id:e}))),b=e=>e.maxres||e.standard||e.high||e.medium||e.default,x=e=>e?.replaceAll(/\r\n|\r|\n/g,`<br>`),S=(e,n,r,i)=>s(c.join(t,`templates/description-d8937611.art`),{embed:e,videoId:n,img:r,description:i}),C=async(e,t)=>{let n=await t.get(`youtube:accessToken`,!1);return n||(n=(await U.getAccessToken()).token,await t.set(`youtube:accessToken`,n,3600)),U.setCredentials({access_token:n,refresh_token:r.youtube.refreshToken}),t.tryGet(`youtube:getSubscriptions`,()=>w(e),r.cache.routeExpire,!1)};async function w(e,t){let n=await p.youtube(`v3`).subscriptions.list({auth:U,part:e,mine:!0,maxResults:50,pageToken:t??void 0});if(n.data.nextPageToken){let t=await w(e,n.data.nextPageToken);t.data.items&&(n.data.items=[...n.data.items||[],...t.data.items])}return n}const T=e=>/^UC[\w-]{21}[AQgw]$/.test(e),E=(e,t)=>t.tryGet(`youtube:getLive:${e}`,async()=>await H(t=>t.search.list({part:`snippet`,channelId:e,eventType:`live`,type:`video`}))),D=e=>`https://www.youtube-nocookie.com/embed/${e}?controls=1&autoplay=1&mute=0`,O=(e,t=!0)=>t&&(e.startsWith(`UC`)||e.startsWith(`UU`))?`UULF`+e.slice(2):e,k=async({googleApi:e,youtubeiApi:t,params:n})=>{if(r.youtube?.key)try{return await e(n)}catch{return await t(n)}return await t(n)};var A={getPlaylistItems:h,getPlaylist:g,getChannelWithId:_,getChannelWithUsername:v,getVideos:y,getThumbnail:b,formatDescription:x,renderDescription:S,getSubscriptions:C,getSubscriptionsRecusive:w,isYouTubeChannelId:T,getLive:E,getVideoUrl:D,getPlaylistWithShortsFilter:O};function j(e,t=2){return String(e).padStart(t,`0`)}function M(e){let t=Math.floor(e*1e3),n=Math.floor(t/36e5),r=Math.floor(t%36e5/6e4),i=Math.floor(t%6e4/1e3),a=t%1e3;return`${j(n)}:${j(r)}:${j(i)},${j(a,3)}`}function N(e){return e.map((e,t)=>{let n=Number.parseFloat(e.start),r=n+Number.parseFloat(e.dur);return`${t+1}
${M(n)} --> ${M(r)}
${e.text}
`}).join(`
`)}const P=e=>a.tryGet(`youtube:getSubtitlesByVideoId:${e}`,async()=>{try{return N(await m({videoID:e}))}catch{return``}}),F=e=>`data:text/plain;charset=utf-8,${encodeURIComponent(e)}`;function I(e){return!e||e.trim()===``?[]:[{url:F(e),mime_type:`text/srt`,title:`Subtitles`}]}const L=async e=>{let t=await f(e,async e=>({videoId:e,srt:I(await P(e))}),{concurrency:5});return Object.fromEntries(t.map(({videoId:e,srt:t})=>[e,t]))},{OAuth2:R}=p.auth;u.extend(d);let z=0;const B={};if(r.youtube&&r.youtube.key){let e=r.youtube.key.split(`,`);for(let[t,n]of e.entries())n&&(B[t]=p.youtube({version:`v3`,auth:n}),z=t+1)}let V=-1;const H=async e=>{let t;for(let n=0;n<z;n++){V++;try{t=await e(B[V%z]);break}catch{}}return t};let U;r.youtube&&r.youtube.clientId&&r.youtube.clientSecret&&r.youtube.refreshToken&&(U=new R(r.youtube.clientId,r.youtube.clientSecret,`https://developers.google.com/oauthplayground`),U.setCredentials({refresh_token:r.youtube.refreshToken}));const W=async({username:e,embed:t,filterShorts:r,isJsonFeed:s})=>{let c;e.startsWith(`@`)&&(c=await a.tryGet(`youtube:handle:${e}`,async()=>{let t=await n(`https://www.youtube.com/${e}`),r=l.load(t),i=JSON.parse(r(`script`).text().match(/ytInitialData = ({.*?});/)?.[1]||`{}`).metadata.channelMetadataRenderer,o=i.externalId;return{channelName:i.title,image:i.avatar?.thumbnails?.[0]?.url,description:i.description,playlistId:(await A.getChannelWithId(o,`contentDetails`,a)).data.items[0].contentDetails.relatedPlaylists.uploads}}));let d=await(async()=>{if(c?.playlistId){let e=c.playlistId;return A.getPlaylistWithShortsFilter(e,r)}else{let t=(await A.getChannelWithUsername(e,`contentDetails`,a)).data.items;if(!t)throw new i(`The channel https://www.youtube.com/user/${e} does not exist.`);let n=t[0].id;return r?A.getPlaylistWithShortsFilter(n,r):t[0].contentDetails.relatedPlaylists.uploads}})(),f=await A.getPlaylistItems(d,`snippet`,a);if(!f)throw new i(`This channel doesn't have any content.`);let p=f.data.items.map(e=>e.snippet.resourceId.videoId),m=await A.getVideos(p.join(`,`),`contentDetails`,a),h=s?await L(p):{};return{title:`${c?.channelName||e} - YouTube`,link:e.startsWith(`@`)?`https://www.youtube.com/${e}`:`https://www.youtube.com/user/${e}`,description:c?.description||`YouTube user ${e}`,image:c?.image,item:f.data.items.filter(e=>e.snippet.title!==`Private video`&&e.snippet.title!==`Deleted video`).map(e=>{let n=e.snippet,r=n.resourceId.videoId,i=A.getThumbnail(n.thumbnails),a=m?.data.items.find(e=>e.id===r),s=h&&h[r]||[];return{title:n.title,description:A.renderDescription(t,r,i,A.formatDescription(n.description)),pubDate:o(n.publishedAt),link:`https://www.youtube.com/watch?v=${r}`,author:n.videoOwnerChannelTitle,image:i.url,attachments:[{url:D(r),mime_type:`text/html`,duration_in_seconds:a?.contentDetails.duration?u.duration(a.contentDetails.duration).asSeconds():void 0},...s]}})}},G=async({channelId:e,embed:t,filterShorts:n,isJsonFeed:r})=>{let i=n?null:(await A.getChannelWithId(e,`contentDetails`,a)).data.items[0].contentDetails.relatedPlaylists.uploads,s=n?A.getPlaylistWithShortsFilter(e):i,c=(await A.getPlaylistItems(s,`snippet`,a)).data.items,l=c.map(e=>e.snippet.resourceId.videoId),d=await A.getVideos(l.join(`,`),`contentDetails`,a),f=r?await L(l):{};return{title:`${c[0].snippet.channelTitle} - YouTube`,link:`https://www.youtube.com/channel/${e}`,description:`YouTube channel ${c[0].snippet.channelTitle}`,item:c.filter(e=>e.snippet.title!==`Private video`&&e.snippet.title!==`Deleted video`).map(e=>{let n=e.snippet,r=n.resourceId.videoId,i=A.getThumbnail(n.thumbnails),a=d?.data.items.find(e=>e.id===r),s=f&&f[r]||[];return{title:n.title,description:A.renderDescription(t,r,i,A.formatDescription(n.description)),pubDate:o(n.publishedAt),link:`https://www.youtube.com/watch?v=${r}`,author:n.videoOwnerChannelTitle,image:i.url,attachments:[{url:D(r),mime_type:`text/html`,duration_in_seconds:a?.contentDetails.duration?u.duration(a.contentDetails.duration).asSeconds():void 0},...s]}})}},K=async({playlistId:e,embed:t,isJsonFeed:n})=>{let r=(await A.getPlaylist(e,`snippet`,a)).data.items[0].snippet.title,i=(await A.getPlaylistItems(e,`snippet`,a)).data.items.filter(e=>e.snippet.title!==`Private video`&&e.snippet.title!==`Deleted video`),s=i.map(e=>e.snippet.resourceId.videoId),c=await A.getVideos(s.join(`,`),`contentDetails`,a),l=n?await L(s):{};return{title:`${r} by ${i[0].snippet.channelTitle} - YouTube`,link:`https://www.youtube.com/playlist?list=${e}`,description:`${r} by ${i[0].snippet.channelTitle}`,item:i.map(e=>{let n=e.snippet,r=n.resourceId.videoId,i=A.getThumbnail(n.thumbnails),a=c?.data.items.find(e=>e.id===r),s=l&&l[r]||[];return{title:n.title,description:A.renderDescription(t,r,i,A.formatDescription(n.description)),pubDate:o(n.publishedAt),link:`https://www.youtube.com/watch?v=${r}`,author:n.videoOwnerChannelTitle,image:i.url,attachments:[{url:D(r),mime_type:`text/html`,duration_in_seconds:a?.contentDetails.duration?u.duration(a.contentDetails.duration).asSeconds():void 0},...s]}})}};export{k as a,S as c,L as i,A as l,K as n,D as o,W as r,T as s,G as t};