import{__dirname as e,init_esm_shims as t}from"./esm-shims-BmHUa0Yk.js";import{config as n}from"./config-CVBRPN4O.js";import"./logger-BvonkID1.js";import{ofetch_default as r}from"./ofetch-DCfHHxuQ.js";import{cache_default as i}from"./cache-Dfid4xgQ.js";import{art as a}from"./render-CSnicFA3.js";import{parseDate as o}from"./parse-date-DHsdom8D.js";import{invalid_parameter_default as s}from"./invalid-parameter-B0jPSaWz.js";import{config_not_found_default as c}from"./config-not-found-mNOcOzCd.js";import{renderItems as l}from"./common-utils-DwtU3t0q.js";import u from"node:path";import{CookieJar as d}from"tough-cookie";t();const f=`https://www.instagram.com`,p=f,m=async e=>(await e.getCookieString(p)).match(/csrftoken=([^;]+)/)?.[1],h=async e=>({"sec-fetch-dest":`empty`,"sec-fetch-mode":`cors`,"sec-fetch-site":`same-origin`,"x-asbd-id":359341,"x-csrftoken":await m(e),"x-ig-app-id":936619743392459,"x-ig-www-claim":`0`}),g=async e=>(await r(`${f}/api/v1/web/fxcal/ig_sso_users/`,{headers:{"content-type":`application/x-www-form-urlencoded`,cookie:await e.getCookieString(p),...await h(e)},method:`POST`})).status===`ok`,_=async(e,t)=>{let n,a=await i.get(`instagram:getIdByUsername:${e}`),o=await i.get(`instagram:userInfo:${a}`);if(o=o&&typeof o==`string`?JSON.parse(o):o,!o)try{let o=await r.raw(`${f}/api/v1/users/web_profile_info/`,{headers:{cookie:await t.getCookieString(p),...await h(t)},query:{username:e}});if(o.url.includes(`/accounts/login/`))throw new c(`Invalid cookie`);n=o._data.data.user,a=n.id,await i.set(`instagram:getIdByUsername:${e}`,a,31536e3),await i.set(`instagram:userInfo:${a}`,n)}catch(e){throw e.message.includes(`Cookie not in this host's domain`)?new c(`Invalid cookie`):e}return o||n},v=(e,t,a)=>i.tryGet(`instagram:feed:${e}`,async()=>{let e=await r.raw(`${f}/api/v1/feed/user/${t}/username/`,{headers:{cookie:await a.getCookieString(p),...await h(a)},query:{count:30}});if(e.url.includes(`/accounts/login/`))throw new c(`Invalid cookie.
                Please also check if your account is being blocked by Instagram.`);return e._data.items},n.cache.routeExpire,!1),y=(e,t)=>i.tryGet(`instagram:tags:${e}`,async()=>(await r(`${f}/api/v1/tags/web_info/`,{headers:{cookie:await t.getCookieString(p),...await h(t)},query:{tag_name:e}})).data,n.cache.routeExpire,!1),b=t=>{let n=(t,n)=>a(u.join(e,`templates/video-fb8df18d.art`),{summary:n,image:t.display_url,video:{url:t.video_url,height:t.dimensions.height,width:t.dimensions.width}}),r=(t,n)=>a(u.join(e,`templates/images-105c7ff0.art`),{summary:n,images:[{url:t.display_url,height:t.dimensions.height,width:t.dimensions.width}]});return t.map(({node:e})=>{let t=e.__typename,i=e.edge_media_to_caption.edges[0]?.node.text??``,a=``;switch(t){case`GraphSidecar`:a=e.edge_sidecar_to_children?e.edge_sidecar_to_children.edges.map(({node:e},t)=>{let a=e.__typename;switch(a){case`GraphVideo`:return n(e,t===0?i:``);case`GraphImage`:return r(e,t===0?i:``);default:throw Error(`Instagram: Unhandled carousel type: ${a}`)}}).join(``):r(e,i);break;case`GraphVideo`:a=n(e,i);break;case`GraphImage`:a=r(e,i);break;default:throw Error(`Instagram: Unhandled feed type: ${t}`)}return{title:i.split(`
`)[0],id:e.id,pubDate:o(e.taken_at_timestamp,`X`),author:e.owner.username,link:`${f}/p/${e.shortcode}/`,summary:i,description:a}})},x={path:`/2/:category/:key`,categories:[`social-media`],example:`/instagram/2/user/stefaniejoosten`,parameters:{category:`Feed category, see table below`,key:`Username / Hashtag name`},features:{requireConfig:!1,requirePuppeteer:!1,antiCrawler:!0,supportBT:!1,supportPodcast:!1,supportScihub:!1},name:`User Profile / Hashtag`,maintainers:[`TonyRL`],handler:S,description:`::: tip
You may need to setup cookie for a less restrictive rate limit and private profiles.
:::


| User timeline | Hashtag |
| ------------- | ------- |
| user          | tags    |`};async function S(e){let t=[`user`,`tags`],{category:r,key:a}=e.req.param(),{cookie:o}=n.instagram;if(!t.includes(r))throw new s(`Such feed is not supported.`);let u=await i.get(`instagram:cookieJar`);if(u)u=d.fromJSON(u);else if(u=new d,o)for await(let e of o.split(`; `))await u.setCookie(e,p);if(o&&!await g(u))throw new c(`Invalid cookie`);let m,h,x,S,C;switch(r){case`user`:{let e=await _(a,u),t=e.biography,n=e.full_name,r=e.id,i=e.username;m=`${n} (@${i}) - Instagram`,x=t,S=e.profile_pic_url_hd??e.hd_profile_pic_url_info?.url??e.profile_pic_url,h=`${f}/${i}`,C=o?await v(r,i,u):[...e.edge_felix_video_timeline.edges,...e.edge_owner_to_timeline_media.edges];break}case`tags`:{if(!n.instagram||!n.instagram.cookie)throw new c(`Instagram RSS is disabled due to the lack of <a href="https://docs.rsshub.app/deploy/config#route-specific-configurations">relevant config</a>`);let e=a;m=`#${e} - Instagram`,h=`${f}/explore/search/keyword/?q=%23${e}`;let t=await y(e,u);S=t.profile_pic_url,C=t.top.sections.flatMap(e=>(e.feed_type===`media`?e.layout_content.medias:[...e.layout_content.one_by_two_item.clips.items,...e.layout_content.fill_items]).map(e=>e.media));break}default:break}return await i.set(`instagram:cookieJar`,u.toJSON(),31536e3),{title:m,link:h,description:x,item:o?l(C):b(C),icon:`${f}/static/images/ico/xxhdpi_launcher.png/99cf3909d459.png`,logo:S,image:S,allowEmpty:!0}}export{x as route};