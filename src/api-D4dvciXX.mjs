import{t as e}from"./config-L8Ls2W7q.mjs";import{t}from"./logger-C50fTRi5.mjs";import{t as n}from"./proxy-DJ6wHv7C.mjs";import{t as r}from"./ofetch-DXVwJZV0.mjs";import{t as i}from"./cache-ZTWfXd2T.mjs";import{t as a}from"./got-D6JCV29k.mjs";import{t as o}from"./invalid-parameter-Cn6c8J1f.mjs";import{t as s}from"./config-not-found-Zb14cUk-.mjs";import{n as c}from"./puppeteer-sUKJn9oU.mjs";import{ProxyAgent as l}from"undici";import{RateLimiterMemory as u,RateLimiterQueue as d,RateLimiterRedis as f}from"rate-limiter-flexible";import p from"node:crypto";import m from"crypto-js";import{Cookie as ee,CookieJar as h}from"tough-cookie";import g from"query-string";import _ from"oauth-1.0a";import{v5 as te}from"uuid";import{authenticator as v}from"otplib";import{CookieAgent as y,CookieClient as b}from"http-cookie-agent/undici";import{Decoder as x}from"@toondepauw/node-zstd";const S=`https://api.x.com`,C=Object.fromEntries([`/graphql/u7wQyGi6oExe8_TRWGMq4Q/UserResultByScreenNameQuery`,`/graphql/oPppcargziU1uDQHAUmH-A/UserResultByIdQuery`,`/graphql/3JNH4e9dq1BifLxAa3UMWg/UserWithProfileTweetsQueryV2`,`/graphql/8IS8MaO-2EN6GZZZb8jF0g/UserWithProfileTweetsAndRepliesQueryV2`,`/graphql/PDfFf8hGeJvUCiTyWtw4wQ/MediaTimelineV2`,`/graphql/q94uRCEn65LZThakYcPT6g/TweetDetail`,`/graphql/sITyJdhRPpvpEjg4waUmTA/TweetResultByIdQuery`,`/graphql/gkjsKepM6gl_HmFWoWKfgg/SearchTimeline`,`/graphql/iTpgCtbdxrsJfyx0cFjHqg/ListByRestId`,`/graphql/-kmqNvm5Y-cVrfvBy6docg/ListBySlug`,`/graphql/P4NpVZDqUD_7MEM84L-8nw/ListMembers`,`/graphql/BbGLL1ZfMibdFNWlk7a0Pw/ListTimeline`].map(e=>[e.split(`/`)[3].replace(/V2$|Query$|QueryV2$/,``),e])),w=JSON.stringify({android_graphql_skip_api_media_color_palette:!1,blue_business_profile_image_shape_enabled:!1,creator_subscriptions_subscription_count_enabled:!1,creator_subscriptions_tweet_preview_api_enabled:!0,freedom_of_speech_not_reach_fetch_enabled:!1,graphql_is_translatable_rweb_tweet_is_translatable_enabled:!1,hidden_profile_likes_enabled:!1,highlights_tweets_tab_ui_enabled:!1,interactive_text_enabled:!1,longform_notetweets_consumption_enabled:!0,longform_notetweets_inline_media_enabled:!1,longform_notetweets_richtext_consumption_enabled:!0,longform_notetweets_rich_text_read_enabled:!1,responsive_web_edit_tweet_api_enabled:!1,responsive_web_enhance_cards_enabled:!1,responsive_web_graphql_exclude_directive_enabled:!0,responsive_web_graphql_skip_user_profile_image_extensions_enabled:!1,responsive_web_graphql_timeline_navigation_enabled:!1,responsive_web_media_download_video_enabled:!1,responsive_web_text_conversations_enabled:!1,responsive_web_twitter_article_tweet_consumption_enabled:!1,responsive_web_twitter_blue_verified_badge_is_enabled:!0,rweb_lists_timeline_redesign_enabled:!0,spaces_2022_h2_clipping:!0,spaces_2022_h2_spaces_communities:!0,standardized_nudges_misinfo:!1,subscriptions_verification_info_enabled:!0,subscriptions_verification_info_reason_enabled:!0,subscriptions_verification_info_verified_since_enabled:!0,super_follow_badge_privacy_enabled:!1,super_follow_exclusive_tweet_notifications_enabled:!1,super_follow_tweet_api_enabled:!1,super_follow_user_api_enabled:!1,tweet_awards_web_tipping_enabled:!1,tweet_with_visibility_results_prefer_gql_limited_actions_policy_enabled:!1,tweetypie_unmention_optimization_enabled:!1,unified_cards_ad_metadata_container_dynamic_card_content_query_enabled:!1,verified_phone_label_enabled:!1,vibe_api_enabled:!1,view_counts_everywhere_api_enabled:!1}),T=`Bearer AAAAAAAAAAAAAAAAAAAAAFXzAwAAAAAAMHCxpeSDG1gLNLghVe8d74hl6k4%3DRUMF4xAQLsbeBhTSRrCiQpJtxoGWeyHrDb5te2jpGskWDFW82F`;S+``;const E=`https://api.x.com/1.1/onboarding/task.json`,D={"User-Agent":`TwitterAndroid/10.21.0-release.0 (310210000-r-0) ONEPLUS+A3010/9 (OnePlus;ONEPLUS+A3010;OnePlus;OnePlus3;0;;1;2016)`,"X-Twitter-API-Version":`5`,"X-Twitter-Client":`TwitterAndroid`,"X-Twitter-Client-Version":`10.21.0-release.0`,"OS-Version":`28`,"System-User-Agent":`Dalvik/2.1.0 (Linux; U; Android 9; ONEPLUS A3010 Build/PKQ1.181203.001)`,"X-Twitter-Active-User":`yes`,"Content-Type":`application/json`,Authorization:T},ne=new d(i.clients.redisClient?new f({points:1,duration:20,execEvenly:!0,storeClient:i.clients.redisClient}):new u({points:1,duration:20,execEvenly:!0})),O=async(e,t,n)=>await a.post(E,{headers:D,json:{flow_token:e,subtask_inputs:[Object.assign({subtask_id:t},n)]}}),k={async LoginEnterUserIdentifier({flowToken:e,username:t}){return await O(e,`LoginEnterUserIdentifier`,{enter_text:{suggestion_id:null,text:t,link:`next_link`}})},async LoginEnterPassword({flowToken:e,password:t}){return await O(e,`LoginEnterPassword`,{enter_password:{password:t,link:`next_link`}})},async LoginEnterAlternateIdentifierSubtask({flowToken:e,phoneOrEmail:t}){return await O(e,`LoginEnterAlternateIdentifierSubtask`,{enter_text:{suggestion_id:null,text:t,link:`next_link`}})},async AccountDuplicationCheck({flowToken:e}){return await O(e,`AccountDuplicationCheck`,{check_logged_in_account:{link:`AccountDuplicationCheck_false`}})},async LoginTwoFactorAuthChallenge({flowToken:e,authenticationSecret:t}){return await O(e,`LoginTwoFactorAuthChallenge`,{enter_text:{suggestion_id:null,text:v.generate(t),link:`next_link`}})}};async function re({username:e,password:n,authenticationSecret:o,phoneOrEmail:s}){return await i.tryGet(`twitter:authentication:${e}`,async()=>{try{await ne.removeTokens(1),t.debug(`Twitter login start.`),D[`X-Twitter-Client-DeviceID`]=te(e,`d41d092b-b007-48f7-9129-e9538d2d8fe9`);let i=p.randomUUID().replaceAll(`-`,``),c=await a(`https://api.x.com/1.1/guest/activate.json`,{headers:{authorization:T,"x-csrf-token":i,cookie:`ct0=`+i},method:`POST`});t.debug(`Twitter login: guest token`),D[`x-guest-token`]=c.data.guest_token;let l=await r.raw(E+`?`+new URLSearchParams({flow_name:`login`,api_version:`1`,known_device_token:``,sim_country_code:`us`}).toString(),{method:`POST`,headers:D,body:{flow_token:null,input_flow_data:{country_code:null,flow_context:{referrer_context:{referral_details:`utm_source=google-play&utm_medium=organic`,referrer_url:``},start_location:{location:`deeplink`}},requested_variant:null,target_user_id:0}}}).then(({headers:e,_data:t})=>(D.att=e.get(`att`),{data:t}));t.debug(`Twitter login flow start.`);let u=async({data:r})=>{let{subtask_id:i,open_account:a}=r.subtasks.shift();if(a)return a;if(!(i in k)){t.error(`Twitter login flow task failed: unknown subtask: ${i}`);return}return l=await k[i]({flowToken:r.flow_token,username:e,password:n,authenticationSecret:o,phoneOrEmail:s}),t.debug(`Twitter login flow task finished: subtask: ${i}.`),await u(l)},d=await u(l);return t.debug(`Twitter login flow finished.`),d?t.debug(`Twitter login success.`,d):t.error(`Twitter login failed. ${JSON.stringify(l.data?.subtasks,null,2)}`),d}catch(n){t.error(`Twitter username ${e} login failed:`,n)}},3600*24*30,!1)}var ie=re;let ae=0;async function oe(){let t;if(e.twitter.username&&e.twitter.password){let n=ae++%e.twitter.username.length,r=e.twitter.username[n],i=e.twitter.password[n],a=e.twitter.authenticationSecret?.[n],o=e.twitter.phoneOrEmail?.[n];if(r&&i){let e=await ie({username:r,password:i,authenticationSecret:a,phoneOrEmail:o});if(!e)throw new s(`Invalid twitter configs: ${r}`);t={key:e.oauth_token,secret:e.oauth_token_secret,cacheKey:`twitter:authentication:${r}`}}}else throw new s(`Invalid twitter configs`);return t}const A=async(e,t)=>{let n=await oe(),a=new _({consumer:{key:`3nVuSoBZnx6U4vzUxf5w`,secret:`Bcs59EFbbsdF6Sl9Ng71smgStWEGwXXKSjYvPVt7qys`},signature_method:`HMAC-SHA1`,hash_function:(e,t)=>m.HmacSHA1(e,t).toString(m.enc.Base64)}),o={url:`${e}?${g.stringify(t)}`,method:`GET`,headers:{connection:`keep-alive`,"content-type":`application/json`,"x-twitter-active-user":`yes`,authority:`api.x.com`,"accept-encoding":`gzip`,"accept-language":`en-US,en;q=0.9`,accept:`*/*`,DNT:`1`}},s=await r.raw(o.url,{headers:a.toHeader(a.authorize(o,n))});return s.status===401&&i.globalCache.set(n.cacheKey,``),s._data},j=async(e,t,n,r)=>{let{data:i}=await A(S+e,{variables:JSON.stringify({...n,rest_id:t}),features:w}),a;if(r){a=i;for(let e of r)a=a[e];a=a.instructions}else a=i.user_result.result.timeline_response.timeline.instructions;return a.find(e=>e.__typename===`TimelineAddEntries`||e.type===`TimelineAddEntries`).entries},se=(e,t={})=>j(C.UserWithProfileTweets,e,{...t,withQuickPromoteEligibilityTweetFields:!0}),ce=(e,t={})=>j(C.UserWithProfileTweetsAndReplies,e,{...t,count:20}),le=(e,t={})=>j(C.MediaTimeline,e,t),ue=(e,t={})=>j(C.SearchTimeline,null,{...t,rawQuery:e,count:20,product:`Latest`,withDownvotePerspective:!1,withReactionsMetadata:!1,withReactionsPerspective:!1},[`search_by_raw_query`,`search_timeline`,`timeline`]),de=(e,t)=>j(C.TweetDetail,e,{...t,includeHasBirdwatchNotes:!1,includePromotedContent:!1,withBirdwatchNotes:!1,withVoice:!1,withV2Timeline:!0},[`threaded_conversation_with_injections_v2`]),fe=(e,t={})=>j(C.ListTimeline,e,{...t},[`list`,`timeline_response`,`timeline`]);function M(e,t,n){let r=[],i=[];for(let n of e){let e=n.entryId;e&&(e.startsWith(`tweet-`)&&i.push(n),t&&t.some(t=>e.startsWith(t))&&i.push(...n.content.items))}for(let e of i)if(e.entryId){let t=e.content||e.item,i=t?.content?.tweetResult?.result||t?.itemContent?.tweet_results?.result;if(i&&i.tweet&&(i=i.tweet),i){let e=i.legacy?.retweeted_status_result?.result;for(let t of[i,e]){if(!t?.legacy)continue;t.legacy.user=t.core?.user_result?.result?.legacy||t.core?.user_results?.result?.legacy,t.legacy.id_str=t.rest_id;let e=t.quoted_status_result?.result;if(e&&(t.legacy.quoted_status=e.legacy,t.legacy.quoted_status.user=e.core.user_result?.result?.legacy||e.core.user_results?.result?.legacy),t.note_tweet){let e=t.note_tweet.note_tweet_results.result;t.legacy.entities.hashtags=e.entity_set.hashtags,t.legacy.entities.symbols=e.entity_set.symbols,t.legacy.entities.urls=e.entity_set.urls,t.legacy.entities.user_mentions=e.entity_set.user_mentions,t.legacy.full_text=e.text}}let t=i.legacy;t&&(e&&(t.retweeted_status=e.legacy),(n===void 0||t.user_id_str===n+``)&&r.push(t))}}return r}const pe=async(e,t={})=>M(await se(e,t)),me=async(e,t={})=>M(await ce(e,t),[`profile-conversation-`],e),he=async(e,t={})=>M(await le(e,t)),ge=async(e,t={})=>M(await de(e,t),[`homeConversation-`,`conversationthread-`]),_e=async(e,t={})=>M(await fe(e,t)),ve=function(e){let t=[];for(let n of e)n.retweeted_status||t.push(n);return t},ye=e=>A(`${S}${C.UserResultByScreenName}`,{variables:`{"screen_name":"${e}","withHighlightedLabel":true}`,features:w}),be=e=>A(`${S}${C.UserByRestId}`,{variables:`{"userId":"${e}","withHighlightedLabel":true}`,features:w}),xe=e=>e.startsWith(`+`)?be(e.slice(1)):ye(e),N=e=>i.tryGet(`twitter-userdata-${e}`,()=>xe(e)),P=async e=>{let t=await N(e);return(t.data?.user||t.data?.user_result)?.result?.rest_id},Se=async e=>{let t=await N(e);return(t.data?.user||t.data?.user_result)?.result?.legacy},F=async(t,n,r)=>{let a=await P(t);if(a===void 0)throw new o(`User not found`);let s=r.name,c=JSON.stringify(n);return i.tryGet(`twitter:${a}:${s}:${c}`,()=>r(a,n),e.cache.routeExpire,!1)},Ce=(e,t={})=>F(e,t,pe),we=async(e,n={})=>{let r=[],a=await P(e);await Promise.all([Ce,I,L].map(async i=>{try{r.push(...await i(e,n))}catch(n){t.warn(`Failed to get tweets for ${e} with ${i.name}: ${n}`)}}));let o=`twitter:user:tweets-cache:${a}`,s=await i.get(o);s&&(s=JSON.parse(s),s&&s.length&&(r=[...s,...r]));let c=new Set;return r=r.filter(e=>!e.in_reply_to_user_id_str||e.in_reply_to_user_id_str===a).map(e=>{let t=e.id_str||e.conversation_id_str;return!c.has(t)&&c.add(t)&&e}).filter(Boolean).toSorted((e,t)=>(t.id_str||t.conversation_id_str)-(e.id_str||e.conversation_id_str)).slice(0,20),i.set(o,JSON.stringify(r)),r},I=(e,t={})=>F(e,t,me),L=(e,t={})=>F(e,t,he);var Te={getUser:Se,getUserTweets:we,getUserTweetsAndReplies:I,getUserMedia:L,excludeRetweet:ve,getSearch:async(e,t={})=>M(await ue(e,t)),getList:(t,n={})=>i.tryGet(`twitter:${t}:getListById:${JSON.stringify(n)}`,()=>_e(t,n),e.cache.routeExpire,!1),getUserTweet:(e,t)=>F(e,t,ge),init:()=>void 0};const R=`https://x.com/i/api`,z=Object.fromEntries([`/graphql/E3opETHurmVJflFsUBVuUQ/UserTweets`,`/graphql/Yka-W8dz7RaEuQNkroPkYw/UserByScreenName`,`/graphql/HJFjzBgCs16TqxewQOeLNg/HomeTimeline`,`/graphql/DiTkXJgLqBBxCs7zaYsbtA/HomeLatestTimeline`,`/graphql/bt4TKuFz4T7Ckk-VvQVSow/UserTweetsAndReplies`,`/graphql/dexO_2tohK86JDudXXG3Yw/UserMedia`,`/graphql/Qw77dDjp9xCpUY-AXwt-yQ/UserByRestId`,`/graphql/UN1i3zUiCWa-6r-Uaho4fw/SearchTimeline`,`/graphql/Pa45JvqZuKcW1plybfgBlQ/ListLatestTweetsTimeline`,`/graphql/QuBlQ6SxNAQCt6-kBiCXCQ/TweetDetail`].map(e=>[e.split(`/`)[3].replace(/V2$|Query$|QueryV2$/,``),e])),Ee=[`UserByScreenName`,`UserByRestId`,`UserTweets`,`UserTweetsAndReplies`,`ListLatestTweetsTimeline`,`SearchTimeline`],B={hidden_profile_subscriptions_enabled:!0,rweb_tipjar_consumption_enabled:!0,responsive_web_graphql_exclude_directive_enabled:!0,verified_phone_label_enabled:!1,subscriptions_verification_info_is_identity_verified_enabled:!0,subscriptions_verification_info_verified_since_enabled:!0,highlights_tweets_tab_ui_enabled:!0,responsive_web_twitter_article_notes_tab_enabled:!0,subscriptions_feature_can_gift_premium:!0,creator_subscriptions_tweet_preview_api_enabled:!0,responsive_web_graphql_skip_user_profile_image_extensions_enabled:!1,responsive_web_graphql_timeline_navigation_enabled:!0},V={rweb_tipjar_consumption_enabled:!0,responsive_web_graphql_exclude_directive_enabled:!0,verified_phone_label_enabled:!1,creator_subscriptions_tweet_preview_api_enabled:!0,responsive_web_graphql_timeline_navigation_enabled:!0,responsive_web_graphql_skip_user_profile_image_extensions_enabled:!1,communities_web_enable_tweet_community_results_fetch:!0,c9s_tweet_anatomy_moderator_badge_enabled:!0,articles_preview_enabled:!0,responsive_web_edit_tweet_api_enabled:!0,graphql_is_translatable_rweb_tweet_is_translatable_enabled:!0,view_counts_everywhere_api_enabled:!0,longform_notetweets_consumption_enabled:!0,responsive_web_twitter_article_tweet_consumption_enabled:!0,tweet_awards_web_tipping_enabled:!1,creator_subscriptions_quote_tweet_preview_enabled:!1,freedom_of_speech_not_reach_fetch_enabled:!0,standardized_nudges_misinfo:!0,tweet_with_visibility_results_prefer_gql_limited_actions_policy_enabled:!0,rweb_video_timestamps_enabled:!0,longform_notetweets_rich_text_read_enabled:!0,longform_notetweets_inline_media_enabled:!0,responsive_web_enhance_cards_enabled:!1},H={rweb_tipjar_consumption_enabled:!0,responsive_web_graphql_exclude_directive_enabled:!0,verified_phone_label_enabled:!1,creator_subscriptions_tweet_preview_api_enabled:!0,responsive_web_graphql_timeline_navigation_enabled:!0,responsive_web_graphql_skip_user_profile_image_extensions_enabled:!1,communities_web_enable_tweet_community_results_fetch:!0,c9s_tweet_anatomy_moderator_badge_enabled:!0,articles_preview_enabled:!0,responsive_web_edit_tweet_api_enabled:!0,graphql_is_translatable_rweb_tweet_is_translatable_enabled:!0,view_counts_everywhere_api_enabled:!0,longform_notetweets_consumption_enabled:!0,responsive_web_twitter_article_tweet_consumption_enabled:!0,tweet_awards_web_tipping_enabled:!1,creator_subscriptions_quote_tweet_preview_enabled:!1,freedom_of_speech_not_reach_fetch_enabled:!0,standardized_nudges_misinfo:!0,tweet_with_visibility_results_prefer_gql_limited_actions_policy_enabled:!0,rweb_video_timestamps_enabled:!0,longform_notetweets_rich_text_read_enabled:!0,longform_notetweets_inline_media_enabled:!0,responsive_web_enhance_cards_enabled:!1},U={UserByScreenName:B,UserByRestId:B,UserTweets:V,UserTweetsAndReplies:V,UserMedia:V,SearchTimeline:V,ListLatestTweetsTimeline:V,HomeTimeline:V,HomeLatestTimeline:H,TweetDetail:H,Likes:V},De=new d(i.clients.redisClient?new f({points:1,duration:20,execEvenly:!0,storeClient:i.clients.redisClient}):new u({points:1,duration:20,execEvenly:!0}));async function Oe({username:e,password:n,authenticationSecret:r}){if(!(!e||!n))try{await De.removeTokens(1);let i=new h,a=await c(),o=await a.newPage();if(await o.goto(`https://x.com/i/flow/login`),await o.waitForSelector(`input[autocomplete="username"]`),await o.type(`input[autocomplete="username"]`,e),await(await o.$$(`button`))[3]?.click(),await o.waitForSelector(`input[autocomplete="current-password"]`),await o.type(`input[autocomplete="current-password"]`,n),(await o.waitForSelector(`button[data-testid="LoginForm_Login_Button"]`))?.click(),r){await o.waitForSelector(`input[inputmode="numeric"]`);let e=v.generate(r);await o.type(`input[inputmode="numeric"]`,e),(await o.waitForSelector(`button[data-testid="ocfEnterTextNextButton"]`))?.click()}let s=await new Promise(n=>{o.on(`response`,async r=>{if(r.url().includes(`/HomeTimeline`)){(await r.json())?.data?.home?.home_timeline_urt?.instructions?.[0]?.entries?.[0]?.entryId===`messageprompt-suspended-prompt`&&(t.error(`twitter debug: twitter username ${e} login failed: messageprompt-suspended-prompt`),n(``));let a=await o.cookies();for(let e of a)i.setCookieSync(`${e.name}=${e.value}`,`https://x.com`);t.debug(`twitter debug: twitter username ${e} login success`),n(JSON.stringify(i.serializeSync()))}})});return await a.close(),s}catch(n){t.error(`twitter debug: twitter username ${e} login failed:`,n)}}var W=Oe;const ke=new x;let Ae=0;const je=async(t,n)=>{let i=await r.raw(`${e.twitter.thirdPartyApi}${z[t]}`,{method:`GET`,params:n,responseType:`arrayBuffer`}),a=i.headers.get(`content-encoding`)?.toLowerCase()??``,o=Buffer.from(i._data);return a.includes(`zstd`)&&(o=await ke.decode(o)),JSON.parse(o.toString(`utf-8`))},Me=async e=>{let t=await i.get(`twitter:cookie:${e}`);if(t)return t;let a=new h;await a.setCookie(`auth_token=${e}`,`https://x.com`);try{let t=n.proxyUri?new l({factory:(e,t)=>new b(e,{...t,cookies:{jar:a}}),uri:n.proxyUri}):new y({cookies:{jar:a}});if(e)await r(`https://x.com`,{dispatcher:t});else{let e=(await r(`https://x.com/narendramodi?mx=2`,{dispatcher:t})).match(/document\.cookie="gt=(\d+)/)?.[1];e&&a.setCookieSync(`gt=${e}`,`https://x.com`)}let o=JSON.stringify(a.serializeSync());return i.set(`twitter:cookie:${e}`,o),o}catch{return``}},G=`twitter:lock-token1:`,K=async n=>{if(e.twitter.authToken&&n>0){let r=Ae++%e.twitter.authToken.length,a=e.twitter.authToken[r];return await i.get(`${G}${a}`,!1)?(t.debug(`twitter debug: twitter cookie for token ${a} is locked, retry: ${n}`),await new Promise(e=>setTimeout(e,Math.random()*500+500)),await K(n-1)):(t.debug(`twitter debug: lock twitter cookie for token ${a}`),await i.set(`${G}${a}`,`1`,20),{token:a,username:e.twitter.username?.[r],password:e.twitter.password?.[r],authenticationSecret:e.twitter.authenticationSecret?.[r]})}},q=async(a,o,c)=>{let u=await K(30);if(!u&&!c?.allowNoAuth)throw new s(`No valid Twitter token found`);let d=`${a}?${g.stringify(o)}`,f=await Me(u?.token);!f&&u&&(f=await W({username:u.username,password:u.password,authenticationSecret:u.authenticationSecret}));let p;if(f){t.debug(`twitter debug: got twitter cookie for token ${u?.token}`),typeof f==`string`&&(f=JSON.parse(f));let e=h.deserializeSync(f),r=n.proxyUri?new l({factory:(t,n)=>new b(t,{...n,cookies:{jar:e}}),uri:n.proxyUri}):new y({cookies:{jar:e}});n.proxyUri&&t.debug(`twitter debug: Proxying request: ${d}`),p={jar:e,agent:r}}else if(u)throw new s(`Twitter cookie for token ${u?.token?.replace(/(\w{8})(\w+)/,(e,t,n)=>t+`*`.repeat(n.length))} is not valid`);let m=p?Object.fromEntries(p.jar.getCookieStringSync(a).split(`;`).map(e=>ee.parse(e)?.toJSON()).map(e=>[e?.key,e?.value])):{},_=await r.raw(d,{retry:0,headers:{authority:`x.com`,accept:`*/*`,"accept-language":`en-US,en;q=0.9`,authorization:`Bearer AAAAAAAAAAAAAAAAAAAAANRILgAAAAAAnNwIzUejRCOuH5E6I8xnZz4puTs%3D1Zv7ttfk8LF81IUq16cHjhLTvJu4FA33AGWWjCpTnA`,"cache-control":`no-cache`,"content-type":`application/json`,dnt:`1`,pragma:`no-cache`,referer:`https://x.com/`,"x-twitter-active-user":`yes`,"x-twitter-client-language":`en`,"x-csrf-token":m.ct0,...u?.token?{"x-twitter-auth-type":`OAuth2Session`}:{"x-guest-token":m.gt}},dispatcher:p?.agent,onResponse:async({response:n})=>{let r=n.headers.get(`x-rate-limit-remaining`),a=Number.parseInt(r||`0`),o=n.headers.get(`x-rate-limit-reset`);if(t.debug(`twitter debug: twitter rate limit remaining for token ${u?.token} is ${r} and reset at ${o}, auth: ${JSON.stringify(u)}, status: ${n.status}, data: ${JSON.stringify(n._data?.data)}, cookie: ${JSON.stringify(p?.jar.serializeSync())}`),u)if(r&&a<2&&o){let e=(new Date(Number.parseInt(o)*1e3).getTime()-Date.now())/1e3;t.debug(`twitter debug: twitter rate limit exceeded for token ${u.token} with status ${n.status}, will unlock after ${e}s`),await i.set(`${G}${u.token}`,`1`,Math.ceil(e)*2)}else if(n.status===429||JSON.stringify(n._data?.data)===`{"user":{}}`)t.debug(`twitter debug: twitter rate limit exceeded for token ${u.token} with status ${n.status}`),await i.set(`${G}${u.token}`,`1`,2e3);else if(n.status===403||n.status===401){let r=await W({username:u.username,password:u.password,authenticationSecret:u.authenticationSecret});if(r)t.debug(`twitter debug: reset twitter cookie for token ${u.token}, ${r}`),await i.set(`twitter:cookie:${u.token}`,r,e.cache.contentExpire),t.debug(`twitter debug: unlock twitter cookie for token ${u.token} with error1`),await i.set(`${G}${u.token}`,``,1);else{let r=e.twitter.authToken?.indexOf(u.token);if(r!==void 0&&r!==-1&&e.twitter.authToken?.splice(r,1),u.username){let t=e.twitter.username?.indexOf(u.username);t!==void 0&&t!==-1&&e.twitter.username?.splice(t,1)}if(u.password){let t=e.twitter.password?.indexOf(u.password);t!==void 0&&t!==-1&&e.twitter.password?.splice(t,1)}t.debug(`twitter debug: delete twitter cookie for token ${u.token} with status ${n.status}, remaining tokens: ${e.twitter.authToken?.length}`),await i.set(`${G}${u.token}`,`1`,3600)}}else t.debug(`twitter debug: unlock twitter cookie with success for token ${u.token}`),await i.set(`${G}${u.token}`,``,1)}});return u?.token&&(t.debug(`twitter debug: update twitter cookie for token ${u.token}`),await i.set(`twitter:cookie:${u.token}`,JSON.stringify(p?.jar.serializeSync()),e.cache.contentExpire)),_._data},J=async(n,r,i,a)=>{let o={variables:JSON.stringify({...i,userId:r}),features:JSON.stringify(U[n])},s=(e=>{if(a){let t=e;for(let e of a)t=t[e];return t.instructions}let n=e?.user?.result,r=(n?.timeline?.timeline||n?.timeline?.timeline_v2||n?.timeline_v2?.timeline)?.instructions;return r||t.debug(`twitter debug: instructions not found in data: ${JSON.stringify(e)}`),r})(await(async()=>{if(e.twitter.thirdPartyApi&&Ee.includes(n))return(await je(n,o)).data;let{data:t}=await q(R+z[n],o);return t})());if(!s)return[];let c=s.find(e=>e.type===`TimelineAddToModule`)?.moduleItems,l=s.find(e=>e.type===`TimelineAddEntries`)?.entries;return c||l||[]};function Y(e,t,n){let r=[],i=[];for(let n of e){let e=n.entryId;e&&((e.startsWith(`tweet-`)||e.startsWith(`profile-grid-0-tweet-`))&&i.push(n),t&&t.some(t=>e.startsWith(t))&&i.push(...n.content.items))}for(let e of i)if(e.entryId){let t=e.content||e.item,i=t?.content?.tweetResult?.result||t?.itemContent?.tweet_results?.result;if(i&&i.tweet&&(i=i.tweet),i){let e=i.legacy?.retweeted_status_result?.result;for(let t of[i,e]){if(!t?.legacy)continue;if(t.legacy.user=t.core?.user_result?.result?.legacy||t.core?.user_results?.result?.legacy,t.legacy.user&&t.core?.user_results?.result?.core){let e=t.core.user_results.result.core;e.name&&(t.legacy.user.name=e.name),e.screen_name&&(t.legacy.user.screen_name=e.screen_name)}t.legacy.id_str=t.rest_id;let e=t.quoted_status_result?.result?.tweet||t.quoted_status_result?.result;if(e&&(t.legacy.quoted_status=e.legacy,t.legacy.quoted_status.user=e.core.user_result?.result?.legacy||e.core.user_results?.result?.legacy,t.legacy.quoted_status.user&&e.core?.user_results?.result?.core)){let n=e.core.user_results.result.core;n.name&&(t.legacy.quoted_status.user.name=n.name),n.screen_name&&(t.legacy.quoted_status.user.screen_name=n.screen_name)}if(t.note_tweet){let e=t.note_tweet.note_tweet_results.result;t.legacy.entities.hashtags=e.entity_set.hashtags,t.legacy.entities.symbols=e.entity_set.symbols,t.legacy.entities.urls=e.entity_set.urls,t.legacy.entities.user_mentions=e.entity_set.user_mentions,t.legacy.full_text=e.text}}let t=i.legacy;t&&(e&&(t.retweeted_status=e.legacy),(n===void 0||t.user_id_str===n+``)&&r.push(t))}}return r}const Ne=new x,X=async(t,n)=>{let i=await r.raw(`${e.twitter.thirdPartyApi}${t}`,{method:`GET`,params:n,responseType:`arrayBuffer`}),a=i.headers.get(`content-encoding`)?.toLowerCase()??``,o=Buffer.from(i._data);return a.includes(`zstd`)&&(o=await Ne.decode(o)),JSON.parse(o.toString(`utf-8`))},Z=t=>i.tryGet(`twitter-userdata-${t}`,()=>{let n={variables:t.startsWith(`+`)?JSON.stringify({userId:t.slice(1),withSafetyModeUserFields:!0}):JSON.stringify({screen_name:t,withSafetyModeUserFields:!0}),features:JSON.stringify(t.startsWith(`+`)?U.UserByRestId:U.UserByScreenName),fieldToggles:JSON.stringify({withAuxiliaryUserLabels:!1})};return e.twitter.thirdPartyApi?X(t.startsWith(`+`)?z.UserByRestId:z.UserByScreenName,n):q(`${R}${t.startsWith(`+`)?z.UserByRestId:z.UserByScreenName}`,n,{allowNoAuth:!t.startsWith(`+`)})}),Q=async(t,n,r)=>{let a=await Z(t),s=(a.data?.user||a.data?.user_result)?.result?.rest_id;if(s===void 0)throw i.set(`twitter-userdata-${t}`,``,e.cache.contentExpire),new o(`User not found`);let c=r.name,l=JSON.stringify(n);return i.tryGet(`twitter:${s}:${c}:${l}`,()=>r(s,n),e.cache.routeExpire,!1)};var Pe={getUser:async e=>{let t=await Z(e);return{profile_image_url:t.data?.user?.result?.avatar?.image_url,...t.data?.user?.result?.core,...(t.data?.user||t.data?.user_result)?.result?.legacy}},getUserTweets:(e,t)=>Q(e,t,async(e,t={})=>Y(await J(`UserTweets`,e,{...t,count:20,includePromotedContent:!0,withQuickPromoteEligibilityTweetFields:!0,withVoice:!0,withV2Timeline:!0}))),getUserTweetsAndReplies:(e,t)=>Q(e,t,async(e,t={})=>Y(await J(`UserTweetsAndReplies`,e,{...t,count:20,includePromotedContent:!0,withCommunity:!0,withVoice:!0,withV2Timeline:!0}),[`profile-conversation-`],e)),getUserMedia:(e,t)=>Q(e,t,async(e,t={})=>{let n=(await J(`UserMedia`,e,{...t,count:20,includePromotedContent:!1,withClientEventToken:!1,withBirdwatchNotes:!1,withVoice:!0,withV2Timeline:!0})).find(e=>e.content?.cursorType===`Top`).content.value;return Y(await J(`UserMedia`,e,{...t,cursor:n,count:20,includePromotedContent:!1,withClientEventToken:!1,withBirdwatchNotes:!1,withVoice:!0,withV2Timeline:!0}))}),getUserLikes:(e,t)=>Q(e,t,async(e,t={})=>Y(await J(`Likes`,e,{...t,includeHasBirdwatchNotes:!1,includePromotedContent:!1,withBirdwatchNotes:!1,withVoice:!1,withV2Timeline:!0}))),getUserTweet:(e,t)=>Q(e,t,async(e,t={})=>Y(await J(`TweetDetail`,e,{...t,includeHasBirdwatchNotes:!1,includePromotedContent:!1,withBirdwatchNotes:!1,withVoice:!1,withV2Timeline:!0},[`threaded_conversation_with_injections_v2`]),[`homeConversation-`,`conversationthread-`])),getSearch:async(e,t)=>Y(await J(`SearchTimeline`,void 0,{...t,rawQuery:e,count:20,querySource:`typed_query`,product:`Latest`},[`search_by_raw_query`,`search_timeline`,`timeline`])),getList:async(e,t)=>Y(await J(`ListLatestTweetsTimeline`,void 0,{...t,listId:e,count:20},[`list`,`tweets_timeline`,`timeline`])),getHomeTimeline:async(e,t)=>Y(await J(`HomeTimeline`,void 0,{...t,count:20,includePromotedContent:!0,latestControlAvailable:!0,requestContext:`launch`,withCommunity:!0},[`home`,`home_timeline_urt`])),getHomeLatestTimeline:async(e,t)=>Y(await J(`HomeLatestTimeline`,void 0,{...t,count:20,includePromotedContent:!0,latestControlAvailable:!0,requestContext:`launch`,withCommunity:!0},[`home`,`home_timeline_urt`])),init:()=>{}};const Fe=e.twitter.thirdPartyApi,Ie=e.twitter.username&&e.twitter.password,Le=e.twitter.authToken;let $={init:()=>{throw new s(`Twitter API is not configured`)},getUser:()=>null,getUserTweets:()=>null,getUserTweetsAndReplies:()=>null,getUserMedia:()=>null,getUserLikes:()=>null,getUserTweet:()=>null,getSearch:()=>null,getList:()=>null,getHomeTimeline:()=>null,getHomeLatestTimeline:()=>null};Fe||Le?$=Pe:Ie&&($=Te);var Re=$;export{Re as t};