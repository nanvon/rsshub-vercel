import{n as e,t}from"./esm-shims-CaZMYoY8.js";import"./config-DZMnNPig.js";import"./logger-asV68Lay.js";import"./ofetch-VsB2Peor.js";import"./helpers-Cqaav28H.js";import{t as n}from"./render-d6AVTUl2.js";import{t as r}from"./parse-date-CHEO0z5G.js";import{r as i}from"./common-utils-CWmDr7en.js";import{t as a}from"./got-BVCqvF6m.js";import{t as o}from"./timezone-BPfwRbwD.js";import s from"node:path";import c from"dayjs";import{load as l}from"cheerio";e();const u=`https://www.dlsite.com`,d={show_type:1,show_layout:1,per_page:100},f=(e,t)=>c(e).format(t),p=(e,t)=>{let n=Object.keys(t),r=n.map(e=>`/${e}/${t[e]}`).join(``),i=e.replaceAll(new RegExp(String.raw`(/${n.join(String.raw`/\w+|/`)}/\w+)`,`g`),``);return`${i}${/=/.test(i)?``:`/=`}${r}`},m=e=>{let t=e.match(/(\d{4}).*(\d{2}).*(\d{2})/);return t?r(`${t[1]}-${t[2]}-${t[3]}`,`YYYY-MM-DD`):r(e.split(`:`).pop().trim(),`MMM/DD/YYYY`)},h=async e=>(await a({method:`get`,url:`${u}/home-touch/product/info/ajax?product_id=${e}`})).data,g=async e=>{n.defaults.imports.formatDate=f;let g=i(e)===`/`?`/home/new`:i(e),_=e.req.query(`limit`)?Number.parseInt(e.req.query(`limit`)):100,v=`${u}${p(g,d)}`,y=l((await a({method:`get`,url:v})).data),b=y(`dt.work_name`).slice(0,_),x=y(`.work_update`).length===0?void 0:m(y(`.work_update`).text()),S=await h(b.toArray().map(e=>y(e).find(`a`).attr(`href`).match(/_id\/(.*?)\.html/)[1]).join(`,`)),C=b.toArray().map(e=>{e=y(e).parentsUntil(`tbody, ul`);let i=e.find(`.work_name a`),a=i.text(),l=i.attr(`href`),u=l.match(/_id\/(.*?)\.html/)[1],d=e.find(`.work_text`).text(),f=e.find(`.maker_name a`).toArray().map(e=>({name:y(e).text(),link:y(e).attr(`href`)})),p=e.find(`div[data-samples]`).length===0?[]:JSON.parse(e.find(`div[data-samples]`).attr(`data-samples`).replaceAll(`'`,`"`)).map(e=>e.thumb),m=e.find(`.work_category`).find(`a`).toArray().map(e=>({text:y(e).text(),link:y(e).attr(`href`)})),h=e.find(`.work_genre`).find(`span[title]`).toArray().map(e=>({text:y(e).text()})),g=e.find(`.search_tag`).find(`a`).toArray().map(e=>({text:y(e).text(),link:y(e).attr(`href`)})),_=e.find(`.icon_wrap`).find(`span[title]`).toArray().map(e=>({text:y(e).text()})),v=S[u],b=o(r(v.regist_date),9),C=v.discount_rate,w=v.discount_end_date?o(r(v.discount_end_date,`MM/DD HH:mm`),9):void 0;return p=p.length===0?[v.work_image]:p,{title:`${C?`${C}% OFF
                        ${` ${w?`${c(w).format(`YYYY-MM-DD HH:mm`)} まで`:``}`}`:` `}${a}`,link:l,pubDate:b,author:f.map(e=>e.name).join(` / `),category:[...m.map(e=>e.text),...h.map(e=>e.text),...g.map(e=>e.text),..._.map(e=>e.text)],guid:`dlsite-${u}`,description:n(s.join(t,`templates/description-3ff6e827.art`),{detail:v,images:p,authors:f,discountRate:C,discountEndDate:w,updatedDate:x,pubDate:b,workCategories:m,workGenres:h,searchTags:g,description:d})}});return{title:y(`title`).text(),description:y(`meta[name="description"]`).attr(`content`),link:v,item:C,allowEmpty:!0}},_={path:`*`,name:`Unknown`,maintainers:[],handler:v,features:{nsfw:!0}};async function v(e){return await g(e)}export{_ as route};