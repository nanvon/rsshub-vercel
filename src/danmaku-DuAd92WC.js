import"./esm-shims-CMsyBHYK.js";import"./config-DZMnNPig.js";import"./logger-asV68Lay.js";import"./proxy-CczVputb.js";import"./ofetch-CRUPiVpr.js";import"./helpers-Cqaav28H.js";import"./cache-CpEhLexq.js";import"./render-d6AVTUl2.js";import"./md5-CWsm3r0H.js";import{t as e}from"./got-BlqYKpVp.js";import"./puppeteer-e0F06Yyi.js";import"./utils-D6xGxHzG.js";import{t}from"./cache-B1p5HdOj.js";import n from"node:zlib";import{load as r}from"cheerio";const i=e=>{let t=Number.parseInt(e),n=t%60,r=(t-n)/60%60;return`${(t-n-60*r)/3600}:${r.toString().padStart(2,`0`)}:${n.toString().padStart(2,`0`)}`},a={path:`/video/danmaku/:bvid/:pid?`,categories:[`social-media`],example:`/bilibili/video/danmaku/BV1vA411b7ip/1`,parameters:{bvid:`视频AV号,可在视频页 URL 中找到`,pid:`分P号,不填默认为1`},features:{requireConfig:!1,requirePuppeteer:!1,antiCrawler:!1,supportBT:!1,supportPodcast:!1,supportScihub:!1},name:`视频弹幕`,maintainers:[`Qixingchen`],handler:o};async function o(a){let o=a.req.param(`bvid`),s;o.startsWith(`BV`)||(s=o,o=null);let c=Number(a.req.param(`pid`)||1),l=await t.getCidFromId(s,c,o),u=await t.getVideoNameFromId(s,o),d=`https://www.bilibili.com/video/${o||`av${s}`}`,f=(await e.get(`https://comment.bilibili.com/${l}.xml`,{decompress:!1,responseType:`buffer`,headers:{Referer:d}})).body;f=await((f[0]&15)==8?n.inflateSync(f):n.inflateRawSync(f));let p=[],m=r(f,{xmlMode:!0});return m(`d`).each((e,t)=>{p.push({p:m(t).attr(`p`),text:m(t).text()})}),p=p.toReversed().slice(0,50),{title:`${u} 的 弹幕动态`,link:d,description:`${u} 的 弹幕动态`,item:p.map(e=>({title:`[${i(e.p.split(`,`)[0])}] ${e.text}`,pubDate:new Date(e.p.split(`,`)[4]*1e3).toUTCString(),guid:`${l}-${e.p.split(`,`)[4]}-${e.p.split(`,`)[7]}`,link:d}))}}export{a as route};