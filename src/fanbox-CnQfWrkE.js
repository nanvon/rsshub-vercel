import{__dirname as e,init_esm_shims as t}from"./esm-shims-DE2PJqdr.js";import{config as n}from"./config-CVBRPN4O.js";import"./logger-BvonkID1.js";import{ofetch_default as r}from"./ofetch-CJF2SF6b.js";import{cache_default as i}from"./cache-Dfid4xgQ.js";import{art as a}from"./render-CSnicFA3.js";import{parseDate as o}from"./parse-date-DHsdom8D.js";import{invalid_parameter_default as s}from"./invalid-parameter-B0jPSaWz.js";import{isValidHost as c}from"./valid-host-C5HGyJZ_.js";import l from"node:path";t();function u(){let e=n.fanbox.session;return{origin:`https://fanbox.cc`,cookie:e?`FANBOXSESSID=${e}`:``}}function d(t){switch(t.type){case`html`:return t.html;case`fanbox.post`:return a(l.join(e,`templates/fanbox-post-12425d7b.art`),{postUrl:`https://${t.postInfo.creatorId}.fanbox.cc/posts/${t.postInfo.id}`,title:t.postInfo.title,user:t.postInfo.user,excerpt:t.postInfo.excerpt});default:return``}}function f(e){let t=[...e.text];return e.styles&&e.styles.map(e=>{switch(e.type){case`bold`:t[e.offset]=`<b>`+t[e.offset],t[e.offset+e.length-1]+=`</b>`;break;default:}return e}),e.links&&e.links.map(e=>(t[e.offset]=`<a href="${e.url}">`+t[e.offset],t[e.offset+e.length-1]+=`</a>`,e)),t.join(``)}function p(e){return e.text||``}function m(e){let t=e.text||``;for(let n of e.images)t+=`<hr><img src="${n.originalUrl}">`;return t}function h(e){let t=e.text||``;for(let n of e.files)t+=`<br><a href="${n.url}" download="${n.name}.${n.extension}">${n.name}.${n.extension}</a>`;return t}async function g(e){let t=``;switch(e.video.serviceProvider){case`soundcloud`:t+=await b(e.video.videoId);break;case`youtube`:t+=`<iframe src="https://www.youtube-nocookie.com/embed/${e.video.videoId}" frameborder="0"></iframe>`;break;case`vimeo`:t+=`<iframe src="https://player.vimeo.com/video/${e.video.videoId}" frameborder="0"></iframe>`;break;default:}return t+=`<br>${e.text}`,t}async function _(e){let t=[];for(let n=0;n<e.blocks.length;++n){let r=e.blocks[n];switch(t.push(`<p>`),r.type){case`p`:t.push(f(r));break;case`header`:t.push(`<h2>${r.text}</h2>`);break;case`image`:{let n=e.imageMap[r.imageId];t.push(`<img src="${n.originalUrl}">`);break}case`file`:{let n=e.fileMap[r.fileId];t.push(`<a href="${n.url}" download="${n.name}.${n.extension}">${n.name}.${n.extension}</a>`);break}case`url_embed`:t.push(d(e.urlEmbedMap[r.urlEmbedId]));break;default:}}return t=await Promise.all(t),t.join(``)}async function v(e){let t=``;if(e.feeRequired!==0&&(t+=`Fee Required: <b>${e.feeRequired} JPY/month</b><hr>`),e.coverImageUrl&&(t+=`<img src="${e.coverImageUrl}"><hr>`),!e.body)return t+=e.excerpt,t;switch(e.type){case`text`:t+=p(e.body);break;case`file`:t+=h(e.body);break;case`image`:t+=m(e.body);break;case`video`:t+=await g(e.body);break;case`article`:t+=await _(e.body);break;default:t+=`<b>Unsupported content (RSSHub)</b>`}return t}function y(e){return i.tryGet(`fanbox-${e.id}-${e.updatedDatetime}`,async()=>{let t=await r(`https://api.fanbox.cc/post.info?postId=${e.id}`,{headers:{...u(),"User-Agent":n.trueUA}});return{title:e.title||`No title`,description:await v(t.body),pubDate:o(e.updatedDatetime),link:`https://${e.creatorId}.fanbox.cc/posts/${e.id}`,category:e.tags}})}async function b(e){let t=`https://soundcloud.com/${e}`,n=`https://soundcloud.com/oembed?url=${encodeURIComponent(t)}&format=json&maxheight=400&format=json`;return(await r(n)).html}const x={path:`/:creator`,categories:[`social-media`],example:`/fanbox/official`,parameters:{creator:`fanbox user name`},maintainers:[`KarasuShin`],name:`Creator`,handler:S,features:{requireConfig:[{name:`FANBOX_SESSION_ID`,description:`Required for private posts. Can be found in browser DevTools -> Application -> Cookies -> https://www.fanbox.cc -> FANBOXSESSID`,optional:!0}],nsfw:!0}};async function S(e){let t=e.req.param(`creator`);if(!c(t))throw new s(`Invalid user name`);let n=`Fanbox - ${t}`,i,a;try{let e=`https://api.fanbox.cc/creator.get?creatorId=${t}`,o=await r(e,{headers:u()});n=`Fanbox - ${o.body.user.name}`,i=o.body.description,a=o.body.user.iconUrl}catch{}let o=await r(`https://api.fanbox.cc/post.listCreator?creatorId=${t}&limit=20`,{headers:u()}),l=await Promise.all(o.body.map(e=>y(e)));return{title:n,link:`https://${t}.fanbox.cc`,description:i,image:a,item:l}}export{x as route};