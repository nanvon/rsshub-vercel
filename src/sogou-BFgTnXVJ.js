import"./esm-shims-Dqvxr0BZ.js";import"./config-BL2l-VlN.js";import{logger_default as e}from"./logger-DWogN5HJ.js";import{ofetch_default as t}from"./ofetch-e4r9n7lx.js";import"./cache-BjesfGXD.js";import{parseDate as n}from"./parse-date-DHsdom8D.js";import{finishArticleItem as r}from"./wechat-mp-DCQ8hEM6.js";import{load as i}from"cheerio";const a=`https://weixin.sogou.com`,o=`SNUID=78725B470A0EF2C3F97AA5EB0BBF95C1; ABTEST=0|1680917938|v1; SUID=8F7B1C682B83A20A000000006430C5B2; PHPSESSID=le2lak0vghad5c98ijd3t51ls4; IPLOC=USUS5`;async function s(r){let s=`${a}/weixin`,c;try{c={data:await t(s,{query:{ie:`utf8`,s_from:`input`,_sug_:`n`,_sug_type_:`1`,type:`2`,query:r,page:`1`},headers:{Referer:a,Cookie:o}})}}catch(t){return e.error(`Failed to fetch Sogou search for ${r}: ${t instanceof Error?t.message:String(t)}`),[]}let l=i(c.data),u=l(`ul.news-list > li`).toArray().map(async i=>{let c=l(i),u=c.find(`h3 > a`).text().trim(),d=c.find(`h3 > a`).attr(`href`);if(!d)return e.warn(`Skipping item with missing link for wechatId: ${r}`),null;let f=a+d,p=c.find(`p.txt-info`).text().trim(),m=c.find(`span.s2 script`).html()?.match(/timeConvert\('(\d+)'\)/),h=m?n(Number.parseInt(m[1])*1e3):void 0,g=f;try{let n=(await t.raw(f,{headers:{Referer:s,Cookie:o},redirect:`manual`,ignoreResponseError:!0})).headers?.get(`location`);if(n){if(!n.startsWith(`http`))try{n=new URL(n,f).toString()}catch(t){e.warn(`Invalid redirect location "${n}" for title "${u}" (wechatId: ${r}): ${t instanceof Error?t.message:String(t)}`),n=null}if(typeof n==`string`&&n)if(n.startsWith(`http://mp.weixin.qq.com`)||n.startsWith(`https://mp.weixin.qq.com`))g=n;else try{let e=(await t.raw(n,{headers:{Referer:f,Cookie:o},redirect:`manual`,ignoreResponseError:!0})).headers?.get(`location`);e&&(e.startsWith(`http://mp.weixin.qq.com`)||e.startsWith(`https://mp.weixin.qq.com`))&&(g=e)}catch(t){e.warn(`Failed to resolve intermediate redirect for title "${u}" (wechatId: ${r}): ${t instanceof Error?t.message:String(t)}`)}}else e.debug(`No redirect location found for title "${u}" (wechatId: ${r})`)}catch(t){let n=t instanceof Error?t.message:String(t);typeof t==`object`&&t&&`response`in t&&typeof t.response==`object`&&t.response!==null&&`status`in t.response?e.debug(`Redirect request failed for "${u}" (wechatId: ${r}) with status ${t.response.status}: ${n}`):e.debug(`Redirect request failed for "${u}" (wechatId: ${r}): ${n}`)}let _=g.startsWith(`http://mp.weixin.qq.com`)||g.startsWith(`https://mp.weixin.qq.com`),v=c.find(`span.all-time-y2`).text().trim();return{title:u,link:g,description:p,author:v,pubDate:h,guid:g,_internal:{isWeChatLink:_}}});return(await Promise.all(u)).filter(e=>e!==null)}const c={path:`/sogou/:id`,categories:[`new-media`],example:`/wechat/sogou/qimao0908`,parameters:{id:`公众号 id, 打开 weixin.sogou.com 并搜索相应公众号， 在 URL 中找到 id`},features:{requireConfig:!1,requirePuppeteer:!1,antiCrawler:!0,supportBT:!1,supportPodcast:!1,supportScihub:!1},name:`公众号（搜狗来源）`,maintainers:[`EthanWng97`,`pseudoyu`],handler:l};async function l(t){let n=t.req.param(`id`),i=await s(n),o=i[0]?.author||n,c=i.map(async t=>{let n=t;if(t._internal.isWeChatLink)try{n=await r(t)}catch(n){e.debug(`finishArticleItem failed for ${t.link}: ${n instanceof Error?n.message:String(n)}`)}return n&&typeof n==`object`?{title:n.title,link:n.link,description:n.description,author:n.author,pubDate:n.pubDate,guid:n.guid,...n.content&&{content:n.content}}:(e.debug(`Unexpected null or non-object item during final processing for link: ${t?.link}`),null)}),l=(await Promise.all(c)).filter(e=>e!==null);return{title:`${o} 的微信公众号`,link:`${a}/weixin?query=${n}`,description:`${o} 的微信公众号`,item:l}}export{c as route};