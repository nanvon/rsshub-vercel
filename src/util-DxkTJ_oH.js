import{__dirname as e,init_esm_shims as t}from"./esm-shims-BGJi2y--.js";import{logger_default as n}from"./logger-BvonkID1.js";import{ofetch_default as r}from"./ofetch-DqHh1IN2.js";import{art as i}from"./render-CSnicFA3.js";import{parseDate as a}from"./parse-date-DHsdom8D.js";import o from"node:path";import{Buffer as s}from"node:buffer";import c from"node:crypto";t();const l=`https://api.mercari.jp/`,u=`${l}v2/entities:search`,d=`${l}items/get`,f=`${l}v1/marketplaces/shops/products/`,p=()=>c.randomUUID(),m={default:``,onsale:`STATUS_ON_SALE`,soldout:`STATUS_SOLD_OUT`},h={default:`SORT_DEFAULT`,create_time:`SORT_CREATED_TIME`,like:`SORT_NUM_LIKES`,score:`SORT_SCORE`,price:`SORT_PRICE`},g={desc:`ORDER_DESC`,asc:`ORDER_ASC`};function _(e){return e.toString(`base64`).replaceAll(`+`,`-`).replaceAll(`/`,`_`).replaceAll(`=`,``)}function v(e){return _(s.from(e,`utf-8`))}function y(e){let t=e.export({format:`jwk`});return{crv:`P-256`,kty:`EC`,x:t.x,y:t.y}}function b(e){return{typ:`dpop+jwt`,alg:`ES256`,jwk:y(e)}}function x(e){let t=0;if(e[t++]!==48)throw Error(`Invalid DER signature`);let n=S(e,t);if(t+=n.bytesRead,e[t++]!==2)throw Error(`Expected INTEGER for R`);let r=S(e,t);t+=r.bytesRead;let i=e.subarray(t,t+r.length);if(t+=r.length,e[t++]!==2)throw Error(`Expected INTEGER for S`);let a=S(e,t);t+=a.bytesRead;let o=e.subarray(t,t+a.length);if(t+=a.length,t!==e.length)throw Error(`Extra bytes in DER signature`);return{r:C(i,32),s:C(o,32)}}function S(e,t){let n=e[t];if(n<128)return{length:n,bytesRead:1};let r=n&127;if(r>4)throw Error(`DER length too long`);let i=0;for(let n=0;n<r;n++)i=i<<8|e[t+1+n];return{length:i,bytesRead:1+r}}function C(e,t){if(e.length>t){let n=e.length-t;return e.subarray(n)}return e.length<t?s.concat([Uint8Array.from(s.alloc(t-e.length)),Uint8Array.from(e)]):e}function w({uuid:e,method:t,url:n}){let{privateKey:r,publicKey:i}=c.generateKeyPairSync(`ec`,{namedCurve:`prime256v1`}),a={iat:Math.floor(Date.now()/1e3),jti:e,htu:n,htm:t.toUpperCase()},o=b(i),l=v(JSON.stringify(o)),u=v(JSON.stringify(a)),d=`${l}.${u}`,f=c.createSign(`SHA256`);f.update(d);let p=f.sign(r),{r:m,s:h}=x(p),g=_(s.concat([Uint8Array.from(m),Uint8Array.from(h)]));return`${d}.${g}`}const T=async(e,t,n=`POST`)=>{let i=w({uuid:p(),method:n,url:e}),a=new Headers({DPOP:i,"X-Platform":`web`,"Accept-Encoding":`gzip, deflate`,"Content-Type":`application/json; charset=utf-8`}),o={method:n,headers:a,body:n===`POST`?JSON.stringify(t):void 0,query:n===`GET`?t:void 0};try{return await r(e,o)}catch(e){throw Error(`API request failed: ${e}`)}},E=e=>e===0?``:`v1:${e}`,D=async(e,t,r,i,a={})=>{let o={userId:`MERCARI_BOT_${p()}`,pageSize:120,pageToken:E(0),searchSessionId:p(),indexRouting:`INDEX_ROUTING_UNSPECIFIED`,thumbnailTypes:[],searchCondition:{keyword:i,excludeKeyword:a.excludeKeyword||``,sort:e,order:t,status:r||[],sizeId:[],categoryId:a.categoryId||[],brandId:a.brandId||[],sellerId:[],priceMin:a.priceMin||0,priceMax:a.priceMax||0,itemConditionId:a.itemConditionId||[],shippingPayerId:[],shippingFromArea:[],shippingMethod:[],colorId:[],hasCoupon:!1,attributes:a.attributes||[],itemTypes:a.itemTypes||[],skuIds:[],shopIds:[],excludeShippingMethodIds:[]},serviceFrom:`suruga`,withItemBrand:!0,withItemSize:!1,withItemPromotions:!0,withItemSizes:!0,withShopname:!1,useDynamicAttribute:!0,withSuggestedItems:!0,withOfferPricePromotion:!0,withProductSuggest:!0,withParentProducts:!1,withProductArticles:!0,withSearchConditionId:!0,withAuction:!0};return n.debug(JSON.stringify(o)),await T(u,o,`POST`)},O=(e,t,n)=>t===`ITEM_TYPE_BEYOND`?T(f+e,{view:`FULL`,imageType:`JPEG`},`GET`):T(d,{id:e,country_code:n,include_item_attributes:!0,include_product_page_component:!0,include_non_ui_item_attributes:!0,include_donation:!0,include_offer_like_coupon_display:!0,include_offer_coupon_display:!0,include_item_attributes_sections:!0,include_auction:!1},`GET`),k=t=>{if(t.displayName){let n=t;return{title:n.displayName,description:i(o.join(e,`templates/shopItem-d63f5360.art`),n),pubDate:a(n.createTime),guid:n.name,link:`https://jp.mercari.com/shops/product/${n.name}`,image:n.thumbnail,language:`ja`,author:n.productDetail.shop.displayName,updated:a(n.updateTime)}}let n=t;return{title:n.data.name,description:i(o.join(e,`templates/item-fb30dd01.art`),n),pubDate:a(n.data.created*1e3),guid:n.data.id,link:`https://jp.mercari.com/item/${n.data.id}`,image:n.data.thumbnails[0],language:`ja`,author:n.data.seller.name,updated:a(n.data.updated*1e3)}};export{g as MercariOrder,h as MercariSort,m as MercariStatus,O as fetchItemDetail,D as fetchSearchItems,k as formatItemDetail};