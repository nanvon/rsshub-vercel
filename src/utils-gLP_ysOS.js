import{__dirname as e,init_esm_shims as t}from"./esm-shims-Dqvxr0BZ.js";import{ofetch_default as n}from"./ofetch-e4r9n7lx.js";import{cache_default as r}from"./cache-BjesfGXD.js";import{art as i}from"./render-CSnicFA3.js";import{parseDate as a}from"./parse-date-DHsdom8D.js";import{got_default as o}from"./got-DF7DsGgk.js";import s from"node:path";import{load as c}from"cheerio";import{destr as l}from"destr";t();const u=`https://www.bloomberg.com/feeds`,d={accept:`application/json`,"cache-control":`no-cache`,referer:`https://www.bloomberg.com`},f={articles:{url:`https://www.bloomberg.com/article/api/story/slug/`},features:{url:`https://www.bloomberg.com/article/api/story/slug/`},audio:{url:`https://www.bloomberg.com/news/audio/`,sel:`script#__NEXT_DATA__`},videos:{url:`https://www.bloomberg.com/news/videos/`,sel:`script`},newsletters:{url:`https://www.bloomberg.com/article/api/story/slug/`},"photo-essays":{url:`https://www.bloomberg.com/javelin/api/photo-essay_transporter/`,sel:`script[type = "application/json"][data-component-props]`},"features/":{url:`https://www.bloomberg.com/features/`,sel:`script[id^="article-info"][type="application/json"], script[class^="article-info"][type="application/json"], script#dvz-config`,prop:`id`}},p=[/\/(?<page>[\w-]*?)\/(?<link>\d{4}-\d{2}-\d{2}\/.*)/,/(?<!news|politics)\/(?<page>features\/|graphics\/)(?<link>.*)/],m=/<p>|<\/p>/g,h=/<p\b[^>]*>(&nbsp;|\s)<\/p>/g,g=e=>n.raw(e,{headers:d,parseResponse:e=>({data:l(e),body:e})}),_=async(e,t)=>{let n=await o(e),r=c(n.data,{xml:{xmlMode:!0}});return r(`urlset url`).toArray().slice(0,t.req.query(`limit`)?Number.parseInt(t.req.query(`limit`)):50).map(e=>(e=r(e),{title:e.find(String.raw`news\:title`).text(),link:e.find(`loc`).text(),pubDate:a(e.find(String.raw`news\:publication_date`).text())}))},v=e=>r.tryGet(e.link,async()=>{let t=p.map(t=>t.exec(e.link)).filter(e=>e&&e.groups).map(e=>e&&e.groups)[0];if(t){let{page:n,link:r}=t;if(f[n]){let t={...f[n]},i;try{let e=`${t.url}${r}`;i=await g(e)}catch(t){if(t.name&&(t.name===`HTTPError`||t.name===`RequestError`||t.name===`FetchError`))try{i=await g(e.link)}catch{return{title:e.title,link:e.link,pubDate:e.pubDate}}}if(i.redirected&&new URL(i.url).pathname===`/tosv2.html`||i.status===404)return{title:e.title,link:e.link,pubDate:e.pubDate};switch(n){case`audio`:return y(i._data,t,e);case`videos`:return b(i._data,t,e);case`photo-essays`:return x(i._data,t,e);case`features/`:return S(i._data,t,e);default:return C(i._data.data,e)}}}return e}),y=async(e,t,n)=>{let r=JSON.parse(c(e.data)(t.sel).html()).props.pageProps,i=r.episode;return{title:i.title||n.title,link:r.pageInfo.canonicalUrl||n.link,guid:`bloomberg:${i.id}`,description:(await E(i.articleBody,r)).replaceAll(h,``),pubDate:a(i.publishedAt)||n.pubDate,author:r.hero.showTitle,media:{content:{url:i.image},thumbnails:{url:i.image}},enclosure_type:`audio/mpeg`,enclosure_url:i.url,itunes_item_image:i.image||r.pageInfo.image.url}},b=async(t,n,r)=>{let o=c(t.data),l=o(n.sel).filter((e,t)=>o(t).text().includes(`__PRELOADED_STATE__`)).text().trim().match(/window\.__PRELOADED_STATE__ = (.*?);/)?.[1],u=JSON.parse(l||`{}`),d=u.video?.videoStory??u.quicktakeVideo?.videoStory;if(d){let t=await D(d.video.bmmrId,d.summary.html.replaceAll(h,``));return{title:d.headline.text||r.title,link:d.url||r.link,guid:`bloomberg:${d.id}`,description:i(s.join(e,`templates/video_media-86c5e7ff.art`),t),pubDate:a(d.publishedAt)||r.pubDate,media:{content:{url:d.video?.thumbnail.url||``},thumbnails:{url:d.video?.thumbnail.url||``}},category:t.keywords??[]}}return r},x=async(e,t,n)=>{let r=c(e.data.html),i={};for(let e of r(t.sel).toArray())Object.assign(i,JSON.parse(r(e).html()));return{title:i.headline||n.title,link:i.canonical||n.link,guid:`bloomberg:${i.id}`,description:(await E(i.body,i)).replaceAll(h,``),pubDate:n.pubDate,author:i.authors?.map(e=>e.name).join(`, `)??[]}},S=async(e,t,n)=>{let r=c(e.data)(t.sel).text().trim(),i=JSON.parse(r)[t.prop];try{let e=await g(`https://www.bloomberg.com/article/api/story/id/${i}`);return await C(e._data,n)}catch(e){if(e.name&&(e.name===`HTTPError`||e.name===`RequestError`||e.name===`FetchError`))return{title:n.title,link:n.link,pubDate:n.pubDate}}},C=async(e,t)=>{let n=e.ledeImageUrl||Object.values(e.imageAttachments??{})[0]?.url;return{title:e.headline||t.title,link:e.url||t.link,guid:`bloomberg:${e.id}`,description:w(e)+await T(e)+await M(e.body||``),pubDate:a(e.publishedAt)||t.pubDate,author:e.authors?.map(e=>e.name).join(`, `)??[],category:e.mostRelevantTags??[],media:{content:{url:n},thumbnails:{url:n}}}},w=e=>{let t=e.dek||e.summary||e.headline||``,n=e.abstract?.map(e=>`<li>${e}</li>`).join(``);return n?t+`<ul>${n}</ul>`:t},T=async t=>{if(t.ledeMediaKind){let n=t.ledeMediaKind,r={kind:t.ledeMediaKind,caption:t.ledeCaption?.replaceAll(m,``)??``,description:t.ledeDescription?.replaceAll(m,``)??``,credit:t.ledeCredit?.replaceAll(m,``)??``,src:t.ledeImageUrl,video:n===`video`&&await D(t.ledeAttachment.bmmrId)};return i(s.join(e,`templates/lede_media-39081938.art`),{media:r})}else if(t.lede){let n=t.lede,r={src:n.url,alt:n.alt||n.title,caption:n.caption?.replaceAll(m,``)??``,credit:n.credit?.replaceAll(m,``)??``};return i(s.join(e,`templates/image_figure-1ba8d11c.art`),r)}else if(t.imageAttachments){let n=Object.values(t.imageAttachments)[0];if(n){let t={src:n.baseUrl||n.url,alt:n.alt||n.title,caption:n.caption?.replaceAll(m,``)??``,credit:n.credit?.replaceAll(m,``)??``};return i(s.join(e,`templates/image_figure-1ba8d11c.art`),t)}return``}else if(t.type===`Lede`){let n=t.props,r={kind:n.media,caption:n.caption?.replaceAll(m,``)??``,description:n.dek?.replaceAll(m,``)??``,credit:n.credit?.replaceAll(m,``)??``,src:n.url};return i(s.join(e,`templates/lede_media-39081938.art`),{media:r})}},E=async(t,n)=>{let r=[`meta`,`script`,`*[class$="-footnotes"]`,`*[class$="for-you"]`,`*[class$="-newsletter"]`,`*[class$="page-ad"]`,`*[class$="-recirc"]`,`*[data-ad-placeholder="Advertisement"]`],a=c(t);for(let e of r)a(e).remove();a(`.paywall`).removeAttr(`class`);for await(let t of a(`figure`)){let r=a(t).data(`image-type`),o=a(t).data(`type`),c=``;if(r===`audio`){let r={};if(n.audios){let e=n.audios.find(e=>e.id.toString()===a(t).data(`id`).toString());r={img:e.image?.url||a(t).find(`img`).attr(`src`),src:e.url||a(t).find(`audio source`).attr(`src`),caption:a(t).find(`[class$="text"]`).html()?.trim()??``,credit:a(t).find(`[class$="credit"]`).html()?.trim()??``}}if(n.episode){let e=n.episode;r={src:e.url,img:e.image||n.pageInfo.image.url,caption:e.description||(a(t).find(`[class$="text"]`).html()?.trim()??``),credit:(e.credits.map(e=>e.name).join(`, `)??[])||(a(t).find(`[class$="credit"]`).html()?.trim()??``)}}c=i(s.join(e,`templates/audio_media-302de55e.art`),r)}else if(r===`video`){if(n.videoAttachments){let r=n.videoAttachments[a(t).data(`id`)],o=await D(r.bmmrId);c=i(s.join(e,`templates/video_media-86c5e7ff.art`),o)}}else if(r===`photo`||r===`image`||o===`image`){let r,o;if(n.imageAttachments){let e=n.imageAttachments[a(t).data(`id`)];o=e?.alt||a(t).find(`img`).attr(`alt`)?.trim(),r=e?.baseUrl}else o=a(t).find(`img`).attr(`alt`).trim(),r=a(t).find(`img`).data(`native-src`);let l=a(t).find(`[class$="text"], .caption, .photo-essay__text`).html()?.trim()??``,u=a(t).find(`[class$="credit"], .credit, .photo-essay__source`).html()?.trim()??``,d={src:r,alt:o,caption:l,credit:u};c=i(s.join(e,`templates/image_figure-1ba8d11c.art`),d)}a(c).insertAfter(t),a(t).remove()}return a.html()},D=async(e,t)=>{let n=`https://www.bloomberg.com/multimedia/api/embed?id=${e}`,r=await g(n);if(r.redirected&&new URL(r.url).pathname===`/tosv2.html`||r.status===404)return{stream:``,mp4:``,coverUrl:``,caption:t};if(r._data.data){let e=r._data.data;return{stream:e.streams?e.streams[0]?.url:``,mp4:e.downloadURLs?e.downloadURLs[600]:``,coverUrl:e.thumbnail?.baseUrl??``,caption:e.description||e.title||t}}return{stream:``,mp4:``,coverUrl:``,caption:t}},O={paragraph:async(e,t)=>`<p>${await t(e.content)}</p>`,text:e=>{let{attributes:t,value:n}=e;return t?.emphasis&&t?.strong?`<strong><em>${n}</em></strong>`:t?.emphasis?`<em>${n}</em>`:t?.strong?`<strong>${n}</strong>`:n},"inline-newsletter":async(e,t)=>`<div>${await t(e.content)}</div>`,"inline-recirc":async(e,t)=>`<div>${await t(e.content)}</div>`,heading:async(e,t)=>{let n=e.data;if(n.level===2||n.level===3)return`<h3>${await t(e.content)}</h3>`},link:async(e,t)=>{let n=e.data.destination,r=n.web,i=n.bbg,a=e.data.title;return r?`<a href="${r}" title="${a}" target="_blank">${await t(e.content)}</a>`:i&&i.startsWith(`bbg://news/stories`)?`<a href="${`https://www.bloomberg.com/news/terminal/${i.split(`bbg://news/stories/`).pop()}`}" title="${a}" target="_blank">${await t(e.content)}</a>`:String(await t(e.content))},entity:async(e,t)=>{let n=e.subType,r=e.data.link.destination.web;if(n===`person`)return t(e.content);if(n===`story`)return r?`<a href="${r}" target="_blank">${await t(e.content)}</a>`:`<a href="${`https://www.bloomberg.com/news/terminal/${e.data.story.identifiers.suid}`}" target="_blank">${await t(e.content)}</a>`;if(n===`security`){let n=e.data.security.identifiers.parsekey;if(n){let r=n.split(` `);return`<a href="${[...`https://www.bloomberg.com/quote/${r[0]}:`,r[1]]}" target="_blank">${await t(e.content)}</a>`}}return t(e.content)},br:()=>`<br/>`,hr:()=>`<br/>`,ad:()=>{},blockquote:async(e,t)=>`<blockquote>${await t(e.content)}</blockquote>`,quote:async(e,t)=>`<blockquote>${await t(e.content)}</blockquote>`,aside:async(e,t)=>`<aside>${await t(e.content)}</aside>`,list:async(e,t)=>{let n=e.subType;if(n===`unordered`)return`<ul>${await t(e.content)}</ul>`;if(n===`ordered`)return`<ol>${await t(e.content)}</ol>`},listItem:async(e,t)=>`<li>${await t(e.content)}</li>`,media:async t=>{let n=t.subType;if(n===`chart`&&t.data.attachment){if(t.data.attachment.creator===`TOASTER`){let n=t.data.chart,r={src:n&&n.fallback||``,chart:t.data.attachment,id:n&&n.id||``,alt:n&&n.alt||``},a=r.chart,o={source:a.source,footnote:a.footnote,url:a.url,title:a.title,subtitle:a.subtitle,chartId:`toaster-chart-${r.id}`,chartAlt:r.alt,fallback:r.src};return i(s.join(e,`templates/chart_media-e91db148.art`),{chart:o})}let n={alt:t.data.attachment?.footnote||``,caption:t.data.attachment?.title+t.data.attachment.subtitle||``,credit:t.data.attachment?.source||``,src:t.data.chart?.fallback||``};return i(s.join(e,`templates/image_figure-1ba8d11c.art`),n)}if(n===`photo`){let n=t.data,r=``;if(n.attachment){let t={src:n.photo?.src,alt:n.photo?.alt,caption:n.photo?.caption,credit:n.photo?.credit};r=i(s.join(e,`templates/image_figure-1ba8d11c.art`),t)}return n.link&&n.link.destination&&n.link.destination.web?`<a href="${n.link.destination.web}" target="_blank">${r}</a>`:r}if(n===`video`){let n=t.data,r=n.attachment?.id;if(r){let t=await D(r,n.attachment?.title);return i(s.join(e,`templates/video_media-86c5e7ff.art`),t)}}if(n===`audio`&&t.data.attachment){let n=t.data.attachment,r=n.title,a=n.url,o=n.image;if(r&&a){let t={src:a,img:o.url,caption:r,credit:``};return i(s.join(e,`templates/audio_media-302de55e.art`),t)}}return``},tabularData:async(e,t)=>`<table>${await t(e.content)}</table>`,columns:e=>`<tr>${e.data.definitions.map(e=>({title:e.title,span:e.colSpan||1,type:e.dataType})).map(e=>`<th colspan=${e.span}>${e.title}</th>`)}</tr>`,row:async(e,t)=>`<tr>${await t(e.content)}</tr>`,cell:async(e,t)=>`<td data-coltype=${{"news-rsf-table-number":`number`,"news-rsf-table-string":`text`}[e.data.class]||`text`} colspan=${e.data.colspan}>${await t(e.content)}</td>`},k=async e=>await j(e),A=async(e,t)=>!e.type||!O[e.type]?`<node>${e.type}</node>`:await O[e.type](e,k,t),j=async e=>(await Promise.all(e.map(async(t,n)=>await A(t,{index:n,prev:e[n-1]?.type,next:e[n+1]?.type})))).join(``),M=async e=>!e||!e.content?``:await j(e.content);export{v as parseArticle,_ as parseNewsList,u as rootUrl};