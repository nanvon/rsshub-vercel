import{__dirname as e,init_esm_shims as t}from"./esm-shims-BFmOnnpb.js";import{config as n}from"./config-CVBRPN4O.js";import{ofetch_default as r}from"./ofetch-am9EnuPq.js";import{cache_default as i}from"./cache-Dfid4xgQ.js";import{art as a}from"./render-CSnicFA3.js";import{parseDate as o}from"./parse-date-DHsdom8D.js";import{not_found_default as s}from"./not-found-o393tAVF.js";import c from"node:path";import l from"dayjs";import u from"dayjs/plugin/duration.js";import*as d from"cheerio";import f from"p-map";import{google as p}from"googleapis";import{getSubtitles as m}from"youtube-caption-extractor";function h(e,t=2){return String(e).padStart(t,`0`)}function g(e){let t=Math.floor(e*1e3),n=Math.floor(t/36e5),r=Math.floor(t%36e5/6e4),i=Math.floor(t%6e4/1e3),a=t%1e3;return`${h(n)}:${h(r)}:${h(i)},${h(a,3)}`}function _(e){return e.map((e,t)=>{let n=Number.parseFloat(e.start),r=n+Number.parseFloat(e.dur);return`${t+1}
${g(n)} --> ${g(r)}
${e.text}
`}).join(`
`)}const v=e=>i.tryGet(`youtube:getSubtitlesByVideoId:${e}`,async()=>{try{let t=await m({videoID:e});return _(t)}catch{return``}}),y=e=>`data:text/plain;charset=utf-8,${encodeURIComponent(e)}`;function b(e){return!e||e.trim()===``?[]:[{url:y(e),mime_type:`text/srt`,title:`Subtitles`}]}const x=async e=>{let t=await f(e,async e=>{let t=await v(e);return{videoId:e,srt:b(t)}},{concurrency:5});return Object.fromEntries(t.map(({videoId:e,srt:t})=>[e,t]))},{OAuth2:S}=p.auth;l.extend(u);let C=0;const w={};if(n.youtube&&n.youtube.key){let e=n.youtube.key.split(`,`);for(let[t,n]of e.entries())n&&(w[t]=p.youtube({version:`v3`,auth:n}),C=t+1)}let T=-1;const E=async e=>{let t;for(let n=0;n<C;n++){T++;try{t=await e(w[T%C]);break}catch{}}return t};let D;n.youtube&&n.youtube.clientId&&n.youtube.clientSecret&&n.youtube.refreshToken&&(D=new S(n.youtube.clientId,n.youtube.clientSecret,`https://developers.google.com/oauthplayground`),D.setCredentials({refresh_token:n.youtube.refreshToken}));const O=async({username:e,embed:t,filterShorts:n})=>{let a;e.startsWith(`@`)&&(a=await i.tryGet(`youtube:handle:${e}`,async()=>{let t=`https://www.youtube.com/${e}`,n=await r(t),a=d.load(n),o=JSON.parse(a(`script`).text().match(/ytInitialData = ({.*?});/)?.[1]||`{}`).metadata.channelMetadataRenderer,s=o.externalId,c=o.title,l=o.avatar?.thumbnails?.[0]?.url,u=o.description,f=(await K.getChannelWithId(s,`contentDetails`,i)).data.items[0].contentDetails.relatedPlaylists.uploads;return{channelName:c,image:l,description:u,playlistId:f}}));let c=await(async()=>{if(a?.playlistId){let e=a.playlistId;return K.getPlaylistWithShortsFilter(e,n)}else{let t=(await K.getChannelWithUsername(e,`contentDetails`,i)).data.items;if(!t)throw new s(`The channel https://www.youtube.com/user/${e} does not exist.`);let r=t[0].id;return n?K.getPlaylistWithShortsFilter(r,n):t[0].contentDetails.relatedPlaylists.uploads}})(),u=await K.getPlaylistItems(c,`snippet`,i);if(!u)throw new s(`This channel doesn't have any content.`);let f=u.data.items.map(e=>e.snippet.resourceId.videoId),p=await K.getVideos(f.join(`,`),`contentDetails`,i),m=await x(f);return{title:`${a?.channelName||e} - YouTube`,link:e.startsWith(`@`)?`https://www.youtube.com/${e}`:`https://www.youtube.com/user/${e}`,description:a?.description||`YouTube user ${e}`,image:a?.image,item:u.data.items.filter(e=>e.snippet.title!==`Private video`&&e.snippet.title!==`Deleted video`).map(e=>{let n=e.snippet,r=n.resourceId.videoId,i=K.getThumbnail(n.thumbnails),a=p?.data.items.find(e=>e.id===r),s=m[r]||[];return{title:n.title,description:K.renderDescription(t,r,i,K.formatDescription(n.description)),pubDate:o(n.publishedAt),link:`https://www.youtube.com/watch?v=${r}`,author:n.videoOwnerChannelTitle,image:i.url,attachments:[{url:U(r),mime_type:`text/html`,duration_in_seconds:a?.contentDetails.duration?l.duration(a.contentDetails.duration).asSeconds():void 0},...s]}})}},k=async({channelId:e,embed:t,filterShorts:n})=>{let r=n?null:(await K.getChannelWithId(e,`contentDetails`,i)).data.items[0].contentDetails.relatedPlaylists.uploads,a=n?K.getPlaylistWithShortsFilter(e):r,s=(await K.getPlaylistItems(a,`snippet`,i)).data.items,c=s.map(e=>e.snippet.resourceId.videoId),u=await K.getVideos(c.join(`,`),`contentDetails`,i),d=await x(c);return{title:`${s[0].snippet.channelTitle} - YouTube`,link:`https://www.youtube.com/channel/${e}`,description:`YouTube channel ${s[0].snippet.channelTitle}`,item:s.filter(e=>e.snippet.title!==`Private video`&&e.snippet.title!==`Deleted video`).map(e=>{let n=e.snippet,r=n.resourceId.videoId,i=K.getThumbnail(n.thumbnails),a=u?.data.items.find(e=>e.id===r),s=d[r]||[];return{title:n.title,description:K.renderDescription(t,r,i,K.formatDescription(n.description)),pubDate:o(n.publishedAt),link:`https://www.youtube.com/watch?v=${r}`,author:n.videoOwnerChannelTitle,image:i.url,attachments:[{url:U(r),mime_type:`text/html`,duration_in_seconds:a?.contentDetails.duration?l.duration(a.contentDetails.duration).asSeconds():void 0},...s]}})}},A=async({playlistId:e,embed:t})=>{let n=(await K.getPlaylist(e,`snippet`,i)).data.items[0].snippet.title,r=(await K.getPlaylistItems(e,`snippet`,i)).data.items.filter(e=>e.snippet.title!==`Private video`&&e.snippet.title!==`Deleted video`),a=r.map(e=>e.snippet.resourceId.videoId),s=await K.getVideos(a.join(`,`),`contentDetails`,i),c=await x(a);return{title:`${n} by ${r[0].snippet.channelTitle} - YouTube`,link:`https://www.youtube.com/playlist?list=${e}`,description:`${n} by ${r[0].snippet.channelTitle}`,item:r.map(e=>{let n=e.snippet,r=n.resourceId.videoId,i=K.getThumbnail(n.thumbnails),a=s?.data.items.find(e=>e.id===r),u=c[r]||[];return{title:n.title,description:K.renderDescription(t,r,i,K.formatDescription(n.description)),pubDate:o(n.publishedAt),link:`https://www.youtube.com/watch?v=${r}`,author:n.videoOwnerChannelTitle,image:i.url,attachments:[{url:U(r),mime_type:`text/html`,duration_in_seconds:a?.contentDetails.duration?l.duration(a.contentDetails.duration).asSeconds():void 0},...u]}})}};t();const j=(e,t,r)=>r.tryGet(`youtube:getPlaylistItems:${e}`,async()=>await E(n=>n.playlistItems.list({part:t,playlistId:e,maxResults:50})),n.cache.routeExpire,!1),M=(e,t,n)=>n.tryGet(`youtube:getPlaylist:${e}`,async()=>await E(n=>n.playlists.list({part:t,id:e}))),N=(e,t,n)=>n.tryGet(`youtube:getChannelWithId:${e}`,async()=>await E(n=>n.channels.list({part:t,id:e}))),P=(e,t,n)=>n.tryGet(`youtube:getChannelWithUsername:${e}`,async()=>await E(n=>n.channels.list({part:t,forUsername:e}))),F=(e,t,n)=>n.tryGet(`youtube:getVideos:${e}`,async()=>await E(n=>n.videos.list({part:t,id:e}))),I=e=>e.maxres||e.standard||e.high||e.medium||e.default,L=e=>e?.replaceAll(/\r\n|\r|\n/g,`<br>`),R=(t,n,r,i)=>a(c.join(e,`templates/description-e0f4b632.art`),{embed:t,videoId:n,img:r,description:i}),z=async(e,t)=>{let r=await t.get(`youtube:accessToken`,!1);return r||(r=(await D.getAccessToken()).token,await t.set(`youtube:accessToken`,r,3600)),D.setCredentials({access_token:r,refresh_token:n.youtube.refreshToken}),t.tryGet(`youtube:getSubscriptions`,()=>B(e),n.cache.routeExpire,!1)};async function B(e,t){let n=await p.youtube(`v3`).subscriptions.list({auth:D,part:e,mine:!0,maxResults:50,pageToken:t??void 0});if(n.data.nextPageToken){let t=await B(e,n.data.nextPageToken);t.data.items&&(n.data.items=[...n.data.items||[],...t.data.items])}return n}const V=e=>/^UC[\w-]{21}[AQgw]$/.test(e),H=(e,t)=>t.tryGet(`youtube:getLive:${e}`,async()=>await E(t=>t.search.list({part:`snippet`,channelId:e,eventType:`live`,type:`video`}))),U=e=>`https://www.youtube-nocookie.com/embed/${e}?controls=1&autoplay=1&mute=0`,W=(e,t=!0)=>t&&(e.startsWith(`UC`)||e.startsWith(`UU`))?`UULF`+e.slice(2):e,G=async({googleApi:e,youtubeiApi:t,params:r})=>{if(n.youtube?.key)try{return await e(r)}catch{return await t(r)}return await t(r)};var K={getPlaylistItems:j,getPlaylist:M,getChannelWithId:N,getChannelWithUsername:P,getVideos:F,getThumbnail:I,formatDescription:L,renderDescription:R,getSubscriptions:z,getSubscriptionsRecusive:B,isYouTubeChannelId:V,getLive:H,getVideoUrl:U,getPlaylistWithShortsFilter:W};export{G as callApi,k as getDataByChannelId,A as getDataByPlaylistId,O as getDataByUsername,x as getSrtAttachmentBatch,U as getVideoUrl,V as isYouTubeChannelId,R as renderDescription,K as utils_default};