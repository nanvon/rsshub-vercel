import{n as e,t}from"./esm-shims-mGm6WwCc.js";import"./config-DZMnNPig.js";import"./logger-asV68Lay.js";import"./ofetch-BASlBuka.js";import"./helpers-Cqaav28H.js";import{t as n}from"./cache-CpEhLexq.js";import{t as r}from"./render-d6AVTUl2.js";import{t as i}from"./parse-date-CHEO0z5G.js";import{t as a}from"./got-CgQXMNWI.js";import o from"node:path";import{load as s}from"cheerio";e();const c=`https://kemono.cr`,l=`${c}/api/v1`,u={m4a:`audio/mp4`,mp3:`audio/mpeg`,mp4:`video/mp4`},d={Accept:`text/css`},f={path:`/:source?/:id?/:type?`,categories:[`anime`],example:`/kemono`,parameters:{source:`Source, see below, Posts by default`,id:`User id, can be found in URL`,type:`Content type: announcements or fancards`},features:{requireConfig:!1,requirePuppeteer:!1,antiCrawler:!1,supportBT:!1,supportPodcast:!1,supportScihub:!1,nsfw:!0},radar:[{source:[`kemono.cr/`],target:``},{source:[`kemono.cr/:source/user/:id`],target:`/:source/:id`},{source:[`kemono.cr/:source/user/:id/announcements`],target:`/:source/:id/announcements`},{source:[`kemono.cr/:source/user/:id/fancards`],target:`/:source/:id/fancards`},{source:[`kemono.cr/discord/server/:id`],target:`/discord/:id`}],name:`Posts`,maintainers:[`nczitzk`,`AiraNadih`],handler:w,description:`Sources

| Posts | Patreon | Pixiv Fanbox | Gumroad | SubscribeStar | DLsite | Discord | Fantia |
| ----- | ------- | ------------ | ------- | ------------- | ------ | ------- | ------ |
| posts | patreon | fanbox       | gumroad | subscribestar | dlsite | discord | fantia |

::: tip
  When \`posts\` is selected as the value of the parameter **source**, the parameter **id** does not take effect.
  There is an optinal parameter **limit** which controls the number of posts to fetch, default value is 25.

  Support for announcements and fancards:
  - Use \`/:source/:id/announcements\` to get announcements
  - Use \`/:source/:id/fancards\` to get fancards
:::`};function p(e){if(typeof e!=`string`)return e;try{let t=JSON.parse(e);return typeof t==`string`&&(t=JSON.parse(t)),t}catch{return e}}function m(e,t,n){if(e===`posts`)return`${l}/posts`;if(e===`discord`&&t)return`${l}/discord/channel/lookup/${t}`;if(!t)throw Error(`User ID is required for non-posts sources`);let r=`${l}/${e}/user/${t}`;return n?`${r}/${n}`:`${r}/posts`}function h(e,t,n){if(e===`posts`)return`${c}/posts`;if(e===`discord`&&t)return`${c}/${e}/server/${t}`;if(!t)throw Error(`User ID is required for non-posts sources`);let r=`${c}/${e}/user/${t}`;return n?`${r}/${n}`:r}async function g(e,t){try{return(await a({method:`get`,url:`${l}/${e}/user/${t}/profile`,headers:d})).data.name||`Unknown User`}catch{return`Unknown User`}}function _(e){let t=[];if(e.file){let n=p(e.file);n&&typeof n==`object`&&`path`in n&&t.push({name:n.name||`Unnamed File`,path:n.path,extension:v(n.path)})}if(Array.isArray(e.attachments))for(let n of e.attachments){let e=p(n);e&&typeof e==`object`&&`path`in e&&t.push({name:e.name||`Unnamed Attachment`,path:e.path,extension:v(e.path)})}return t}function v(e){return e.replace(/.*\./,``).toLowerCase()}function y(e){let t=s(e),n={};return t(`audio source, video source`).each(function(){let e=t(this).attr(`src`);if(!e)return;let r=u[v(e)];if(r)return n={enclosure_url:new URL(e,c).toString(),enclosure_type:r},!1}),n}async function b(e,s){return(await Promise.all(e.map(e=>n.tryGet(`discord_${e.id}`,async()=>(await a({method:`get`,url:`${c}/api/v1/discord/channel/${e.id}?o=0`,headers:d})).data.filter(e=>e.content||e.attachments).toSorted((e,t)=>t.id.localeCompare(e.id)).slice(0,s).map(n=>({title:n.content||`Discord Message`,description:r(o.join(t,`templates/discord-b75b214c.art`),{i:n}),author:`${n.author.username}#${n.author.discriminator}`,pubDate:i(n.published),category:e.name,guid:`kemono:discord:${n.server}:${n.channel}:${n.id}`,link:`https://discord.com/channels/${n.server}/${n.channel}/${n.id}`})))))).flat()}function x(e,t,n,r,a){return e.slice(0,a).map(e=>({title:`Announcement from ${e.published?i(e.published).toDateString():`Unknown Date`}`,description:`<div>${e.content||``}</div>`,author:t,pubDate:i(e.published),guid:`kemono:${n}:${r}:announcement:${e.hash}`,link:`${c}/${n}/user/${r}/announcements`}))}function S(e,t,n,r,a){return e.slice(0,a).map(e=>{let a=`${e.server}${e.path}`;return{title:`Fancard ${e.id}`,description:`<img src="${a}" alt="Fancard ${e.id}" />`,author:t,pubDate:i(e.added),guid:`kemono:${n}:${r}:fancard:${e.id}`,link:a,enclosure_url:a,enclosure_type:e.mime}})}function C(e,n,a){return e.filter(e=>e.content||e.attachments).slice(0,a).map(e=>{let a=_(e),l={...e,files:a},u=r(o.join(t,`templates/source-7bbf197e.art`),{i:l}),d=e.content?`<div>${e.content}</div>`:``,f=s(d),p=s(u)(`img, a, audio, video`).toArray().map(e=>f(e).prop(`outerHTML`)),m=0,h=/downloads\.fanbox\.cc/;f(`a`).each(function(){let e=f(this).attr(`href`);e&&h.test(e)&&(f(this).replaceWith(p[m]||``),m++)}),d=(p[0]||``)+f.html();for(let e of p.slice(m+1))d+=e;return{title:e.title||`Untitled Post`,description:d,author:n,pubDate:i(e.published),guid:`kemono:${e.service}:${e.user}:post:${e.id}`,link:`${c}/${e.service}/user/${e.user}/post/${e.id}`,...y(d)}})}async function w(e){let t=e.req.query(`limit`)?Number.parseInt(e.req.query(`limit`)):25,n=e.req.param(`source`)||`posts`,r=e.req.param(`id`),i=e.req.param(`type`),o=n===`posts`,s=n===`discord`;try{let e=m(n,r,i),l=h(n,r,i),u=await a({method:`get`,url:e,headers:d}),f=o||s||!r?``:await g(n,r),p=o||s?`${c}/favicon.ico`:`https://img.kemono.cr/icons/${n}/${r}`,_,v;return s?(v=`Posts of ${r} from Discord | Kemono`,_=await b(u.data,t)):i===`announcements`?(v=`Announcements of ${f} from ${n} | Kemono`,_=x(u.data,f,n,r,t)):i===`fancards`?(v=`Fancards of ${f} from ${n} | Kemono`,_=S(u.data,f,n,r,t)):(v=o?`Kemono Posts`:`Posts of ${f} from ${n} | Kemono`,_=C(o?u.data.posts:u.data,f,t)),{title:v,image:p,link:l,item:_}}catch(e){throw Error(`Failed to fetch data from Kemono: ${e instanceof Error?e.message:`Unknown error`}`)}}export{f as route};