import{logger_default as e}from"./logger-BvonkID1.js";import{ofetch_default as t}from"./ofetch-rK3Yp7nj.js";import{cache_default as n}from"./cache-Dfid4xgQ.js";import{parseDate as r}from"./parse-date-DHsdom8D.js";import{load as i}from"cheerio";var a=class extends Error{constructor(e){super(e),this.name=`WeChatMpError`}};const o=[`@Rongronggg9`],s=(...e)=>`wechat-mp: ${e.join(`: `)}`,c=(...e)=>`${s(...e)}
Consider raise an issue (mentioning ${o.join(`, `)}) with the article URL for further investigation`;let l=(...t)=>e.warn(c(...t));const u=(...t)=>{let n=c(...t);throw e.error(n),new a(n)},d=(...t)=>{let n=s(...t);throw e.error(n),new a(n)};(()=>{let e=(...e)=>u(`WarningAsError`,...e),t=l;return n=>{l=n?e:t}})();const f=(()=>{let e=/\r|\\(r|x0d)/g,t=/\n|\\(n|x0a)/g;return(n,r=``,i=`<br>`)=>n.replaceAll(e,r).replaceAll(t,i)})(),p=(()=>{let e=/(&|\\x26)amp;/g;return t=>t.replaceAll(e,`&`)})();var m=class extends Error{constructor(){super(``),this.name=`LoopContinue`}},h=class extends Error{to_return;constructor(e){super(``),this.name=`LoopReturn`,this.to_return=e}};const g=(e,t,n=null,r=`script[nonce][type="text/javascript"]`)=>{let i=typeof e==`string`?[e]:e(r).toArray();for(let e of i)try{t(e)}catch(e){if(e instanceof h)return e.to_return;if(e instanceof m)continue;throw e}return n},_=Object.fromEntries(Object.entries({APP_MSG_PAGE:`0`,VIDEO_SHARE_PAGE:`5`,MUSIC_SHARE_PAGE:`6`,AUDIO_SHARE_PAGE:`7`,IMG_SHARE_PAGE:`8`,TEXT_SHARE_PAGE:`10`,SHORT_CONTENT_PAGE:`17`}).map(([e,t])=>[t,e]));var v=class{static genAssignmentRegExp=(e,t,n)=>RegExp(`\\b${e}\\s*${n}\\s*(?<quote>["'])(?<value>${t})\\k<quote>`,`mg`);static genExtractFunc=(e,{valuePattern:t=String.raw`\w+`,assignPattern:n=`=`,allowNotFound:r=!1,multiple:i=!1})=>{let a=this.genAssignmentRegExp(e,t,n);return e=>{let t=[];for(let n of e.matchAll(a)){let e=n.groups?.value;if(!i)return e;t.push(e)}if(!r&&t.length===0)throw new m;return i?t:null}};static doExtract=(e,t)=>{let n={};for(let[r,i]of Object.entries(e))n[r]=i(t);return n._extractedFrom=t,n};static commonMetadataToBeExtracted={showType:this.genExtractFunc(`item_show_type`,{valuePattern:String.raw`\d+`}),realShowType:this.genExtractFunc(`real_item_show_type`,{valuePattern:String.raw`\d+`}),createTime:this.genExtractFunc(`ct`,{valuePattern:String.raw`\d+`,allowNotFound:!0}),sourceUrl:this.genExtractFunc(`msg_source_url`,{valuePattern:`https?://[^'"]*`,allowNotFound:!0})};static common=e=>g(e,t=>{let n=e(t).text(),r=this.doExtract(this.commonMetadataToBeExtracted,n),i=_[r.showType],a=_[r.realShowType];throw r.sourceUrl=r.sourceUrl&&p(r.sourceUrl),i?r.showType=i:l(`showType not found`,`item_show_type=${r.showType}`),a?r.realShowType=a:l(`realShowType not found`,`real_item_show_type=${r.realShowType}`),r.showType!==r.realShowType&&l(`showType mismatch`,`item_show_type=${r.showType}, real_item_show_type=${r.realShowType}`),new h(r)},{},`script[nonce][type="text/javascript"]:contains("real_item_show_type")`);static audioMetadataToBeExtracted={voiceId:this.genExtractFunc(`voiceid`,{assignPattern:`:`}),duration:this.genExtractFunc(`duration`,{valuePattern:String.raw`\d*`,assignPattern:`:`,allowNotFound:!0})};static audio=e=>g(e,t=>{let n=e(t).text();throw new h(this.doExtract(this.audioMetadataToBeExtracted,n))},{},`script[nonce][type="text/javascript"]:contains("voiceid")`);static imgMetadataToBeExtracted={imgUrls:this.genExtractFunc(`cdn_url`,{valuePattern:`https?://[^'"]*`,assignPattern:`:`,multiple:!0})};static img=e=>g(e,t=>{let n=e(t).text(),r=this.doExtract(this.imgMetadataToBeExtracted,n);throw Array.isArray(r.imgUrls)&&(r.imgUrls=r.imgUrls.map(e=>p(e))),new h(r)},{},`script[nonce][type="text/javascript"]:contains("picture_page_info_list")`);static locationMetadataToBeExtracted={countryName:this.genExtractFunc(`countryName`,{valuePattern:`[^'"]*`,assignPattern:`:`}),provinceName:this.genExtractFunc(`provinceName`,{valuePattern:`[^'"]*`,assignPattern:`:`}),cityName:this.genExtractFunc(`cityName`,{valuePattern:`[^'"]*`,assignPattern:`:`})};static location=e=>g(e,t=>{let n=e(t).text();throw new h(this.doExtract(this.locationMetadataToBeExtracted,n))},{},`script[nonce][type="text/javascript"]:contains("countryName")`)};const y=(e,t,n)=>{t=e(t);let r=e(e(`<${n} />`)),i=t.attr();for(let e in i)r.attr(e,i[e]);r.append(t.contents()),t.replaceWith(r)},b=e=>e(`#js_content`).text()?e(`#js_content`).text().length<80?e(`#js_content a`).attr(`href`):null:e(`#js_share_source`).attr(`data-url`),x=e=>`https://res.wx.qq.com/voice/getvoice?mediaid=${e}`,S=(e,t)=>`<audio controls src="${e}" title="${t}" style="width:100%"/>`,C=e=>`https://v.qq.com/txp/iframe/player.html?${new URLSearchParams({origin:`https://mp.weixin.qq.com`,containerId:`js_tx_video_container_0.3863487104715233`,vid:e,width:`677`,height:`380.8125`,autoplay:`false`,allowFullScreen:`true`,chid:`17`,full:`true`,show1080p:`false`,isDebugIframe:`false`}).toString()}`,w=(e,t=!1)=>{let n=``;if(typeof e==`string`?n=e:e?.html&&(n=e.html()||``),!n)return``;let r=i(n,void 0,!1);return t||r(`img[data-src]`).each((e,t)=>{let n=r(t),i=n.attr(`data-src`);i&&(n.attr(`src`,i),n.removeAttr(`data-src`))}),r(`mpvoice[voice_encode_fileid]`).each((e,t)=>{let n=r(t),i=n.attr(`voice_encode_fileid`);if(i){let e=n.attr(`name`)||`Audio`;n.replaceWith(S(x(i),e))}}),r(`iframe.video_iframe[data-src]`).each((e,t)=>{let n=r(t),i=n.attr(`data-src`),a=new URL(i);if(a.host===`v.qq.com`&&a.searchParams.has(`vid`)){let e=C(a.searchParams.get(`vid`));n.attr(`src`,e),n.removeAttr(`data-src`);let t=n.attr(`data-w`),r=n.attr(`data-ratio`);if(t&&r){let e=Math.min(Number.parseInt(t),677);n.attr(`width`,e.toString()),n.attr(`height`,(e/Number.parseFloat(r)).toString())}}}),r(`section`).each((e,t)=>{let n=r(t),i=n.find(`p`).length,a=n.find(`div`).length,o=n.find(`section`).length;i+a+o===0?y(r,t,`p`):y(r,t,`div`)}),r(`code`).each((e,t)=>{r(`<br>`).insertAfter(t)}),r(`.code-snippet__line-index`).remove(),r(`script`).remove(),r.html()},T=(e,t=!1)=>{let n=e;e=p(e);let r=new URL(e);if(!t&&r.host!==`mp.weixin.qq.com`&&u(`URL host must be "mp.weixin.qq.com"`,e),r.protocol=`https:`,r.hash=``,r.pathname.startsWith(`/s/`))r.search=``;else if(r.pathname===`/s`){let e=r.searchParams.get(`__biz`),t=r.searchParams.get(`mid`)||r.searchParams.get(`appmsgid`),i=r.searchParams.get(`idx`)||r.searchParams.get(`itemidx`),a=r.searchParams.get(`sn`)||r.searchParams.get(`sign`);if(e&&t&&i&&a)r.search=`?__biz=${e}&mid=${t}&idx=${i}&sn=${a}`;else{let e=r.searchParams.get(`src`),t=r.searchParams.get(`timestamp`),i=r.searchParams.get(`ver`),a=r.searchParams.get(`signature`);e&&t&&i&&a?r.search=`?src=${e}&timestamp=${t}&ver=${i}&signature=${a}`:l(`unknown URL search parameters`,n)}}else l(`unknown URL path`,n);return r.href};var E=class e{static common=(e,t)=>{let n=f(e(`meta[property="og:title"]`).attr(`content`)||``,``,` `),i=f(e(`meta[name=author]`).attr(`content`)||``,``,` `),a=t.createTime?r(Number.parseInt(t.createTime)*1e3):void 0,o=e(`.wx_follow_nickname`).first().text()?.trim(),s=f(e(`meta[name=description]`).attr(`content`)||``),c=s;return s=s.replaceAll(`<br>`,` `)===n?``:s,{title:n,author:i,description:c,summary:s,pubDate:a,mpName:o}};static appMsg=async(n,r)=>{let a=e.common(n,r);a.description=w(n(`#js_content`));let o=b(n);if(o){let e=i(await t(T(o)));a.description+=w(e(`#js_content`))}return a};static img=(t,n)=>{let r=e.common(t,n),i=v.img(t)?.imgUrls,a=``;if(Array.isArray(i)&&i.length>0)for(let e of i)a+=`<br><br><img src="${e}" />`;return r.description+=a,r};static audio=(t,n)=>{let r=e.common(t,n),i=v.audio(t),a=x(i.voiceId);return r.enclosure_url=a,r.itunes_duration=i.duration,r.enclosure_type=`audio/mp3`,r.description+=`<br><br>`+S(a,r.title),r};static fallback=(t,n)=>{let r=e.common(t,n),i=t(`meta[property="og:image"]`).attr(`content`);return i&&(r.description+=`<br><br><img src="${i}" />`),r};static dispatch=async(t,n)=>{let r=i(t),a=v.common(r),o,s,c;switch(a.showType){case`APP_MSG_PAGE`:o=await e.appMsg(r,a);break;case`AUDIO_SHARE_PAGE`:o=e.audio(r,a);break;case`IMG_SHARE_PAGE`:o=e.img(r,a);break;case`VIDEO_SHARE_PAGE`:o=e.fallback(r,a);break;case void 0:return r(`script, style`).remove(),s=r(`title, body`).text().replaceAll(/\s+/g,` `).trim(),c=s.slice(0,25),s.length>=28&&(c=s.slice(0,25),c+=`...`),s.includes(`å·²è¢«å‘å¸ƒè€…åˆ é™¤`)?d(`deleted by author`,c,n):new URL(n).pathname.includes(`captcha`)||s.includes(`ç¯å¢ƒå¼‚å¸¸`)?d(`request blocked by WAF`,c,n):u(`unknown page, probably due to WAF`,c,n),{};default:l(`new showType, trying fallback method`,`showType=${a.showType}`,n),o=e.fallback(r,a)}let f=v.location(r),p=``;for(let e of[f.countryName,f.provinceName,f.cityName])e&&(p+=e+` `);return p=p.trim(),p&&(o.description+=`<p>ğŸ“å‘è¡¨äºï¼š${p}</p>`),a.sourceUrl&&(o.description+=`<p><a href="${a.sourceUrl}">ğŸ”—ï¸ é˜…è¯»åŸæ–‡</a></p>`),o}};const D=async(e,n=5)=>{n--;let r=await t.raw(e);return[301,302,303,307,308].includes(r.status)?(r.headers.has(`location`)?n<=0&&u(`too many redirects`,e):u(`redirect without location`,e),await D(r.headers.get(`location`),n)):r},O=(e,t=!1)=>(e=T(e,t),n.tryGet(e,async()=>{let t=await D(e);return{...await E.dispatch(t._data,t.url),link:e}})),k=async(e,t=!1,n=!1)=>{if(e.link){let r=await O(e.link);for(let i in r)switch(i){case`author`:e.author=t?r.mpName||e.author:r.author||e.author;break;case`link`:e.link=n?e.link:r.link||e.link;break;default:e[i]=e[i]||r[i]}}return e};export{O as fetchArticle,k as finishArticleItem,w as fixArticleContent};