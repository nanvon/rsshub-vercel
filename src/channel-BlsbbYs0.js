import{getClient as e,getDocument as t,getFilename as n,unwrapMedia as r}from"./client-0mAOgoAr.js";import{Api as i}from"telegram";import{getDisplayName as a}from"telegram/Utils.js";import{HTMLParser as o}from"telegram/extensions/html.js";function s(e){return`<a href="https://www.google.com/maps/search/?api=1&query=${e.lat}%2C${e.long}" target="_blank">Geo LatLon: ${e.lat}, ${e.long}</a>`}async function c(e,t,n){let r=await e.invoke(new i.messages.GetPollResults({peer:t.peerId,msgId:t.id})),a;return r?.updates[0]instanceof i.UpdateMessagePoll&&(a=r.updates[0].results),`<h4>${n.poll.quiz?`Quiz`:`Poll`}: ${n.poll.question.text}</h4>
        <div><ul>${n.poll.answers.map(e=>{let t=e.text.text,n=a.results?.find(t=>t.option.buffer===e.option.buffer);return n&&a.totalVoters&&(t=`<strong>${Math.round(n.voters/a.totalVoters*100)}%</strong>: ${t}`),`<li>${t}</li>`}).join(``)}</ul></div>
    `}function l(e,r){let a=t(r),o=a?a.mimeType:``;if(r instanceof i.MessageMediaPhoto||o.startsWith(`image/`))return`<img src="${e}" alt=""/>`;if(a&&o.startsWith(`video/`)){let t=a.attributes.find(e=>e instanceof i.DocumentAttributeVideo)??{w:1080,h:720};return`<video controls preload="metadata" poster="${e}?thumb" width="${t.w/2}" height="${t.h/2}"><source src="${e}" type="${o}"></video>`}if(a&&o.startsWith(`audio/`))return`<div>${d(r)}</div><div><audio src="${e}"></audio></div>`;if(a&&o.startsWith(`application/`)){let t=`${n(r)} (${u(a.size.valueOf())})`;return o.endsWith(`x-tgsticker`)&&(t=``),(a.thumbs?.length??0)>0&&(t=`<div><img src="${e}?thumb" alt=""/></div><div>${t}</div>`),`<a href="${e}" target="_blank">${t}</a>`}if((r instanceof i.MessageMediaGeo||r instanceof i.MessageMediaGeoLive)&&r.geo instanceof i.GeoPoint)return s(r.geo);if(r instanceof i.MessageMediaWebPage)return``;if(r instanceof i.MessageMediaContact)return`Contact: <a href="tel:${r.phoneNumber}" target="_blank">${r.firstName} ${r.lastName} ${r.phoneNumber}</a>`;if(r instanceof i.MessageMediaInvoice){let e=r.description;return r.photo?.url&&(e=`<img src="${r.photo?.url}" /><br />${e}`),`<h4>${r.test?`TEST `:``}Invoice: ${r.title}</h4><div>${e}</div>`}return r.className}function u(e){let t=e===0?0:Math.floor(Math.log(e)/Math.log(1024));return(e/Math.pow(1024,t)).toFixed(2)+` `+[`B`,`kB`,`MB`,`GB`,`TB`][t]}function d(e){if(e instanceof i.MessageMediaDocument&&e.document instanceof i.Document){let t=e.document.attributes.find(e=>e instanceof i.DocumentAttributeAudio);if(t)return`${t.performer} - ${t.title} (${f(t.duration)})`}return n(e)}function f(e){let t=Math.floor(e/3600),n=Math.floor(e%3600/60),r=e%60,i=String(n).padStart(2,`0`),a=String(r).padStart(2,`0`);return t>0?`${t}:${i}:${a}`:n>0?`${n}:${a}`:`0:${a}`}async function p(t){let n=await e(),s=t.req.param(`username`),u=await n.getInputEntity(s),d=await n.getEntity(u),f=[],p=await n.getMessages(u,{limit:50}),m=0,h=[];for(let e of p){let u=e.text;if(e.fwdFrom?.fromId){let t=await n.getEntity(e.fwdFrom.fromId);u=`Forwarded From: ${a(t)}: ${u}`}let g=await r(e.media,e.peerId);if(e.media instanceof i.MessageMediaStory&&g){let t=await n.getEntity(e.media.peer);u=`Story From: ${a(t)}: ${u}`}if(g){if(g instanceof i.MessageMediaPoll){f.push(await c(n,e,g));continue}let r=`${new URL(t.req.url).origin}/telegram/media/${s}/${e.id}`;f.push(l(r,g))}if(e.replyMarkup instanceof i.ReplyInlineMarkup)for(let t of e.replyMarkup.rows)for(let e of t.buttons)e instanceof i.KeyboardButtonUrl&&f.push(`<div><a href="${e.url}" target="_blank">${e.text}</a></div>`);if(u!==``||++m===p.length-1){let t=f.join(`<br/>
`);f=[],u&&(t+=`<p>${o.unparse(e.message,e.entities).replaceAll(`
`,`<br/>`)}</p>`);let n=e.text?e.text.slice(0,80)+(e.text.length>80?`...`:``):new Date(e.date*1e3).toUTCString();h.push({title:n,description:t,pubDate:new Date(e.date*1e3).toUTCString(),link:`https://t.me/s/${s}/${e.id}`,author:a(e.sender??d)})}}return{title:a(d),language:null,link:`https://t.me/${s}`,item:h,allowEmpty:t.req.param(`id`)===`allow_empty`,description:`@${s} on Telegram`}}export{s as getGeoLink,l as getMediaLink,p as handler};