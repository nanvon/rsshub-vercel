import{n as e,t}from"./esm-shims-mGm6WwCc.js";import{t as n}from"./config-DZMnNPig.js";import"./logger-asV68Lay.js";import"./ofetch-BASlBuka.js";import"./cache-CpEhLexq.js";import{t as r}from"./render-d6AVTUl2.js";import{t as i}from"./parse-date-CHEO0z5G.js";import{t as a}from"./invalid-parameter-CLGd_tte.js";import{t as o}from"./config-not-found-CX6cWM57.js";import{n as s}from"./readable-social-D1ub39Fn.js";import{a as c,n as l,o as u,t as d}from"./discord-api-CWYO3QnA.js";import f from"node:path";e();const p={path:`/search/:guildId/:routeParams`,categories:[`social-media`],example:`/discord/search/302094807046684672/content=friendly&has=image,video`,parameters:{guildId:`Guild ID`,routeParams:`Search parameters, support content, author_id, mentions, has, min_id, max_id, channel_id, pinned`},features:{requireConfig:[{name:`DISCORD_AUTHORIZATION`,description:`Discord authorization header`}],requirePuppeteer:!1,antiCrawler:!1,supportBT:!1,supportPodcast:!1,supportScihub:!1},name:`Guild Search`,maintainers:[`NekoAria`],handler:h},m=e=>{let t=new URLSearchParams(e),n=(t.get(`has`)?.split(`,`).filter(Boolean))?.filter(e=>d.has(e)),r={content:t.get(`content`)??void 0,author_id:t.get(`author_id`)??void 0,mentions:t.get(`mentions`)??void 0,has:n?.length?n:void 0,min_id:t.get(`min_id`)??void 0,max_id:t.get(`max_id`)??void 0,channel_id:t.get(`channel_id`)??void 0,pinned:t.has(`pinned`)?s(t.get(`pinned`)):void 0};return Object.fromEntries(Object.entries(r).filter(([,e])=>e!==void 0))};async function h(e){let{authorization:s}=n.discord||{};if(!s)throw new o(`Discord RSS is disabled due to the lack of authorization config`);let{guildId:d}=e.req.param(),p=m(e.req.param(`routeParams`));if(!Object.keys(p).length)throw new a(`At least one valid search parameter is required`);let[h,g]=await Promise.all([c(d,s),u(d,s,p)]);if(!g?.messages?.length)return{title:`Search Results - ${h.name}`,link:`${l}/channels/${d}`,item:[],allowEmpty:!0};let _=g.messages.flat().map(e=>({title:e.content.split(`
`)[0]||`(no content)`,description:r(f.join(t,`templates/message-311bc85b.art`),{message:e,guildInfo:h}),author:e.author.global_name??e.author.username,pubDate:i(e.timestamp),updated:e.edited_timestamp?i(e.edited_timestamp):void 0,category:[`#${e.channel_id}`],link:`${l}/channels/${d}/${e.channel_id}/${e.id}`}));return{title:`Search "${Object.entries(p).filter(([,e])=>e!==void 0).map(([e,t])=>`${e}:${Array.isArray(t)?t.join(`,`):t}`).join(` `)}" in ${h.name} - Discord`,link:`${l}/channels/${d}`,item:_,allowEmpty:!0}}export{p as route};