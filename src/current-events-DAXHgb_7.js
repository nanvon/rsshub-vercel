import"./esm-shims-BGJi2y--.js";import{config as e}from"./config-CVBRPN4O.js";import"./logger-BvonkID1.js";import"./ofetch-DqHh1IN2.js";import"./helpers-gUVC02jt.js";import{cache_default as t}from"./cache-Dfid4xgQ.js";import{parseDate as n}from"./parse-date-DHsdom8D.js";import{got_default as r}from"./got-VGofQtEf.js";function i(e){let t=[`January`,`February`,`March`,`April`,`May`,`June`,`July`,`August`,`September`,`October`,`November`,`December`],n=e.getFullYear(),r=t[e.getMonth()],i=e.getDate();return`Portal:Current_events/${n}_${r}_${i}`}function a(e){if(!e||typeof e!=`string`)return null;let t=e.match(/\{\{Current events\s*\|[\s\S]*?content\s*=\s*([\s\S]*?)\}\}/);return t?t[1].trim():null}function o(e){return e=e.replaceAll(/\[\[([^|\]]+)\|([^\]]+)\]\]/g,`<a href="https://en.wikipedia.org/wiki/$1">$2</a>`),e=e.replaceAll(/\[\[([^\]]+)\]\]/g,`<a href="https://en.wikipedia.org/wiki/$1">$1</a>`),e}function s(e){return e=e.replaceAll(/\[([^\s\]]+)\s+([^\]]+)\]/g,`<a href="$1">$2</a>`),e=e.replaceAll(/\[([^\s\]]+)\]/g,`<a href="$1">$1</a>`),e}function c(e){return e=e.replaceAll(/'''([^']+)'''/g,`<strong>$1</strong>`),e=e.replaceAll(/''([^']+)''/g,`<em>$1</em>`),e}function l(e){let t=e.split(`
`),n=[];for(let e of t){let t=e.trim();if(!t){n.push(`</p><p>`);continue}let r=t.match(/^(\*+)\s*(.+)$/);if(r){let e=r[1].length,t=r[2],i=`  `.repeat(e-1);n.push(`${i}<li>${t}</li>`)}else n.push(t)}let r=n.join(`
`);return r=u(r),d(r)}function u(e){return e.replaceAll(/(<li>.*?<\/li>(?:\s*<li>.*?<\/li>)*)/gs,e=>`<ul>\n${e}\n</ul>`)}function d(e){let t=e.split(`
`),n=[],r=0,i=[];for(let e of t){let t=e.trim();if(t.startsWith(`<li>`)){let a=e.match(/^(\s*)/)?.[1]?.length||0,o=Math.floor(a/2)+1;for(;r>o;)n.push(`  `.repeat(r-1)+`</ul>`),i.pop(),r--;r<o&&(n.push(`  `.repeat(o-1)+`<ul>`),i.push(`ul`),r=o),n.push(`  `.repeat(o)+t)}else{for(;r>0;)n.push(`  `.repeat(r-1)+`</ul>`),i.pop(),r--;t===`</p><p>`?n.push(`</p>
<p>`):t&&n.push(t)}}for(;r>0;)n.push(`  `.repeat(r-1)+`</ul>`),r--;return n.join(``)}function f(e){return e.replaceAll(/<!--[\s\S]*?-->/g,``)}function p(e){return e=e.replaceAll(/<\/p>\s*<p>/g,`</p>
<p>`),e=e.replaceAll(/<p>\s*<ul>/g,`<ul>`),e=e.replaceAll(/<\/ul>\s*<\/p>/g,`</ul>`),e=e.replaceAll(/<p>[\s\n\r]*<\/p>/g,``),e=e.replaceAll(/<p>\s*<\/p>/g,``),e=e.replaceAll(`<p></p>`,``),e=e.replaceAll(/<p>\s*$/g,``).replaceAll(/\s*<\/p>$/g,``),e}function m(e){let t=e;return t=o(t),t=s(t),t=c(t),t=l(t),t=p(t),t=f(t),t}async function h(t){let n=t.join(`|`),i={},o={},s=!0;for(;s;){let t={action:`query`,format:`json`,titles:n,prop:`revisions`,rvprop:`content`,rvslots:`main`,...o},c=await r(`https://en.wikipedia.org/w/api.php`,{searchParams:t,headers:{"User-Agent":e.trueUA}}),l=JSON.parse(c.body);if(l.query&&l.query.pages){for(let e of Object.values(l.query.pages))if(e.revisions&&e.revisions[0]&&e.revisions[0].slots&&e.revisions[0].slots.main){let t=e.revisions[0].slots.main[`*`],n=a(t);if(n){let t=m(n),r=e.title.replace(/Portal:Current events\/(\d{4}) (\w+) (\d+)/,`Portal:Current_events/$1_$2_$3`);i[r]=t}}}l.continue?o=l.continue:s=!1}return i}const g={path:`/current-events/:includeToday?`,categories:[`new-media`],example:`/wikipedia/current-events`,parameters:{includeToday:{description:`Include current day events (may be incomplete early in the day)`,default:`auto`,options:[{label:`Auto (include after 18:00 UTC)`,value:`auto`},{label:`Always include current day`,value:`always`},{label:`Never include current day`,value:`never`},{label:`Include after specific UTC hour (0-23)`,value:`0-23`}]}},features:{requireConfig:!1,requirePuppeteer:!1,antiCrawler:!1,supportBT:!1,supportPodcast:!1,supportScihub:!1},radar:[{source:[`en.wikipedia.org/wiki/Portal:Current_events`],target:`/wikipedia/current-events`}],name:`Current Events`,maintainers:[`aavanian`],handler:_,description:`Wikipedia Portal: Current events - Latest news and events from the past 7 days`};async function _(r){let a=r.req.param(`includeToday`)??`auto`,o=v(a),s=o.map(e=>i(e)),c=`wikipedia:current-events:batch:`+s.join(`|`);try{let r=await t.tryGet(c,async()=>await h(s),e.cache.contentExpire);return{title:`Wikipedia: Portal: Current events`,link:`https://en.wikipedia.org/wiki/Portal:Current_events`,description:`Current events from Wikipedia - Latest news and events`,item:o.map(e=>{let t=i(e),a=r[t];if(a){let r=e.toISOString().split(`T`)[0];return{title:`Current events: ${r}`,link:`https://en.wikipedia.org/wiki/${t}`,description:a,pubDate:n(e.toISOString()),guid:`wikipedia-current-events-${r}`}}return null}).filter(e=>e!==null)}}catch(e){let t=e instanceof Error?e.message:String(e);throw Error(`Failed to fetch Wikipedia current events: ${t}`)}}function v(e){let t=new Date().getUTCHours(),n=!1;switch(e){case`always`:n=!0;break;case`never`:n=!1;break;case`auto`:n=t>=18;break;default:if(/^\d+$/.test(e)){let r=Number.parseInt(e,10);r>=0&&r<=23&&(n=t>=r)}}let r=n?0:1;return Array.from({length:7},(e,t)=>{let n=new Date;return n.setDate(n.getDate()-(t+r)),n})}export{g as route};