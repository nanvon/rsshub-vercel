import{t as e}from"./config-DZMnNPig.js";import{t}from"./logger-asV68Lay.js";import{t as n}from"./got-CgQXMNWI.js";import r from"node:tls";import i from"ip-regex";async function a(e,r){try{let i=await n(r,{searchParams:{name:e,type:`A`},headers:{accept:`application/dns-json`}});if(i.data.Status===0)return i.data.Answer.map(e=>e.data);t.error(`Error ${i.data.Status} when querying DoH endpoint ${r}`)}catch(n){t.error(`Failed to resolve ${e}`),t.debug(n)}return[]}var o=n.extend({hooks:{beforeRequest:[async n=>{if(!e.pixiv.bypassCdn)return;let o=null;if(i({exact:!0}).test(e.pixiv.bypassCdnHostname))o=e.pixiv.bypassCdnHostname;else{let n=await a(e.pixiv.bypassCdnHostname,e.pixiv.bypassCdnDoh);n.length?o=n[Math.floor(n.length*Math.random())]:t.warn(`No IPv4 address resolved from ${e.pixiv.bypassCdnHostname}`)}if(o){let e=n.url.host;n.headers={...n.headers,host:e},n.url.hostname=o,n.checkServerIdentity=function(t,n){return r.checkServerIdentity(e,n)}}}]}});const s={"App-OS":`ios`,"App-OS-Version":`10.3.1`,"App-Version":`6.7.1`,"User-Agent":`PixivIOSApp/6.7.1 (iOS 10.3.1; iPhone8,1)`};let c=null;const l={client_id:`MOBrBDS8blbauoSck0ZfDbtuzpyT`,client_secret:`lsACyCD94FhDUtGTXi3QzcFE2uU1hqtDaKeqrdwj`,hash_secret:`28c1fdd170a5204386cb1313c7077b34f83e4aaf4aa829ce78c231e05b0bae2c`},u=t=>t(`pixiv:accessToken`,()=>o.post(`https://oauth.secure.pixiv.net/auth/token`,{form:{...l,get_secure_url:1,grant_type:`refresh_token`,refresh_token:e.pixiv.refreshToken},headers:{...s}}),3600,!1);async function d(e){let{data:n}=await u(e);return n&&n.access_token&&(t.debug(`Pixiv refresh token success.`),c=n.access_token),c}var f={getImgs(t){let n=[];if(t.meta_pages?.length)for(let r of t.meta_pages){let t=r.image_urls.original.replace(`https://i.pximg.net`,e.pixiv.imgProxy);n.push(`<p><img src="${t}" width="${r.width}" height="${r.height}" /></p>`)}else if(t.meta_single_page.original_image_url){let r=t.meta_single_page.original_image_url.replace(`https://i.pximg.net`,e.pixiv.imgProxy);n.push(`<p><img src="${r}" width="${t.width}" height="${t.height}" /></p>`)}return n},getProxiedImageUrl(t){return t.replace(`https://i.pximg.net`,e.pixiv.imgProxy||``)}};export{o as i,d as n,s as r,f as t};