import{n as e,t}from"./esm-shims-D4LgnpSl.mjs";import{t as n}from"./config-L8Ls2W7q.mjs";import{t as r}from"./ofetch-CvLG4YCQ.mjs";import{t as i}from"./cache-ZTWfXd2T.mjs";import{t as a}from"./render-CBhnapAf.mjs";import{t as o}from"./parse-date-bKmkZ9gg.mjs";import{t as s}from"./not-found-CKBbeCyA.mjs";import c from"node:path";import l from"dayjs";import u from"dayjs/plugin/duration.js";import*as d from"cheerio";import f from"p-map";import{google as p}from"googleapis";import{getSubtitles as m}from"youtube-caption-extractor";function h(e,t=2){return String(e).padStart(t,`0`)}function g(e){let t=Math.floor(e*1e3),n=Math.floor(t/36e5),r=Math.floor(t%36e5/6e4),i=Math.floor(t%6e4/1e3),a=t%1e3;return`${h(n)}:${h(r)}:${h(i)},${h(a,3)}`}function _(e){return e.map((e,t)=>{let n=Number.parseFloat(e.start),r=n+Number.parseFloat(e.dur);return`${t+1}
${g(n)} --> ${g(r)}
${e.text}
`}).join(`
`)}const v=e=>i.tryGet(`youtube:getSubtitlesByVideoId:${e}`,async()=>{try{return _(await m({videoID:e}))}catch{return``}}),y=e=>`data:text/plain;charset=utf-8,${encodeURIComponent(e)}`;function b(e){return!e||e.trim()===``?[]:[{url:y(e),mime_type:`text/srt`,title:`Subtitles`}]}const x=async e=>{let t=await f(e,async e=>({videoId:e,srt:b(await v(e))}),{concurrency:5});return Object.fromEntries(t.map(({videoId:e,srt:t})=>[e,t]))},{OAuth2:S}=p.auth;l.extend(u);let C=0;const w={};if(n.youtube&&n.youtube.key){let e=n.youtube.key.split(`,`);for(let[t,n]of e.entries())n&&(w[t]=p.youtube({version:`v3`,auth:n}),C=t+1)}let T=-1;const E=async e=>{let t;for(let n=0;n<C;n++){T++;try{t=await e(w[T%C]);break}catch{}}return t};let D;n.youtube&&n.youtube.clientId&&n.youtube.clientSecret&&n.youtube.refreshToken&&(D=new S(n.youtube.clientId,n.youtube.clientSecret,`https://developers.google.com/oauthplayground`),D.setCredentials({refresh_token:n.youtube.refreshToken}));const O=async({username:e,embed:t,filterShorts:n,isJsonFeed:a})=>{let c;e.startsWith(`@`)&&(c=await i.tryGet(`youtube:handle:${e}`,async()=>{let t=await r(`https://www.youtube.com/${e}`),n=d.load(t),a=JSON.parse(n(`script`).text().match(/ytInitialData = ({.*?});/)?.[1]||`{}`).metadata.channelMetadataRenderer,o=a.externalId;return{channelName:a.title,image:a.avatar?.thumbnails?.[0]?.url,description:a.description,playlistId:(await K.getChannelWithId(o,`contentDetails`,i)).data.items[0].contentDetails.relatedPlaylists.uploads}}));let u=await(async()=>{if(c?.playlistId){let e=c.playlistId;return K.getPlaylistWithShortsFilter(e,n)}else{let t=(await K.getChannelWithUsername(e,`contentDetails`,i)).data.items;if(!t)throw new s(`The channel https://www.youtube.com/user/${e} does not exist.`);let r=t[0].id;return n?K.getPlaylistWithShortsFilter(r,n):t[0].contentDetails.relatedPlaylists.uploads}})(),f=await K.getPlaylistItems(u,`snippet`,i);if(!f)throw new s(`This channel doesn't have any content.`);let p=f.data.items.map(e=>e.snippet.resourceId.videoId),m=await K.getVideos(p.join(`,`),`contentDetails`,i),h=a?await x(p):{};return{title:`${c?.channelName||e} - YouTube`,link:e.startsWith(`@`)?`https://www.youtube.com/${e}`:`https://www.youtube.com/user/${e}`,description:c?.description||`YouTube user ${e}`,image:c?.image,item:f.data.items.filter(e=>e.snippet.title!==`Private video`&&e.snippet.title!==`Deleted video`).map(e=>{let n=e.snippet,r=n.resourceId.videoId,i=K.getThumbnail(n.thumbnails),a=m?.data.items.find(e=>e.id===r),s=h&&h[r]||[];return{title:n.title,description:K.renderDescription(t,r,i,K.formatDescription(n.description)),pubDate:o(n.publishedAt),link:`https://www.youtube.com/watch?v=${r}`,author:n.videoOwnerChannelTitle,image:i.url,attachments:[{url:U(r),mime_type:`text/html`,duration_in_seconds:a?.contentDetails.duration?l.duration(a.contentDetails.duration).asSeconds():void 0},...s]}})}},k=async({channelId:e,embed:t,filterShorts:n,isJsonFeed:r})=>{let a=n?null:(await K.getChannelWithId(e,`contentDetails`,i)).data.items[0].contentDetails.relatedPlaylists.uploads,s=n?K.getPlaylistWithShortsFilter(e):a,c=(await K.getPlaylistItems(s,`snippet`,i)).data.items,u=c.map(e=>e.snippet.resourceId.videoId),d=await K.getVideos(u.join(`,`),`contentDetails`,i),f=r?await x(u):{};return{title:`${c[0].snippet.channelTitle} - YouTube`,link:`https://www.youtube.com/channel/${e}`,description:`YouTube channel ${c[0].snippet.channelTitle}`,item:c.filter(e=>e.snippet.title!==`Private video`&&e.snippet.title!==`Deleted video`).map(e=>{let n=e.snippet,r=n.resourceId.videoId,i=K.getThumbnail(n.thumbnails),a=d?.data.items.find(e=>e.id===r),s=f&&f[r]||[];return{title:n.title,description:K.renderDescription(t,r,i,K.formatDescription(n.description)),pubDate:o(n.publishedAt),link:`https://www.youtube.com/watch?v=${r}`,author:n.videoOwnerChannelTitle,image:i.url,attachments:[{url:U(r),mime_type:`text/html`,duration_in_seconds:a?.contentDetails.duration?l.duration(a.contentDetails.duration).asSeconds():void 0},...s]}})}},A=async({playlistId:e,embed:t,isJsonFeed:n})=>{let r=(await K.getPlaylist(e,`snippet`,i)).data.items[0].snippet.title,a=(await K.getPlaylistItems(e,`snippet`,i)).data.items.filter(e=>e.snippet.title!==`Private video`&&e.snippet.title!==`Deleted video`),s=a.map(e=>e.snippet.resourceId.videoId),c=await K.getVideos(s.join(`,`),`contentDetails`,i),u=n?await x(s):{};return{title:`${r} by ${a[0].snippet.channelTitle} - YouTube`,link:`https://www.youtube.com/playlist?list=${e}`,description:`${r} by ${a[0].snippet.channelTitle}`,item:a.map(e=>{let n=e.snippet,r=n.resourceId.videoId,i=K.getThumbnail(n.thumbnails),a=c?.data.items.find(e=>e.id===r),s=u&&u[r]||[];return{title:n.title,description:K.renderDescription(t,r,i,K.formatDescription(n.description)),pubDate:o(n.publishedAt),link:`https://www.youtube.com/watch?v=${r}`,author:n.videoOwnerChannelTitle,image:i.url,attachments:[{url:U(r),mime_type:`text/html`,duration_in_seconds:a?.contentDetails.duration?l.duration(a.contentDetails.duration).asSeconds():void 0},...s]}})}};e();const j=(e,t,r)=>r.tryGet(`youtube:getPlaylistItems:${e}`,async()=>await E(n=>n.playlistItems.list({part:t,playlistId:e,maxResults:50})),n.cache.routeExpire,!1),M=(e,t,n)=>n.tryGet(`youtube:getPlaylist:${e}`,async()=>await E(n=>n.playlists.list({part:t,id:e}))),N=(e,t,n)=>n.tryGet(`youtube:getChannelWithId:${e}`,async()=>await E(n=>n.channels.list({part:t,id:e}))),P=(e,t,n)=>n.tryGet(`youtube:getChannelWithUsername:${e}`,async()=>await E(n=>n.channels.list({part:t,forUsername:e}))),F=(e,t,n)=>n.tryGet(`youtube:getVideos:${e}`,async()=>await E(n=>n.videos.list({part:t,id:e}))),I=e=>e.maxres||e.standard||e.high||e.medium||e.default,L=e=>e?.replaceAll(/\r\n|\r|\n/g,`<br>`),R=(e,n,r,i)=>a(c.join(t,`templates/description-d8937611.art`),{embed:e,videoId:n,img:r,description:i}),z=async(e,t)=>{let r=await t.get(`youtube:accessToken`,!1);return r||(r=(await D.getAccessToken()).token,await t.set(`youtube:accessToken`,r,3600)),D.setCredentials({access_token:r,refresh_token:n.youtube.refreshToken}),t.tryGet(`youtube:getSubscriptions`,()=>B(e),n.cache.routeExpire,!1)};async function B(e,t){let n=await p.youtube(`v3`).subscriptions.list({auth:D,part:e,mine:!0,maxResults:50,pageToken:t??void 0});if(n.data.nextPageToken){let t=await B(e,n.data.nextPageToken);t.data.items&&(n.data.items=[...n.data.items||[],...t.data.items])}return n}const V=e=>/^UC[\w-]{21}[AQgw]$/.test(e),H=(e,t)=>t.tryGet(`youtube:getLive:${e}`,async()=>await E(t=>t.search.list({part:`snippet`,channelId:e,eventType:`live`,type:`video`}))),U=e=>`https://www.youtube-nocookie.com/embed/${e}?controls=1&autoplay=1&mute=0`,W=(e,t=!0)=>t&&(e.startsWith(`UC`)||e.startsWith(`UU`))?`UULF`+e.slice(2):e,G=async({googleApi:e,youtubeiApi:t,params:r})=>{if(n.youtube?.key)try{return await e(r)}catch{return await t(r)}return await t(r)};var K={getPlaylistItems:j,getPlaylist:M,getChannelWithId:N,getChannelWithUsername:P,getVideos:F,getThumbnail:I,formatDescription:L,renderDescription:R,getSubscriptions:z,getSubscriptionsRecusive:B,isYouTubeChannelId:V,getLive:H,getVideoUrl:U,getPlaylistWithShortsFilter:W};export{K as a,O as c,R as i,x as l,U as n,k as o,V as r,A as s,G as t};