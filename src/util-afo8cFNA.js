import{n as e,t}from"./esm-shims-CaZMYoY8.js";import{t as n}from"./config-DZMnNPig.js";import{t as r}from"./ofetch-VsB2Peor.js";import{t as i}from"./render-d6AVTUl2.js";import{t as a}from"./parse-date-CHEO0z5G.js";import{t as o}from"./got-BVCqvF6m.js";import{t as s}from"./config-not-found-CX6cWM57.js";import c from"node:path";import{load as l}from"cheerio";e();const u=`https://nhentai.net`,d=async(e,t,n)=>{let r=`https://nhentai.net/login/`,i=`nhentai:cookie`,a=await n.get(i);if(a){let{cookie:e,time:t}=JSON.parse(a);if(Date.now()-t<86400*3*1e3)return e}let{data:s,headers:c}=await o(r),l=s.match(/name="csrfmiddlewaretoken" value="(.*?)"/)[1],u=c[`set-cookie`].map(e=>e.split(`;`)[0]).join(`; `),d=await o.post(r,{headers:{referer:r,cookie:u},form:{csrfmiddlewaretoken:l,username_or_email:e,password:t,next:``},followRedirect:!1});if(d.statusCode!==302)return n.set(i,JSON.stringify({cookie:``,time:Date.now()})),``;let f=d.headers[`set-cookie`].map(e=>e.split(`;`)[0]).join(`; `);return n.set(i,JSON.stringify({cookie:f,time:Date.now()})),f},f=(e,...t)=>r(e,{...t,headers:{host:`nhentai.net`}}),p=async e=>{let t=l(await f(e));return t(`.gallery a.cover`).toArray().map(e=>_(t(e)))},m=(e,t,n)=>Promise.all(t.slice(0,n).map(t=>e.tryGet(t.link,()=>y(t)))),h=async(e,t,r)=>{if(!n.nhentai||!n.nhentai.username||!n.nhentai.password)throw new s(`nhentai RSS with torrents is disabled due to the lack of <a href="https://docs.rsshub.app/deploy/config#route-specific-configurations">relevant config</a>`);let i=await d(n.nhentai.username,n.nhentai.password,e);if(!i)throw new s(`Invalid username (or email) or password for nhentai torrent download`);return g(e,t,i,r)},g=(e,t,n,r)=>Promise.all(t.slice(0,r).map(t=>e.tryGet(t.link+`download`,()=>v(t,n)))),_=e=>{let t=new URL(e.attr(`href`),u).href,n=e.children(`img`),r=(n.attr(`data-src`)||n.attr(`src`)).replace(`thumb`,`1`).replace(/t(\d+)\.nhentai\.net/,`i$1.nhentai.net`).replace(`.webp.webp`,`.webp`);return{title:e.children(`.caption`).text(),link:t,description:`<img src="${r}">`}},v=async(e,t)=>{let{link:n}=e,r=await f(n+`download`,{followRedirect:!1,responseType:`buffer`,headers:{Cookie:t}});return{...e,enclosure_url:r,enclosure_type:`application/x-bittorrent`}},y=async e=>{let{link:n}=e,r=l(await f(n)),o=r(`.gallerythumb img`).toArray().map(e=>new URL(r(e).attr(`data-src`),u).href).map(e=>e.replace(/(.+)(\d+)t\.(.+)/,(e,t,n,r)=>`${t}${n}.${r}`)).map(e=>e.replace(/t(\d+)\.nhentai\.net/,`i$1.nhentai.net`)).map(e=>e.replace(/\.(jpg|png|gif)\.webp$/,`.$1`)).map(e=>e.replace(/\.webp\.webp$/,`.webp`));return{...e,title:r(`div#info > h2`).text()||r(`div#info > h1`).text(),pubDate:a(r(`time`).attr(`datetime`)),description:i(c.join(t,`templates/desc-9360b66a.art`),{length:o.length,images:o})}};export{p as n,h as r,m as t};